<index.html>
    <html lang="pt-BR">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Lançamento de Corridas</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

            body {
                font-family: 'Inter', sans-serif;
                background-color: #f3f4f6;
            }

            .error-border {
                border-color: #ef4444 !important;
            }

            /* Style for table rows to show pointer */
            tr {
                cursor: pointer;
            }

            /* Make sure modals fit on smaller screens */
            .modal-content {
                width: 95%;
                max-width: 48rem;
                /* Equivalent to max-w-2xl */
            }

            @media (min-width: 640px) {
                .modal-content {
                    width: 100%;
                }
            }

            /* Custom style for larger modal */
            .modal-lg {
                max-width: 80rem;
                /* max-w-6xl */
            }

            /* Custom style to align form elements */
            .form-row-align {
                display: flex;
                align-items: flex-end;
                gap: 0.5rem;
            }

            .form-row-align .flex-grow {
                min-width: 0;
                /* Allow flex item to shrink */
            }

            /* ESTILOS PARA A CAIXA DE AUTOCOMPLETAR */
            .autocomplete-items {
                position: absolute;
                border: 1px solid #d1d5db;
                border-bottom: none;
                border-top: none;
                z-index: 99;
                top: 100%;
                left: 0;
                right: 0;
                background-color: #ffffff;
                border-radius: 0 0 0.5rem 0.5rem;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                max-height: 200px;
                overflow-y: auto;
            }

            .autocomplete-items div {
                padding: 0.75rem;
                cursor: pointer;
                border-bottom: 1px solid #e5e7eb;
            }

            .autocomplete-items div:hover {
                background-color: #e5e7eb;
            }

            .autocomplete-active {
                background-color: #3b82f6 !important;
                color: #ffffff;
            }
        </style>
    </head>

    <body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">
        <div id="login-page"
            class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200 hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6 md:mb-8">Login</h1>
            <form id="login-form" class="space-y-4">

                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuário:</label>
                    <input type="text" id="username" name="username"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">

                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha:</label>
                    <input type="password" id="password" name="password"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <button type="submit"
                    class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Entrar
                </button>
                <p id="login-message" class="text-red-500 text-sm text-center mt-2 hidden">Usuário ou senha inválidos.
                </p>

            </form>
        </div>

        <div id="app-page"
            class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-full md:max-w-5xl border border-gray-200 hidden">
            <div class="flex justify-between items-center mb-6 relative">
                <div class="flex-grow flex justify-center">

                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Lançamento de Corridas</h1>
                </div>
                <button id="logout-btn"
                    class="absolute top-0 right-0 px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400">Sair</button>
                <button id="open-change-password-btn"
                    class="absolute top-12 right-1 text-sm text-blue-600 hover:text-blue-800 hover:underline font-medium">
                    Alterar Senha
                </button>
            </div>

            <p id="user-id-display" class="text-sm text-transparent text-center mb-4"></p>

            <form id="form-corrida" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="motorista" class="block text-sm font-medium text-gray-700">Motorista:</label>
                        <input type="text" id="motorista" name="motorista" list="motoristas-list"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                        <datalist id="motoristas-list">
                        </datalist>
                    </div>
                </div>

                <div id="solicitante-campos-container" class="space-y-4">

                </div>

                <div class="md:col-span-2 flex justify-center md:justify-start">
                    <button type="button" id="add-solicitante-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Solicitante
                    </button>
                </div>


                <div id="passageiros-campos-container" class="md:col-span-2 grid grid-cols-1 gap-4 md:gap-6">
                    <input type="hidden" id="re" name="re">
                    <input type="hidden" id="transportado" name="transportado">
                </div>


                <div class="md:col-span-2 flex justify-center">
                    <button type="button" id="add-passageiro-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Passageiro
                    </button>

                </div>

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="data" class="block text-sm font-medium text-gray-700">Data:</label>
                        <input type="date" id="data" name="data" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="bordero" class="block text-sm font-medium text-gray-700">Nº Borderô:</label>
                        <input type="text" id="bordero" name="bordero"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
                <div id="origem-campos-container-wrapper" class="md:col-span-1 space-y-4">
                    <div id="origem-campos-container">
                    </div>
                    <div class="flex justify-center md:justify-start gap-2">
                        <button type="button" id="add-origem-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">
                            + Adicionar Outra Origem
                        </button>
                        <button type="button" id="fill-partidas-btn"
                            class="w-full md:w-auto px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg hover:bg-blue-200">
                            Preencher Partidas
                        </button>
                    </div>
                </div>

                <div id="destino-campos-container-wrapper" class="md:col-span-1 space-y-4">
                    <div id="destino-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                    </div>
                    <div class="flex justify-center md:justify-start gap-2">
                        <button type="button" id="add-destino-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">
                            + Adicionar Outro Destino
                        </button>
                        <button type="button" id="fill-chegadas-btn"
                            class="w-full md:w-auto px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg hover:bg-blue-200">
                            Preencher Chegadas
                        </button>
                    </div>
                </div>

                <div id="valor-campos-container-wrapper" class="md:col-span-2 space-y-4">
                    <div id="valor-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                    </div>
                    <div class="flex justify-center md:justify-start">
                        <button type="button" id="add-valor-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Valor
                        </button>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label for="observacao" class="block text-sm font-medium text-gray-700">Observação:</label>
                    <textarea id="observacao" name="observacao" rows="4"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
                </div>

                <div class="md:col-span-2 flex justify-center mt-4">
                    <button type="submit"
                        class="w-full md:w-1/2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Salvar Lançamento
                    </button>
                </div>
            </form>


            <hr class="my-6 md:my-8 border-gray-300">

            <div id="csv-report-section" class="flex flex-col gap-4 mb-6 hidden">
                <h2 class="text-xl font-bold text-gray-800">Gerar Relatório CSV</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início:</label>
                        <input type="date" id="start-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim:</label>
                        <input type="date" id="end-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <button type="button" id="download-csv-detailed"
                        class="flex-1 px-6 py-3 bg-cyan-500 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-600 focus:outline-none focus:ring-4 focus:ring-cyan-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Gerar Relatório Completo
                    </button>
                </div>
                <p id="csv-progress" class="text-center text-sm text-gray-600 mt-4 hidden"></p>
            </div>

            <hr class="my-6 md:my-8 border-gray-300">

            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button type="button" id="open-lancamentos-modal"
                    class="px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Gerenciar Lançamentos
                </button>

                <button type="button" id="open-transportados-modal"
                    class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Gerenciar Transportados
                </button>
                <button type="button" id="open-motoristas-modal"
                    class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out hidden">
                    Gerenciar Motoristas
                </button>
            </div>
        </div>

        <div id="transportados-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">

            <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Transportados</h2>
                    
                <div class="flex items-center gap-4">
                        
                        <button id="refresh-transportados-btn" title="Atualizar Lista" 
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline">
                            Atualizar
                        </button>
                        
                        <button id="close-transportados-modal"
                            class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                    <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                    <select id="sort-transportados-key"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="nome">Nome</option>
                        <option value="re">RE</option>
                    </select>
                    <select id="sort-transportados-order"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="asc">A-Z</option>
                        <option value="desc">Z-A</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="new-re" class="block text-sm font-medium text-gray-700">Novo RE:</label>
                        <input type="text" id="new-re"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-nome" class="block text-sm font-medium text-gray-700">Novo Transportado:</label>
                        <input type="text" id="new-nome"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="button" id="add-transportado"
                        class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Adicionar
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full table-auto" id="transportados-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    RE</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/4">
                                    Nome</th>
                                <th scope="col"
                                    class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                </div>
        </div>

        <div id="motoristas-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Motoristas</h2>
                    <button id="close-motoristas-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                    <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                    <select id="sort-motoristas-order"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="asc">A-Z</option>
                        <option value="desc">Z-A</option>
                    </select>
                </div>

                <div class="border-t border-b border-gray-200 py-6 my-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Adicionar Novo Motorista/Usuário</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="new-motorista-nome" class="block text-sm font-medium text-gray-700">Nome do
                                Motorista:</label>
                            <input type="text" id="new-motorista-nome"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-motorista-username" class="block text-sm font-medium text-gray-700">Usuário
                                (login):</label>
                            <input type="text" id="new-motorista-username"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-motorista-password"
                                class="block text-sm font-medium text-gray-700">Senha:</label>
                            <input type="password" id="new-motorista-password"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-end">
                            <div class="flex items-center h-full">
                                <input type="checkbox" id="new-motorista-is-admin"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                                <label for="new-motorista-is-admin" class="ml-2 block text-sm text-gray-900">É
                                    Administrador?</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="add-motorista"
                            class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700">
                            Adicionar Motorista
                        </button>
                    </div>
                </div>


                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full table-auto" id="motoristas-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllMotoristas" class="rounded-sm">
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-full">
                                    Nome</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-4">
                    <button type="button" id="delete-selected-motoristas"
                        class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700">
                        Excluir Selecionados
                    </button>
                </div>
            </div>
        </div>

        <div id="lancamentos-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content modal-lg max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 relative">
                    <div class="flex-grow flex justify-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Lançamentos</h2>
                    </div>
                    <button id="close-lancamentos-modal"
                        class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="filter-date" class="block text-sm font-medium text-gray-700">Filtrar por
                            Data:</label>
                        <input type="date" id="filter-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>

                        <div id="motorista-filter-wrapper" class="hidden"> <label for="filter-motorista" class="block text-sm font-medium text-gray-700">Filtrar por
                            Motorista:</label>
                        <select id="filter-motorista"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                            <option value="">Todos os Motoristas</option>
                            </select>
                    </div>
                    <div class="flex items-end">
                        <button id="filter-lancamentos-btn"
                            class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Buscar
                            Lançamentos</button>
                    </div>
                </div>

                <div class="overflow-y-auto flex-grow">
                    <table class="min-w-full table-auto" id="lancamentos-table">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Data</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Motorista</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nº Borderô</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Solicitante(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Transportado(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Origem</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Destino(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Partida</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor Extra Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Observação</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="edit-lancamento-modal"
            class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 relative">
                    <div class="flex-grow flex justify-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Editar Lançamento</h2>
                    </div>
                    <button id="close-edit-lancamento-modal"
                        class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>

                <form id="edit-lancamento-form" class="space-y-4">
                    <input type="hidden" id="edit-lancamento-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-motorista"
                                class="block text-sm font-medium text-gray-700">Motorista:</label>
                            <input type="text" id="edit-motorista" list="motoristas-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="edit-data" class="block text-sm font-medium text-gray-700">Data:</label>
                            <input type="date" id="edit-data"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-bordero" class="block text-sm font-medium text-gray-700">Nº
                                Borderô:</label>
                            <input type="text" id="edit-bordero"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div></div>
                        <div id="edit-solicitante-campos-container" class="space-y-4">
                        </div>
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-solicitante-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Solicitante
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-re" class="block text-sm font-medium text-gray-700">RE
                                (P1):</label>
                            <input type="text" id="edit-re" name="edit-res[]" list="transportados-re-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="edit-transportado" class="block text-sm font-medium text-gray-700">Transportado
                                (P1):</label>
                            <input type="text" id="edit-transportado" name="edit-transportados[]"
                                list="transportados-nome-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div id="edit-passageiros-extras-container" class="space-y-4 grid grid-cols-1 gap-4">
                    </div>

                    <div>
                        <button type="button" id="add-edit-passageiro-btn"
                            class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Passageiro
                        </button>
                    </div>

                    <div id="edit-origem-campos-container" class="space-y-4">
                    </div>
                    <div class="flex justify-center md:justify-start">
                        <button type="button" id="add-edit-origem-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outra Origem
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="edit-destino-campos-container" class="md:col-span-2 space-y-4">
                        </div>
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-destino-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Destino
                        </button>
                    </div>

                    <div id="edit-valor-campos-container" class="md:col-span-2 space-y-4">
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-valor-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Valor
                        </button>
                    </div>

                    <div>
                        <label for="edit-observacao" class="block text-sm font-medium text-gray-700">Observação:</label>
                        <textarea id="edit-observacao" rows="3"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-edit-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar
                            Alterações</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center"
            style="z-index: 60;">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Aviso</h2>
                <p id="message-content" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end">
                    <button id="close-modal"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
                </div>
            </div>
        </div>

        <div id="change-password-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Alterar Minha Senha</h2>
                    <button id="close-change-password-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-700">Senha
                            Atual:</label>
                        <input type="password" id="current-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha:</label>
                        <input type="password" id="new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirmar Nova
                            Senha:</label>
                        <input type="password" id="confirm-new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="change-password-message" class="text-red-500 text-sm text-center hidden"></p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-change-password-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova
                            Senha</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="reset-password-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Redefinir Senha</h2>
                    <button id="close-reset-password-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <p class="mb-4">Redefinindo senha para o usuário: <strong id="reset-username-display"></strong></p>
                <form id="reset-password-form" class="space-y-4">
                    <input type="hidden" id="reset-user-id">
                    <div>
                        <label for="admin-new-password" class="block text-sm font-medium text-gray-700">Digite a Nova
                            Senha:</label>
                        <input type="password" id="admin-new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="reset-password-message" class="text-red-500 text-sm text-center hidden"></p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-reset-password-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova
                            Senha</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="autocomplete-suggestions-container"></div>

        <datalist id="locais-list">
            <option value="Aeroporto de Guarulhos (GRU)"></option>
            <option value="Aldeias da Serra"></option>
            <option value="Altos da Borda"></option>
            <option value="Bairro Grama"></option>
            <option value="Boa Vista"></option>
            <option value="Borda da Mata"></option>
            <option value="Borda do Campo"></option>
            <option value="Caçapava"></option>
            <option value="Caçapava Velha"></option>
            <option value="Centro - Caçapava"></option>
            <option value="Centro - SJC"></option>
            <option value="Centro - Taubaté"></option>
            <option value="Chacara Bela Vista"></option>
            <option value="Chacara Ipes"></option>
            <option value="Chacara Santo Antonio"></option>
            <option value="Eldorado"></option>
            <option value="Germana"></option>
            <option value="Guaramirim"></option>
            <option value="Jardim Amalia"></option>
            <option value="Jardim Antonio Augusto"></option>
            <option value="Jardim Caçapava"></option>
            <option value="Jardim Campo Grande"></option>
            <option value="Jardim Maria Cândida"></option>
            <option value="Jardim Panorama"></option>
            <option value="Jardim Primavera"></option>
            <option value="Jardim Rafael"></option>
            <option value="Jardim São Jose"></option>
            <option value="Jardim São João"></option>
            <option value="Lot. Pedro Rizzo 1"></option>
            <option value="Maria Elmira"></option>
            <option value="Nova Caçapava"></option>
            <option value="NSG Group/KM 131"></option>
            <option value="NSG Group/KM 133"></option>
            <option value="Padre Marcelo"></option>
            <option value="Paiol"></option>
            <option value="Parque do Museu"></option>
            <option value="Perinho"></option>
            <option value="Pinus"></option>
            <option value="Pinus 2"></option>
            <option value="Portal Vila Rica"></option>
            <option value="Real Park"></option>
            <option value="Recreio Mantiqueira"></option>
            <option value="Residencial Esperança"></option>
            <option value="Residencial Jequitiba"></option>
            <option value="Rodovia de Caçapava"></option>
            <option value="Samambaia"></option>
            <option value="Sapé 1"></option>
            <option value="Sapé 2"></option>
            <option value="São José dos Campos"></option>
            <option value="São Monica"></option>
            <option value="Tatauba"></option>
            <option value="Taubaté"></option>
            <option value="Terras do Vale"></option>
            <option value="Tijuco Preto"></option>
            <option value="Vera Cruz"></option>
            <option value="Vila Andre Martins"></option>
            <option value="Vila Antonio Augusto"></option>
            <option value="Vila Bandeirantes"></option>
            <option value="Vila Favorino"></option>
            <option value="Vila Galvão"></option>
            <option value="Vila Menino Jesus"></option>
            <option value="Vila Paraiso"></option>
            <option value="Vila Quirino"></option>
            <option value="Vila Resende"></option>
            <option value="Vila Santa Isabel"></option>
            <option value="Vila São João"></option>
            <option value="Vila Velha"></option>
            <option value="Vila Velha 1"></option>
            <option value="Vila Velha 2 - Taubaté"></option>
            <option value="Village das Flores"></option>
            <option value="Vitoria Vale"></option>
        </datalist>

        <script type="module">
            // IMPORTAÇÕES
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, addDoc, deleteDoc, onSnapshot, collection, doc, query, where, getDocs, getDoc, updateDoc, serverTimestamp, orderBy, limit, startAfter, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
            // CONFIGURAÇÃO FIREBASE
            const firebaseConfig = {
                apiKey: "AIzaSyDmqvcKtIsga4ZQWNDg4_2k493dqMQCDVg",
                authDomain: "teste-ebf38.firebaseapp.com",
                projectId: "teste-ebf38",
                storageBucket: "teste-ebf38.firebasestorage.app",
                messagingSenderId: "741884776297",
                appId: "1:741884776297:web:a23450b4909581a1b237f8",
                measurementId: "G-2MD5CFD51E"
            };
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            try {
                await enableIndexedDbPersistence(db);
                console.log("Persistência offline habilitada!");
            } catch (err) {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistência offline falhou: múltiplas abas abertas.");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistência offline não suportada neste navegador.");
                }
            }

            const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let currentUser = {
                username: null,
                isAdmin: false,
            };

            // ELEMENTOS DOM
            const loginForm = document.getElementById('login-form');
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');
            const loginMessage = document.getElementById('login-message');
            const userIdDisplay = document.getElementById('user-id-display');
            const logoutButton = document.getElementById('logout-btn');
            const motoristaInput = document.getElementById('motorista');
            const openMotoristasBtn = document.getElementById('open-motoristas-modal');
            const passageirosContainer = document.getElementById('passageiros-campos-container');
            const addPassageiroBtn = document.getElementById('add-passageiro-btn');
            const downloadCsvDetailedBtn = document.getElementById('download-csv-detailed');
            const csvReportDiv = document.getElementById('csv-report-section');
            const solicitanteContainer = document.getElementById('solicitante-campos-container');
            const addSolicitanteBtn = document.getElementById('add-solicitante-btn');
            const destinoContainer = document.getElementById('destino-campos-container');
            const addDestinoBtn = document.getElementById('add-destino-btn');
            const valorContainer = document.getElementById('valor-campos-container');
            const addValorBtn = document.getElementById('add-valor-btn');
            const editValorBtn = document.getElementById('add-edit-valor-btn');
            const openChangePasswordBtn = document.getElementById('open-change-password-btn');
            const changePasswordModal = document.getElementById('change-password-modal');
            const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal');
            const cancelChangePasswordBtn = document.getElementById('cancel-change-password-btn');
            const changePasswordForm = document.getElementById('change-password-form');
            const changePasswordMessage = document.getElementById('change-password-message');
            const resetPasswordModal = document.getElementById('reset-password-modal');
            const closeResetPasswordModalBtn = document.getElementById('close-reset-password-modal');
            const cancelResetPasswordBtn = document.getElementById('cancel-reset-password-btn');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const resetPasswordMessage = document.getElementById('reset-password-message');
            const motoristasTable = document.getElementById('motoristas-table');

            // --- LÓGICA PARA ALTERAR A PRÓPRIA SENHAa ---

            openChangePasswordBtn.addEventListener('click', () => {
                changePasswordForm.reset();
                changePasswordMessage.classList.add('hidden');
                changePasswordModal.classList.remove('hidden');
            });

            const closeChangePasswordModal = () => {
                changePasswordModal.classList.add('hidden');
            };

            closeChangePasswordModalBtn.addEventListener('click', closeChangePasswordModal);
            cancelChangePasswordBtn.addEventListener('click', closeChangePasswordModal);

            changePasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                changePasswordMessage.classList.add('hidden');

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                // Validações
                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    changePasswordMessage.innerText = 'Todos os campos são obrigatórios.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    changePasswordMessage.innerText = 'A nova senha e a confirmação não correspondem.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }

                // Verifica a senha atual
                const storedUserData = JSON.parse(localStorage.getItem('loggedInUserData'));
                if (storedUserData.password !== currentPassword) {
                    changePasswordMessage.innerText = 'A senha atual está incorreta.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }

                if (newPassword === currentPassword) {
                    changePasswordMessage.innerText = 'A nova senha deve ser diferente da atual.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }


                try {
                    const userDocRef = doc(db, 'users', storedUserData.id);
                    await updateDoc(userDocRef, {
                        password: newPassword
                    });

                    // ATUALIZA O LOCALSTORAGE TAMBÉM!
                    const updatedUserData = { ...storedUserData, password: newPassword };
                    localStorage.setItem('loggedInUserData', JSON.stringify(updatedUserData));

                    showWarning('Senha alterada com sucesso!');
                    closeChangePasswordModal();

                } catch (error) {
                    console.error("Erro ao atualizar senha:", error);
                    changePasswordMessage.innerText = 'Erro ao conectar com o servidor.';
                    changePasswordMessage.classList.remove('hidden');
                }
            });


            // --- LÓGICA PARA ADMIN REDEFINIR SENHA ---

            motoristasTable.addEventListener('click', (event) => {
                const resetButton = event.target.closest('.reset-password-btn');
                if (resetButton) {
                    const userId = resetButton.dataset.id;
                    const username = resetButton.dataset.username;

                    resetPasswordForm.reset();
                    resetPasswordMessage.classList.add('hidden');
                    document.getElementById('reset-user-id').value = userId;
                    document.getElementById('reset-username-display').innerText = username;
                    resetPasswordModal.classList.remove('hidden');
                }
            });

            const closeResetPasswordModal = () => {
                resetPasswordModal.classList.add('hidden');
            };

            closeResetPasswordModalBtn.addEventListener('click', closeResetPasswordModal);
            cancelResetPasswordBtn.addEventListener('click', closeResetPasswordModal);

            resetPasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                resetPasswordMessage.classList.add('hidden');

                const userId = document.getElementById('reset-user-id').value;
                const newPassword = document.getElementById('admin-new-password').value;

                if (!newPassword) {
                    resetPasswordMessage.innerText = 'O campo de nova senha é obrigatório.';
                    resetPasswordMessage.classList.remove('hidden');
                    return;
                }

                try {
                    const userDocRef = doc(db, 'users', userId);
                    await updateDoc(userDocRef, {
                        password: newPassword
                    });
                    showWarning(`Senha do usuário foi redefinida com sucesso!`);
                    closeResetPasswordModal();
                } catch (error) {
                    console.error("Erro ao redefinir a senha:", error);
                    resetPasswordMessage.innerText = 'Erro ao conectar com o servidor.';
                    resetPasswordMessage.classList.remove('hidden');
                }
            });

            // === DADOS GLOBAIS ===
            let transportadosData = [];
            let usersData = []; // Substituído motoristasData por usersData
            let lancamentosData = [];
            let reToNome = {};
            let nomeToRE = {};

            function rebuildTransportadosLookups(sortKey = 'nome', sortOrder = 'asc') {
                transportadosData.sort((a, b) => {
                    let valA = a[sortKey] || '';
                    let valB = b[sortKey] || '';
                    return sortOrder === 'asc' ? valA.localeCompare(valB, undefined, { numeric: true }) : valB.localeCompare(valA, undefined, { numeric: true });
                });
                reToNome = {};
                nomeToRE = {};
                transportadosData.forEach(item => {
                    reToNome[item.re] = item.nome;
                    nomeToRE[item.nome.toLowerCase()] = item.re;
                });
                renderTransportadosList();
            }

            function rebuildMotoristasLookups(sortOrder = 'asc') {
                usersData.sort((a, b) => sortOrder === 'asc' ? a.nome.localeCompare(b.nome) : b.nome.localeCompare(a.nome));
                renderMotoristasList();
                populateMotoristasDatalist();
                populateMotoristasFilterDropdown();
            }
            // === FUNÇÕES DE VALIDAÇÃO E INTERFACE ===

            function showWarning(message) {
                document.getElementById('message-content').innerText = message;
                document.getElementById('message-modal').classList.remove('hidden');
            }

            function hideWarning() {
                document.getElementById('message-modal').classList.add('hidden');
            }

            // NOVA FUNÇÃO para configurar a interface com base nos dados do usuário do Firestore
            function setMotoristaFromData(userData) {
                currentUser.username = userData.username;
                currentUser.isAdmin = userData.is_admin || false;
                currentUser.nome = userData.nome;
                userIdDisplay.classList.add('hidden'); // Oculta o ID antigo
                if (currentUser.isAdmin) {
                    openMotoristasBtn.classList.remove('hidden');
                    csvReportDiv.classList.remove('hidden'); // Mostra o botão de relatório para admins
                } else {
                    openMotoristasBtn.classList.add('hidden');
                    csvReportDiv.classList.add('hidden'); // Esconde o botão de relatório para não admins
                }

                if (userData.is_motorista_fixo) {
                    motoristaInput.value = userData.nome;
                    motoristaInput.setAttribute('readonly', 'readonly');
                    motoristaInput.classList.add('bg-gray-200');
                } else {
                    motoristaInput.removeAttribute('readonly');
                    motoristaInput.classList.remove('bg-gray-200');
                    motoristaInput.value = userData.nome || '';
                }
            }

            function checkPassageiroDuplicidade(sourceInput) {
                const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
                const row = sourceInput.closest('.passageiro-row');
                const currentREInput = row.querySelector('input[name="res[]"]');
                const currentNomeInput = row.querySelector('input[name="transportados[]"]');
                const currentRE = currentREInput.value.trim();
                const currentNome = currentNomeInput.value.trim();
                if (currentRE === '' || currentNome === '') {
                    currentREInput.classList.remove('error-border');
                    currentNomeInput.classList.remove('error-border');
                    return false;
                }

                const currentKey = `${currentRE}_${currentNome.toLowerCase()}`;
                let isDuplicated = false;

                rows.forEach(r => {
                    r.querySelector('input[name="res[]"]').classList.remove('error-border');
                    r.querySelector('input[name="transportados[]"]').classList.remove('error-border');
                });
                rows.forEach(rowToCheck => {
                    const rowRE = rowToCheck.querySelector('input[name="res[]"]').value.trim();
                    const rowNome = rowToCheck.querySelector('input[name="transportados[]"]').value.trim();
                    const rowKey = `${rowRE}_${rowNome.toLowerCase()}`;
                    const isSameRow = (rowToCheck === row);

                    if (rowKey === currentKey && !isSameRow) {
                        isDuplicated = true;
                        rowToCheck.querySelector('input[name="res[]"]').classList.add('error-border');
                        rowToCheck.querySelector('input[name="transportados[]"]').classList.add('error-border');
                    }
                });
                if (isDuplicated) {
                    currentREInput.classList.add('error-border');
                    currentNomeInput.classList.add('error-border');
                    showWarning(`Passageiro duplicado encontrado: RE ${currentRE} e Nome ${currentNome}.`);
                }

                return isDuplicated;
            }


            // ===============================================
            // ▼▼▼ NOVA LÓGICA DE AUTOCOMPLETE ▼▼▼
            // ===============================================

            function closeAllAutocompleteLists() {
                const container = document.getElementById('autocomplete-suggestions-container');
                container.innerHTML = '';
            }

            function showAutocompleteSuggestions(inputElement, filterType) {
                const val = inputElement.value;
                closeAllAutocompleteLists();
                if (!val || val.length < 2) { // Só busca a partir de 2 caracteres
                    return false;
                }

                const container = document.getElementById('autocomplete-suggestions-container');
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.setAttribute('class', 'autocomplete-items');
                container.appendChild(suggestionsDiv);

                const rect = inputElement.getBoundingClientRect();
                container.style.position = 'absolute';
                container.style.left = `${rect.left + window.scrollX}px`;
                container.style.top = `${rect.bottom + window.scrollY}px`;
                container.style.width = `${rect.width}px`;

                const normalizedVal = val.toLowerCase();
                let suggestions = [];

                // USA A LISTA LOCAL "transportadosData" - RÁPIDO E SEM CUSTO DE LEITURA
                if (filterType === 're') {
                    suggestions = transportadosData.filter(item => item.re && item.re.toLowerCase().includes(normalizedVal));
                } else { // 'nome'
                    suggestions = transportadosData.filter(item => item.nome && item.nome.toLowerCase().includes(normalizedVal));
                }

                if (suggestions.length === 0) {
                    suggestionsDiv.innerHTML = '<div>Nenhum resultado.</div>';
                    return;
                }

                // Limita o número de sugestões para não poluir a tela
                suggestions.slice(0, 7).forEach(item => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.innerHTML = `<strong>${item.re}</strong> - ${item.nome}`;
                    suggestionItem.addEventListener('click', function () {
                        // Ao clicar, preenche os campos da linha correta
                        const parentRow = inputElement.closest('.passageiro-row');
                        const reInput = parentRow.querySelector('input[name="res[]"]');
                        const nomeInput = parentRow.querySelector('input[name="transportados[]"]');

                        reInput.value = item.re;
                        nomeInput.value = item.nome;

                        closeAllAutocompleteLists();
                        // Dispara a checagem de duplicidade
                        setTimeout(() => checkPassageiroDuplicidade(inputElement), 50);
                    });
                    suggestionsDiv.appendChild(suggestionItem);
                });
            }

            function handleAutofillDynamic(sourceInput, targetInput, sourceType) {
                const value = sourceInput.value.trim();
                if (value !== '') {
                    let targetValue = '';
                    if (sourceType === 're') {
                        targetValue = reToNome[value];
                    } else if (sourceType === 'nome') {
                        targetValue = nomeToRE[value.toLowerCase()];
                    }

                    if (targetValue) {
                        targetInput.value = targetValue;
                        targetInput.classList.remove('error-border');
                    } else {
                        targetInput.value = '';
                    }
                } else {
                    targetInput.value = '';
                }

            }

/**
             * Verifica uma lista de passageiros e salva aqueles que não existem
             * na coleção principal 'transportados'.
             */
/**
             * Verifica uma lista de passageiros e salva aqueles que não existem
             * na coleção principal 'transportados', com verificação no servidor.
             */
            async function salvarNovosTransportados(passageiros) {
                if (!passageiros || passageiros.length === 0) return;

                const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                let novosAdicionados = 0;

                for (const p of passageiros) {
                    if (!p.re || !p.nome) continue; // Pula se dados incompletos

                    // 1. Verifica se o RE já existe na lista LOCAL (rápido, 0 leituras)
                    const reExistsLocal = transportadosData.some(item => item.re === p.re);
                    
                    if (!reExistsLocal) {
                        try {
                            // 2. O RE não está na lista local. ANTES DE SALVAR,
                            //    vamos confirmar no servidor (gasta 1 leitura).
                            const q = query(transportadosRef, where("re", "==", p.re));
                            const querySnapshot = await getDocs(q);

                            // 3. Se a consulta voltar vazia, ninguém salvou esse RE ainda.
                            if (querySnapshot.empty) {
                                console.log(`Adicionando novo transportado: RE ${p.re}, Nome ${p.nome}`);
                                
                                // Adiciona o novo transportado no Firestore
                                const newDoc = await addDoc(transportadosRef, { re: p.re, nome: p.nome });
                                
                                // Adiciona na lista local também
                                transportadosData.push({ re: p.re, nome: p.nome, id: newDoc.id });
                                novosAdicionados++;
                            } else {
                                // Alguém já salvou esse RE. Apenas adicionamos
                                // o dado que veio do servidor na nossa lista local.
                                const docData = querySnapshot.docs[0].data();
                                transportadosData.push({ id: querySnapshot.docs[0].id, ...docData });
                                console.warn(`Conflito evitado: RE ${p.re} já existe no banco.`);
                            }

                        } catch (e) {
                            console.warn("Transportado já cadastado - Atualize a página para verificar novo transportado:", e);
                        }
                    }
                }

                if (novosAdicionados > 0) {
                    // Reconstrói os lookups para o autocomplete
                    rebuildTransportadosLookups();
                    console.log(`${novosAdicionados} novo(s) transportado(s) salvo(s).`);
                }
            }


// SUBSTITUA A FUNÇÃO INTEIRA POR ISTO:
            function checkEditPassageiroDuplicidade() {
                const reSeen = new Map();
                let isDuplicated = false;

                // 1. Pega todos os inputs de RE e Nome do modal de edição
                const p1REInput = document.getElementById('edit-re');
                const p1NomeInput = document.getElementById('edit-transportado');
                const extraREInputs = document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-res[]"]');
                const extraNomeInputs = document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-transportados[]"]');

                // 2. Combina todos em uma lista de "pares"
                const allPassengerInputs = [
                    { reInput: p1REInput, nomeInput: p1NomeInput }
                ];
                extraREInputs.forEach((reInput, i) => {
                    allPassengerInputs.push({ reInput: reInput, nomeInput: extraNomeInputs[i] });
                });
                
                // 3. Reseta as bordas de erro
                allPassengerInputs.forEach(pair => {
                    pair.reInput.classList.remove('error-border');
                    pair.nomeInput.classList.remove('error-border');
                });

                // 4. Itera e verifica duplicidade apenas pelo RE
                allPassengerInputs.forEach(pair => {
                    const re = pair.reInput.value.trim();
                    const nome = pair.nomeInput.value.trim();

                    if (re === '') {
                        // Não checa RE vazio, mas marca erro se o nome estiver preenchido
                        if (nome !== '') pair.reInput.classList.add('error-border');
                        return; 
                    }
                    
                    const key = re; // A chave agora é SÓ o RE

                    if (reSeen.has(key)) {
                        isDuplicated = true;
                        // Marca a linha atual como duplicada
                        pair.reInput.classList.add('error-border');
                        pair.nomeInput.classList.add('error-border');

                        // Marca a primeira linha encontrada com o mesmo RE
                        const firstSeenPair = reSeen.get(key);
                        firstSeenPair.reInput.classList.add('error-border');
                        firstSeenPair.nomeInput.classList.add('error-border');
                    } else {
                        reSeen.set(key, pair); // Armazena o par de inputs para marcar depois
                    }
                });

                if (isDuplicated) {
                    showWarning('Matrícula (RE) duplicada encontrada no formulário de edição.');
                }
                return isDuplicated;
            }

            function formatCurrencyInput(input) {
                if (!input) return;
                let value = input.value.replace(/\D/g, '');
                if (value === '') {
                    input.value = '0,00';
                    return;
                }
                value = value.padStart(3, '0');
                const integerPart = value.slice(0, -2);
                const decimalPart = value.slice(-2);
                const formattedInteger = parseInt(integerPart, 10).toLocaleString('pt-BR');
                input.value = `${formattedInteger},${decimalPart}`;
            }

            function parseCurrencyValue(value) {
                if (typeof value !== 'string' || value.trim() === '') return 0;
                return parseFloat(value.replace(/\./g, '').replace(',', '.'));
            }

            // --- Lógica Solicitante/Destino/Valor Dinâmico (Página Principal) ---

            function updateDynamicLabels(containerId, inputName, baseLabel) {
                const rows = document.querySelectorAll(`#${containerId} .dynamic-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const label = row.querySelector('label');
                    const input = row.querySelector('input');

                    if (label) {
                        label.textContent = index === 0 ? baseLabel + ':' : `${baseLabel} (P${pNum}):`;
                    }

                    if (containerId === 'solicitante-campos-container' && index === 0 && input) {
                        input.id = 'solicitante';
                        input.name = 'solicitantes[]';
                    }
                    if (containerId === 'destino-campos-container' && index === 0) {
                        const destinoInput = row.querySelector('input[name="destinos[]"]');
                        if (destinoInput) destinoInput.id = 'destino';
                        const chegadaInput = row.querySelector('input[name="chegadas_destino[]"]');
                        if (chegadaInput) chegadaInput.id = 'chegada_destino_p1';
                    }

                    if (containerId === 'valor-campos-container') {
                        const valorInput = row.querySelector('input[name="valores[]"]');
                        const valorExtraInput = row.querySelector('input[name="valores_extra[]"]');

                        if (valorInput) {
                            valorInput.id = index === 0 ? 'valor' : `valor-${pNum}`;
                            valorInput.name = 'valores[]';
                            valorInput.classList.remove('error-border');
                            valorInput.addEventListener('input', () => formatCurrencyInput(valorInput));
                            valorInput.addEventListener('focus', () => { if (valorInput.value === '0,00') valorInput.value = ''; });
                            valorInput.addEventListener('blur', () => { if (valorInput.value === '') valorInput.value = '0,00'; });
                            if (valorInput.value === '') valorInput.value = '0,00';
                        }

                        if (valorExtraInput) {
                            valorExtraInput.id = index === 0 ? 'valor-extra' : `valor-extra-${pNum}`;
                            valorExtraInput.name = 'valores_extra[]';
                            valorExtraInput.classList.remove('error-border');
                            valorExtraInput.addEventListener('input', () => formatCurrencyInput(valorExtraInput));
                            valorExtraInput.addEventListener('focus', () => { if (valorExtraInput.value === '0,00') valorExtraInput.value = ''; });
                            valorExtraInput.addEventListener('blur', () => { if (valorExtraInput.value === '') valorExtraInput.value = '0,00'; });
                            if (valorExtraInput.value === '') valorExtraInput.value = '0,00';
                        }
                    }

                    const removeBtn = row.querySelector('.remove-dynamic-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updateDynamicLabels(containerId, inputName, baseLabel);
                            };
                        }
                    }
                });
            }

            function createSolicitanteInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row form-row-align';

                const pNum = document.querySelectorAll(`#solicitante-campos-container .dynamic-row`).length + 1;
                const labelText = isRequired ? 'Solicitante:' : `Solicitante (P${pNum}):`;
                fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="solicitante-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <input type="text" id="solicitante-${index}" name="solicitantes[]"
                        onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                    -
                </button>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('solicitante-campos-container', 'solicitante', 'Solicitante');
                    };
                }
                return fieldset;
            }

            function createDestinoInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6';
                fieldset.dataset.pNum = (document.querySelectorAll(`#destino-campos-container .dynamic-row`).length + 1);

                const pNum = fieldset.dataset.pNum;
                const labelText = isRequired ? 'Destino:' : `Destino (P${pNum}):`;
                const labelTime = isRequired ? 'Chegada (Horário):' : `Chegada (P${pNum}):`;
                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="destino-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                        <input type="text" id="destino-${index}" name="destinos[]" list="locais-list"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="chegada-destino-${index}" class="block text-sm font-medium text-gray-700">${labelTime}</label>
                        <input type="time" id="chegada-destino-${index}" name="chegadas_destino[]"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('destino-campos-container', 'destino', 'Destino');
                    };
                }
                return fieldset;
            }

            function createValorInput(pNum, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6 valor-row';
                fieldset.dataset.pNum = pNum;
                const isP1 = pNum === 1;
                const labelValor = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                const labelValorExtra = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                const inputIdValor = pNum === 1 ? 'valor' : `valor-${pNum}`;
                const inputIdValorExtra = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
                fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="valores[]"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out text-right">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                        <div class="relative mt-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                            <input type="text" id="${inputIdValorExtra}" name="valores_extra[]"
                                class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:focus:border-blue-500 transition duration-150 ease-in-out text-right">
                        </div>
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-valor-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
            `;

                const removeBtn = fieldset.querySelector('.remove-valor-btn');
                if (removeBtn && !isP1) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateValueLabels();
                    };
                }
                return fieldset;
            }

            function createOrigemInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                // Alterado para usar grid, igual ao destino
                fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6';
                const pNum = document.querySelectorAll(`#origem-campos-container .dynamic-row`).length + 1;
                const labelOrigem = isRequired ? 'Origem:' : `Origem (P${pNum}):`;
                const labelPartida = isRequired ? 'Partida:' : `Partida (P${pNum}):`;

                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">${labelOrigem}</label>
                        <input type="text" name="origens[]" list="locais-list" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">${labelPartida}</label>
                        <input type="time" name="partidas[]" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('origem-campos-container', 'origem', 'Origem');
                    };
                }
                return fieldset;
            }

            function removeValueRow(pNumToRemove) {
                const rowToRemove = document.querySelector(`#valor-campos-container .valor-row[data-p-num="${pNumToRemove}"]`);
                if (rowToRemove) {
                    rowToRemove.remove();
                    updateValueLabels();
                }
            }

            function updateValueLabels() {
                const rows = document.querySelectorAll(`#valor-campos-container .valor-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    row.dataset.pNum = pNum;

                    const labelValor = row.querySelector(`label[for^="valor"]`);
                    const labelValorExtra = row.querySelector(`label[for^="valor-extra"]`);
                    const inputValor = row.querySelector('input[name="valores[]"]');
                    const inputValorExtra = row.querySelector('input[name="valores_extra[]"]');
                    const removeBtn = row.querySelector('.remove-valor-btn');

                    if (labelValor) labelValor.textContent = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                    if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                    if (inputValor) inputValor.id = pNum === 1 ? 'valor' : `valor-${pNum}`;
                    if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
                    if (removeBtn) {
                        if (pNum === 1) removeBtn.classList.add('hidden');
                        else removeBtn.classList.remove('hidden');
                    }

                    if (inputValor) {
                        inputValor.removeEventListener('input', formatCurrencyInput);
                        inputValor.addEventListener('input', () => formatCurrencyInput(inputValor));
                        inputValor.removeEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                        inputValor.addEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                        inputValor.removeEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                        inputValor.addEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                    }
                    if (inputValorExtra) {
                        inputValorExtra.removeEventListener('input', formatCurrencyInput);
                        inputValorExtra.addEventListener('input', () => formatCurrencyInput(inputValorExtra));
                        inputValorExtra.removeEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                        inputValorExtra.addEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                        inputValorExtra.removeEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                        inputValorExtra.addEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                    }
                });
            }

            function addDynamicRow(containerId, inputName, baseLabel, isRequired = false) {
                const container = document.getElementById(containerId);
                let newRow;

                if (inputName === 'destino') {
                    newRow = createDestinoInput(Date.now(), isRequired);
                } else if (inputName === 'solicitante') {
                    newRow = createSolicitanteInput(Date.now(), isRequired);
                } else if (inputName === 'valor') {
                    newRow = createValorInput(document.querySelectorAll(`#valor-campos-container .valor-row`).length + 1, false);
                } else if (inputName === 'origem') { // <-- NOVO CASO ADICIONADO
                    newRow = createOrigemInput(Date.now(), isRequired);
                }

                if (newRow) {
                    container.appendChild(newRow);
                    updateDynamicLabels(containerId, inputName, baseLabel);
                }
            }
            addValorBtn.addEventListener('click', () => addDynamicRow('valor-campos-container', 'valor', 'Valor', false));

            // --- Lógica Passageiros (Transportados) ---
            function updatePassageiroLabels() {
                const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const reLabel = row.querySelector(`label[for^="re-"]`);
                    const transportadoLabel = row.querySelector(`label[for^="transportado-"]`);

                    if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                    if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`;

                    const removeBtn = row.querySelector('.remove-passageiro-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updatePassageiroLabels();
                            };
                        }
                    }
                });
            }

            function createEditOrigemInput(origemValue = '', partidaValue = '') {
                const containerId = 'edit-origem-campos-container';
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4';
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;

                fieldset.innerHTML = `
            <div class="form-row-align">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">Origem (P${pNum}):</label>
                    <input type="text" name="edit-origens[]" value="${origemValue}" list="locais-list"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                    -
                </button>
            </div>
            <div class="form-row-align">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">Partida (P${pNum}):</label>
                    <input type="time" name="edit-partidas[]" value="${partidaValue}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
            </div>
        `;
                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => fieldset.remove();
                }
                return fieldset;
            }

            function createPassageiroInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 relative'; // Adicionamos a classe 'relative'
                fieldset.dataset.index = index;
                fieldset.innerHTML = `
                <div>
                    <label for="re-${index}" class="block text-sm font-medium text-gray-700">RE (P${index + 1}):</label>
                    <input type="text" id="re-${index}" name="res[]"
                        onfocus="this.classList.remove('error-border')"
                        autocomplete="off" 
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label for="transportado-${index}" class="block text-sm font-medium text-gray-700">Transportado (P${index + 1}):</label>
                        <input type="text" id="transportado-${index}" name="transportados[]"
                            onfocus="this.classList.remove('error-border')"
                            autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-passageiro-btn ${isRequired ? 'hidden' : ''}">
                    -
                    </button>
                </div>
            `;
                // A div de sugestões será adicionada aqui via JS
                return fieldset;
            }

            function addPassageiroRow(isRequired = false) {
                const newIndex = Date.now();
                const newRow = createPassageiroInput(newIndex, isRequired);
                passageirosContainer.appendChild(newRow);
                updatePassageiroLabels();
            }


            // --- INICIALIZAÇÃO E EVENTOS GLOBAIS ---
            window.onload = () => {
                const loggedInUserData = localStorage.getItem('loggedInUserData');
                if (loggedInUserData) {
                    try {
                        const userData = JSON.parse(loggedInUserData);
                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        setMotoristaFromData(userData); // Usa a nova função
                    } catch (e) {
                        // Se os dados estiverem corrompidos, limpa e força o login
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('loggedInUserData');
                        loginPage.classList.remove('hidden');
                        appPage.classList.add('hidden');
                    }
                } else {
                    loginPage.classList.remove('hidden');
                    appPage.classList.add('hidden');
                }

                addDynamicRow('origem-campos-container', 'origem', 'Origem', true);
                document.getElementById('add-origem-btn').addEventListener('click', () => addDynamicRow('origem-campos-container', 'origem', 'Origem', false));

                // VERSÃO ATUALIZADA COM AUTOSUGGEST
                function bindPassageiroListeners() {
                    passageirosContainer.addEventListener('input', (event) => {
                        const input = event.target;
                        if (input.matches('input[name="res[]"]')) {
                            showAutocompleteSuggestions(input, 're');
                        } else if (input.matches('input[name="transportados[]"]')) {
                            showAutocompleteSuggestions(input, 'nome');
                        }
                    });

                    // Adiciona um listener para fechar as sugestões se clicar fora
                    document.addEventListener('click', function (e) {
                        const container = document.getElementById('autocomplete-suggestions-container');
                        if (e.target !== container && !container.contains(e.target) && !e.target.matches('input[name="res[]"]') && !e.target.matches('input[name="transportados[]"]')) {
                            closeAllAutocompleteLists();
                        }
                    });
                }

                addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);
                addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
                addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
                addPassageiroRow(true);

                bindPassageiroListeners();
                addPassageiroBtn.addEventListener('click', () => addPassageiroRow(false));
                addSolicitanteBtn.addEventListener('click', () => addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', false));
                addDestinoBtn.addEventListener('click', () => {
                    addDynamicRow('destino-campos-container', 'destino', 'Destino', false);
                });

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        startFirestoreListeners();
                    } else {
                        if (!localStorage.getItem('loggedInUserData')) {
                            loginPage.classList.remove('hidden');
                            appPage.classList.add('hidden');
                        }
                    }
                });
                signInAnonymously(auth).catch((error) => console.error("Erro no login anônimo:", error));
            };

            // LÓGICA DE LOGIN ATUALIZADA
            loginForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                loginMessage.classList.add('hidden');

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("username", "==", username), where("password", "==", password));

                try {
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = { id: userDoc.id, ...userDoc.data() };

                        localStorage.setItem('loggedInUser', username);
                        localStorage.setItem('loggedInUserData', JSON.stringify(userData));

                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        setMotoristaFromData(userData);
                    } else {
                        loginMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Erro ao fazer login:", error);
                    loginMessage.innerText = 'Erro ao conectar com o servidor.';
                    loginMessage.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('loggedInUserData'); // Limpa os dados do usuário
                signOut(auth).then(() => {
                    window.location.reload();
                });
            });

            // NOVA FUNÇÃO para tornar linhas de tabela clicáveis
            function makeTableRowsClickable(tableId) {
                const table = document.getElementById(tableId);
                if (!table) return;

                const tableBody = table.querySelector('tbody');
                if (!tableBody) return;

                tableBody.addEventListener('click', function (event) {
                    if (event.target.type === 'checkbox') {
                        return;
                    }
                    const row = event.target.closest('tr');
                    if (!row) return;
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });
            }

            // LISTENERS DO FIRESTORE ATUALIZADOS
            // LISTENERS DO FIRESTORE ATUALIZADOS PARA USAR getDocs (MAIS EFICIENTE)
            // ▼▼▼ ESTA É A FUNÇÃO 3 (VERSÃO LIMPA) ▼▼▼
            // (Cole esta no lugar da função que você acabou de me enviar)

            async function startFirestoreListeners() {
                // --- Carrega Transportados (uma única vez) ---
                try {
                    const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                    const transportadosSnapshot = await getDocs(transportadosRef);
                    transportadosData = transportadosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rebuildTransportadosLookups();
                    console.log("Transportados carregados.");
                } catch (error) {
                    console.error("Erro ao buscar transportados:", error);
                    showWarning("Não foi possível carregar a lista de transportados.");
                }

                // --- Carrega Usuários/Motoristas (uma única vez) ---
                try {
                    const usersRef = collection(db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rebuildMotoristasLookups();
                    console.log("Motoristas carregados.");
                } catch (error) {
                    console.error("Erro ao buscar usuários:", error);
                    showWarning("Não foi possível carregar a lista de motoristas.");
                }

                // Ativa a funcionalidade de clique nas tabelas
                makeTableRowsClickable('motoristas-table');
            }
            document.getElementById('form-corrida').addEventListener('submit', async function (event) {
                // A PRIMEIRA COISA a se fazer é impedir o recarregamento da página.
                event.preventDefault();

                const form = event.target;
                const requiredFields = ['motorista', 'data']; // Removido 'valor' temporariamente para validação

                const origensInputs = document.querySelectorAll('#origem-campos-container input[name="origens[]"]');
                const partidasInputs = document.querySelectorAll('#origem-campos-container input[name="partidas[]"]');
                const solicitantesInputs = document.querySelectorAll('#solicitante-campos-container input[name="solicitantes[]"]');
                const destinosInputs = document.querySelectorAll('#destino-campos-container input[name="destinos[]"]');
                const chegadasDestinoInputs = document.querySelectorAll('#destino-campos-container input[name="chegadas_destino[]"]');
                const valoresInputs = document.querySelectorAll('#valor-campos-container input[name="valores[]"]');
                const valoresExtraInputs = document.querySelectorAll('#valor-campos-container input[name="valores_extra[]"]');
                const resInputs = document.querySelectorAll('#passageiros-campos-container input[name="res[]"]');
                const transportadosInputs = document.querySelectorAll('#passageiros-campos-container input[name="transportados[]"]');

                let isFormValid = true;

                requiredFields.forEach(field => {
                    const input = form[field];
                    if (input && input.value.trim() === '') {
                        isFormValid = false;
                        input.classList.add('error-border');
                    } else if (input) {
                        input.classList.remove('error-border');
                    }
                });

                const origensData = [];
                const partidasData = [];
                for (let i = 0; i < origensInputs.length; i++) {
                    const origem = origensInputs[i].value.trim();
                    const partida = partidasInputs[i].value.trim();
                    if (origem || partida) {
                        origensData.push(origem);
                        partidasData.push(partida);
                    }
                }

                const solicitantesData = [];
                solicitantesInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value !== '') {
                        solicitantesData.push(value);
                    }
                });

                const destinosData = [];
                const chegadasDestinoData = [];
                for (let i = 0; i < destinosInputs.length; i++) {
                    const destino = destinosInputs[i].value.trim();
                    const chegada = chegadasDestinoInputs[i].value.trim();
                    if (destino || chegada) {
                        destinosData.push(destino);
                        chegadasDestinoData.push(chegada);
                    }
                }

                const valoresData = [];
                const valoresExtraData = [];
                for (let i = 0; i < valoresInputs.length; i++) {
                    const valor = parseCurrencyValue(valoresInputs[i].value);
                    const valorExtra = parseCurrencyValue(valoresExtraInputs[i].value);
                    valoresData.push(valor);
                    valoresExtraData.push(valorExtra);
                }

                const passageirosData = [];
                const reSet = new Set(); //
// SUBSTITUA O 'for' LOOP INTEIRO POR ISTO:
                for (let i = 0; i < resInputs.length; i++) {
                    const reInput = resInputs[i];
                    const nomeInput = transportadosInputs[i];
                    const re = reInput.value.trim();
                    const nome = nomeInput.value.trim();

                    reInput.classList.remove('error-border');
                    nomeInput.classList.remove('error-border');

                    if (re !== '' && nome !== '') {
                        
                        // VERIFICAÇÃO DE RE DUPLICADO
                        if (reSet.has(re)) { 
                            isFormValid = false;
                            reInput.classList.add('error-border');
                            nomeInput.classList.add('error-border'); // Marca ambos os campos
                            showWarning(`Matrícula (RE) duplicada neste lançamento: ${re}.`);
                            return; // Para o envio
                        }
                        reSet.add(re); // Adiciona o RE ao set para verificar os próximos
                        
                        passageirosData.push({ re: re, nome: nome });
                    } else if (re !== '' || nome !== '') {
                        // Se um estiver preenchido e o outro não
                        isFormValid = false;
                        if (re === '') reInput.classList.add('error-border');
                        if (nome === '') nomeInput.classList.add('error-border');
                    }
                }

                if (passageirosData.length === 0) {
                    isFormValid = false;
                    if (resInputs[0]) resInputs[0].classList.add('error-border');
                    if (transportadosInputs[0]) transportadosInputs[0].classList.add('error-border');
                }

                if (!isFormValid) {
                    showWarning('Preencha todos os campos obrigatórios e verifique os dados.');
                    return;
                }

                const destinosExtras = [];
                for (let i = 1; i < destinosData.length; i++) {
                    destinosExtras.push({
                        destino: destinosData[i],
                        chegada: chegadasDestinoData[i],
                        valor: valoresData[i] || 0,
                        valorExtra: valoresExtraData[i] || 0
                    });
                }

                const newEntry = {
                    createdBy: currentUser.username,
                    motorista: form['motorista'].value,
                    bordero: form['bordero'].value.trim(),
                    re: passageirosData[0].re,
                    transportado: passageirosData[0].nome,
                    passageiros_extras: passageirosData.slice(1),
                    solicitante: solicitantesData[0] || '',
                    solicitantes_extras: solicitantesData.slice(1),
                    data: form['data'].value,
                    origem: origensData.length > 0 ? origensData[0] : '',
                    partida: partidasData.length > 0 ? partidasData[0] : '',
                    origens_extras: origensData.slice(1).map((origem, i) => ({ origem: origem, partida: partidasData[i + 1] || '' })),
                    destino: destinosData[0] || '',
                    chegada_destino: chegadasDestinoData[0] || '',
                    valor: valoresData[0] || 0,
                    valorExtra: valoresExtraData[0] || 0,
                    destinos_extras: destinosExtras,
                    observacao: form['observacao'].value,
                    createdAt: serverTimestamp()
                };

                const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
                await addDoc(lancamentosRef, newEntry);

                showWarning('Lançamento salvo com sucesso!');
                const dataValue = form['data'].value;
                const motoristaValue = form['motorista'].value;

                form.reset();

                form['data'].value = dataValue;
                form['motorista'].value = motoristaValue;

                solicitanteContainer.innerHTML = '';
                addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);

                document.getElementById('origem-campos-container').innerHTML = '';
                addDynamicRow('origem-campos-container', 'origem', 'Origem', true);

                destinoContainer.innerHTML = '';
                addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
                valorContainer.innerHTML = '';
                addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
                passageirosContainer.innerHTML = '';
                addPassageiroRow(true);
            });

            function formatMultipleValues(principal, extras, isPassageiro = false) {
                let result = principal || '';
                if (extras && extras.length > 0) {
                    const extraList = extras.map(e => isPassageiro ? e.nome : e);
                    result += ' (' + extraList.join(', ') + ')';
                }
                return result;
            }

            function formatDestinosChegadas(principalDestino, principalChegada, extras) {
                let result = principalDestino || '';
                if (principalChegada) {
                    result += ` (${principalChegada})`;
                }

                if (extras && extras.length > 0) {
                    const extraList = extras.map(e => `${e.destino || ''}${e.chegada ? ` (${e.chegada})` : ''}`).filter(s => s !== '');
                    if (extraList.length > 0) {
                        result += ' (' + extraList.join(', ') + ')';
                    }
                }
                return result;
            }

            function calculateTotalValue(lancamento) {
                let total = lancamento.valor || 0;
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(dest => {
                        total += dest.valor || 0;
                    });
                }
                return total;
            }

            function calculateTotalExtraValue(lancamento) {
                let total = lancamento.valorExtra || 0;
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(dest => {
                        total += dest.valorExtra || 0;
                    });
                }
                return total;
            }

            // NOVA FUNÇÃO PARA BUSCAR E RENDERIZAR OS DADOS SOB DEMANDA
            async function fetchAndRenderLancamentos() {
                const tableBody = document.querySelector('#lancamentos-table tbody');
                tableBody.innerHTML = '<tr><td colspan="15" class="text-center p-4">Carregando...</td></tr>';

                const selectedDate = document.getElementById('filter-date').value;
                const selectedMotorista = document.getElementById('filter-motorista').value;

                if (!selectedDate) {
                    tableBody.innerHTML = '<tr><td colspan="15" class="text-center p-4">Selecione uma data para ver os lançamentos.</td></tr>';
                    return;
                }

                try {
                    const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');

                    // CRIA A CONSULTA AO FIREBASE (SEM O LIMITE DE 15)
                    const q = query(
                        lancamentosRef,
                        where("data", "==", selectedDate), // Filtra pela data selecionada
                        orderBy("createdAt", "desc")       // Ordena pelos mais recentes
                    );

                    const snapshot = await getDocs(q);
                    let dataToShow = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Filtra no lado do cliente caso o usuário não seja admin
                    if (!currentUser.isAdmin) {
                        dataToShow = dataToShow.filter(lanc => lanc.createdBy === currentUser.username);
                    }

                    if (selectedMotorista) { // Se um motorista foi selecionado (não é "Todos")
                        dataToShow = dataToShow.filter(lanc => lanc.motorista === selectedMotorista);
                    }

                    renderLancamentosTable(dataToShow); // Chama a função para popular a tabela

                } catch (error) {
                    console.error("Erro ao buscar lançamentos:", error);
                    tableBody.innerHTML = '<tr><td colspan="15" class="text-center p-4 text-red-500">Ocorreu um erro ao carregar os dados.</td></tr>';
                }
            }
            // NOVA FUNÇÃO DEDICADA APENAS A POPULAR A TABELA HTML
            function renderLancamentosTable(dataToShow) {
                const tableBody = document.querySelector('#lancamentos-table tbody');
                tableBody.innerHTML = '';

                if (dataToShow.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="15" class="text-center p-4">Nenhum lançamento encontrado para esta data.</td></tr>';
                    return;
                }

                dataToShow.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';

                    const totalValue = calculateTotalValue(item);
                    const totalExtraValue = calculateTotalExtraValue(item);
                    const transportadoFull = formatMultipleValues(item.transportado, item.passageiros_extras, true);
                    const solicitanteFull = formatMultipleValues(item.solicitante, item.solicitantes_extras, false);
                    const destinoFull = formatDestinosChegadas(item.destino, item.chegada_destino, item.destinos_extras);
                    const statusText = item.editedBy ? `<span class="text-xs text-gray-500">Editado por ${item.editedBy}</span>` : '';

                    row.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden">${item.id || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.data || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.motorista || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.bordero || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${solicitanteFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transportadoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.origem || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${destinoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.partida || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalExtraValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.observacao || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${statusText}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 flex gap-2">
                        <button data-id="${item.id}" class="edit-lancamento-btn text-blue-600 hover:text-blue-900" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-id="${item.id}" class="delete-lancamento-btn text-red-600 hover:text-red-900" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                    tableBody.appendChild(row);
                });
            }

document.getElementById('open-lancamentos-modal').addEventListener('click', () => {
                // Define a data do filtro para o dia atual
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('filter-date').value = today;

                // ▼▼▼ ADICIONADO ▼▼▼
                // Mostra ou esconde o filtro de motorista baseado no status de admin
                const motoristaFilter = document.getElementById('motorista-filter-wrapper');
                if (currentUser.isAdmin) {
                    motoristaFilter.classList.remove('hidden');
                } else {
                    motoristaFilter.classList.add('hidden');
                    document.getElementById('filter-motorista').value = ''; // Garante que o filtro seja limpo
                }
                // ▲▲▲ FIM DA ADIÇÃO ▲▲▲

                // Busca e exibe os lançamentos do dia atual
                fetchAndRenderLancamentos();

                document.getElementById('lancamentos-modal').classList.remove('hidden');
            });

            document.getElementById('close-lancamentos-modal').addEventListener('click', () => {
                document.getElementById('lancamentos-modal').classList.add('hidden');
            });

            // O botão de filtro agora chama a nova função
            document.getElementById('filter-lancamentos-btn').addEventListener('click', fetchAndRenderLancamentos);


// SUBSTITUA O LISTENER INTEIRO POR ISTO:
            document.getElementById('lancamentos-table').addEventListener('click', async function (event) {
                const editButton = event.target.closest('.edit-lancamento-btn');
                const deleteButton = event.target.closest('.delete-lancamento-btn');

                // Se clicou no botão de editar, edita
                if (editButton) {
                    const lancamentoId = editButton.dataset.id;
                    openEditLancamentoModal(lancamentoId);
                    return; // Para a execução
                }

                // Se clicou no botão de excluir, exclui
                if (deleteButton) {
                    const lancamentoId = deleteButton.dataset.id;
                    if (confirm('Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.')) {
                        try {
                            const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', lancamentoId);
                            await deleteDoc(docRef);
                            showWarning('Lançamento excluído com sucesso!');
                            fetchAndRenderLancamentos(); 
                        } catch (error) {
                            console.error("Erro ao excluir lançamento:", error);
                            showWarning('Ocorreu um erro ao excluir o lançamento.');
                        }
                    }
                    return; // Para a execução
                }

                // Se não clicou em nenhum botão, significa que clicou na linha
                const row = event.target.closest('tr');
                if (row) {
                    // Pega o ID de edição a partir do botão escondido na linha
                    const rowEditButton = row.querySelector('.edit-lancamento-btn');
                    if (rowEditButton) {
                        const lancamentoId = rowEditButton.dataset.id;
                        openEditLancamentoModal(lancamentoId);
                    }
                }
            });

            // --- Lógica Solicitante/Destino Dinâmico (Modal de Edição) ---

            function updateEditDynamicLabels(containerId, inputName, baseLabel) {
                const rows = document.querySelectorAll(`#${containerId} .edit-dynamic-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const label = row.querySelector('label');
                    const input = row.querySelector('input');

                    if (label) {
                        label.textContent = `${baseLabel} (P${pNum}):`;
                    }

                    if (containerId === 'edit-solicitante-campos-container' && index === 0 && input) {
                        input.id = 'edit-solicitante-p1';
                    }

                    if (containerId === 'edit-destino-campos-container') {
                        const destinoLabel = row.querySelector('label[for^="edit-destino-"]');
                        const chegadaLabel = row.querySelector('label[for^="edit-chegada-destino-"]');
                        const destinoInput = row.querySelector('input[name="edit-destinos[]"]');
                        if (destinoLabel) destinoLabel.textContent = `Destino (P${pNum}):`;
                        if (chegadaLabel) chegadaLabel.textContent = `Chegada (P${pNum}):`;
                        if (index === 0) {
                            if (destinoInput) destinoInput.id = 'edit-destino-p1';
                        }
                    }

                    if (containerId === 'edit-valor-campos-container') {

                        const labelValor = row.querySelector('label[for^="edit-valor"]:not([for*="extra"])');
                        const labelValorExtra = row.querySelector('label[for*="extra"]');
                        const inputValor = row.querySelector('input[name="edit-valores[]"]');
                        const inputValorExtra = row.querySelector('input[name="edit-valores_extra[]"]');
                        if (labelValor) labelValor.textContent = pNum === 1 ?
                            'Valor P1:' : `Valor P${pNum}:`;
                        if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                        if (inputValor) inputValor.id = pNum === 1 ?
                            'edit-valor' : `edit-valor-${pNum}`;
                        if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'edit-valor-extra' : `edit-valor-extra-${pNum}`;
                        if (inputValor) formatCurrencyInput(inputValor);
                        if (inputValorExtra) formatCurrencyInput(inputValorExtra);
                    }

                    const removeBtn = row.querySelector('.remove-edit-dynamic-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updateEditDynamicLabels(containerId, inputName, baseLabel);
                                if (containerId === 'edit-destino-campos-container') {
                                    removeEditValueRow(pNum);
                                }
                            };
                        }
                    }
                });
            }

            function createEditDynamicInput(containerId, inputName, baseLabel, value = '') {
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row form-row-align';

                const index = Date.now();
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;

                fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="edit-${inputName}-${index}" class="block text-sm font-medium text-gray-700">${baseLabel} (P${pNum}):</label>
                    <input type="text" id="edit-${inputName}-${index}" name="edit-${inputName}s[]" value="${value}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                    -
                </button>
            `;
                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateEditDynamicLabels(containerId, inputName, baseLabel);
                    };
                }
                return fieldset;
            }

            function createEditDestinoChegadaInput(destinoValue = '', chegadaValue = '') {
                const containerId = 'edit-destino-campos-container';
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4';
                const index = Date.now();
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;
                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-destino-${index}" class="block text-sm font-medium text-gray-700">Destino (P${pNum}):</label>
                        <input type="text" id="edit-destino-${index}" name="edit-destinos[]" value="${destinoValue}" list="locais-list"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-chegada-destino-${index}" class="block text-sm font-medium text-gray-700">Chegada (P${pNum}):</label>
                        <input type="time" id="edit-chegada-destino-${index}" name="edit-chegadas_destino[]" value="${chegadaValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>
            `;
                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateEditDynamicLabels(containerId, 'destino', 'Destino');
                        removeEditValueRow(pNum);
                    };
                }
                return fieldset;
            }


            function createEditValorInput(pNum, valorValue = '0,00', valorExtraValue = '0,00') {
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4 valor-row';
                fieldset.dataset.pNum = pNum;

                const labelValor = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                const labelValorExtra = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                const inputIdValor = pNum === 1 ? 'edit-valor' : `edit-valor-${pNum}`;
                const inputIdValorExtra = pNum === 1 ? 'edit-valor-extra' : `edit-valor-extra-${pNum}`;
                fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="edit-valores[]" value="${valorValue}"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg text-right">
                    </div>
                </div>
                <div>
                    <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValorExtra}" name="edit-valores_extra[]" value="${valorExtraValue}"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg text-right">
                    </div>
                </div>
            `;
                const valorInput = fieldset.querySelector('input[name="edit-valores[]"]');
                const valorExtraInput = fieldset.querySelector('input[name="edit-valores_extra[]"]');
                if (valorInput) {
                    valorInput.addEventListener('input', () => formatCurrencyInput(valorInput));
                    valorInput.addEventListener('blur', () => { if (valorInput.value === '') valorInput.value = '0,00'; });
                }
                if (valorExtraInput) {
                    valorExtraInput.addEventListener('input', () => formatCurrencyInput(valorExtraInput));
                    valorExtraInput.addEventListener('blur', () => { if (valorExtraInput.value === '') valorExtraInput.value = '0,00'; });
                }
                return fieldset;
            }

            function removeEditValueRow(pNumToRemove) {
                const rowToRemove = document.querySelector(`#edit-valor-campos-container .valor-row[data-p-num="${pNumToRemove}"]`);
                if (rowToRemove) {
                    rowToRemove.remove();
                    updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');
                }
            }

            function addEditDynamicRow(containerId, inputName, baseLabel, value = '', value2 = null, value3 = 0, value4 = 0) {
                const container = document.getElementById(containerId);
                let newRow;
                if (inputName === 'destino') {
                    newRow = createEditDestinoChegadaInput(value, value2);
                } else if (inputName === 'solicitante') {
                    newRow = createEditDynamicInput(containerId, inputName, baseLabel, value);
                } else if (inputName === 'valor') {
                    const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                    const valorFmt = (value || 0).toFixed(2).replace('.', ',');
                    const valorExtraFmt = (value2 || 0).toFixed(2).replace('.', ',');
                    newRow = createEditValorInput(pNum, valorFmt, valorExtraFmt);
                }

                if (newRow) {
                    container.appendChild(newRow);
                    updateEditDynamicLabels(containerId, inputName, baseLabel);
                }
            }

            document.getElementById('add-edit-solicitante-btn').addEventListener('click', () => addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante'));
            document.getElementById('add-edit-destino-btn').addEventListener('click', () => addEditDynamicRow('edit-destino-campos-container', 'destino', 'Destino', '', ''));
            document.getElementById('add-edit-valor-btn').addEventListener('click', () => addEditDynamicRow('edit-valor-campos-container', 'valor', 'Valor', 0, 0));
            document.getElementById('add-edit-origem-btn').addEventListener('click', () => {
                const container = document.getElementById('edit-origem-campos-container');
                container.appendChild(createEditOrigemInput());
            });

            function updateEditPassageiroLabels() {
                const container = document.getElementById('edit-passageiros-extras-container');
                const p1REInput = document.getElementById('edit-re');
                const p1NomeInput = document.getElementById('edit-transportado');
                const p1RELabel = p1REInput.previousElementSibling;
                const p1NomeLabel = p1NomeInput.previousElementSibling;
                if (p1RELabel) p1RELabel.textContent = `RE (P1):`;
                if (p1NomeLabel) p1NomeLabel.textContent = `Transportado (P1):`;

                const extraRows = container.querySelectorAll('.edit-passageiro-row');
                extraRows.forEach((row, index) => {
                    const pNum = index + 2;
                    const reLabel = row.querySelector('label');
                    const transportadoLabel = row.querySelector('.flex-grow label');
                    const removeBtn = row.querySelector('.remove-edit-passageiro-btn');
                    if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                    if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`;
                    if (removeBtn) removeBtn.dataset.pNum = pNum;
                });
            }

            function createEditPassageiroInput(pNum, reValue = '', nomeValue = '') {
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4';
                fieldset.dataset.pNum = pNum;
                const isP1 = pNum === 1;
                fieldset.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700">RE (P${pNum}):</label>
                    <input type="text" name="edit-res[]" list="transportados-re-list" value="${reValue}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">Transportado (P${pNum}):</label>
                        <input type="text" name="edit-transportados[]" list="transportados-nome-list" value="${nomeValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-passageiro-btn ${isP1 ? 'hidden' : ''}" data-p-num="${pNum}">-</button>
                </div>
            `;
                const reInput = fieldset.querySelector('input[name="edit-res[]"]');
                const nomeInput = fieldset.querySelector('input[name="edit-transportados[]"]');
                if (reInput && nomeInput) {
                    reInput.addEventListener('blur', () => handleAutofillDynamic(reInput, nomeInput, 're'));
                    nomeInput.addEventListener('blur', () => handleAutofillDynamic(nomeInput, reInput, 'nome'));
                }
                const removeBtn = fieldset.querySelector('.remove-edit-passageiro-btn');
                if (removeBtn) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateEditPassageiroLabels();
                        checkEditPassageiroDuplicidade();
                    };
                }
                return fieldset;
            }


            function addEditPassageiroRow(re = '', nome = '') {
                const extrasContainer = document.getElementById('edit-passageiros-extras-container');
                const currentRows = extrasContainer.querySelectorAll('.edit-passageiro-row').length;
                const pNum = currentRows + 2;
                const newRow = createEditPassageiroInput(pNum, re, nome);
                extrasContainer.appendChild(newRow);
                updateEditPassageiroLabels();
            }

            document.getElementById('add-edit-passageiro-btn').addEventListener('click', () => addEditPassageiroRow());

            async function openEditLancamentoModal(id) {
                let lancamento;
                try {
                    // Busca o lançamento específico no banco de dados pelo ID
                    const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        lancamento = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        showWarning("Lançamento não encontrado. A lista pode estar desatualizada.");
                        return;
                    }
                } catch (error) {
                    console.error("Erro ao buscar lançamento para edição:", error);
                    showWarning("Erro ao carregar os dados do lançamento.");
                    return;
                }

                if (!lancamento) return;

                // O restante da função continua exatamente como antes
                document.getElementById('edit-lancamento-id').value = id;
                document.getElementById('edit-data').value = lancamento.data;
                document.getElementById('edit-bordero').value = lancamento.bordero || '';
                document.getElementById('edit-observacao').value = lancamento.observacao || '';
                const editOrigemContainer = document.getElementById('edit-origem-campos-container');
                editOrigemContainer.innerHTML = ''; // Limpa o container
                editOrigemContainer.appendChild(createEditOrigemInput(lancamento.origem || '', lancamento.partida || ''));
                if (lancamento.origens_extras && lancamento.origens_extras.length > 0) {
                    lancamento.origens_extras.forEach(o => {
                        editOrigemContainer.appendChild(createEditOrigemInput(o.origem || '', o.partida || ''));
                    });
                }

                const motoristaInput = document.getElementById('edit-motorista');
                motoristaInput.value = lancamento.motorista;
                if (!currentUser.isAdmin) {
                    motoristaInput.setAttribute('readonly', 'readonly');
                    motoristaInput.classList.add('bg-gray-200');
                } else {
                    motoristaInput.removeAttribute('readonly');
                    motoristaInput.classList.remove('bg-gray-200');
                }

                const editSolicitanteContainer = document.getElementById('edit-solicitante-campos-container');
                editSolicitanteContainer.innerHTML = '';
                addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante', lancamento.solicitante || '');
                if (lancamento.solicitantes_extras && lancamento.solicitantes_extras.length > 0) {
                    lancamento.solicitantes_extras.forEach((s) => {
                        addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante', s);
                    });
                }
                updateEditDynamicLabels('edit-solicitante-campos-container', 'solicitante', 'Solicitante');

                const editDestinoContainer = document.getElementById('edit-destino-campos-container');
                editDestinoContainer.innerHTML = '';
                const destinosParaEdicao = [{ destino: lancamento.destino || '', chegada: lancamento.chegada_destino || '' }];
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(d => destinosParaEdicao.push({ destino: d.destino || '', chegada: d.chegada || '' }));
                }
                destinosParaEdicao.forEach(d => {
                    addEditDynamicRow('edit-destino-campos-container', 'destino', 'Destino', d.destino, d.chegada);
                });

                const editValorContainer = document.getElementById('edit-valor-campos-container');
                editValorContainer.innerHTML = '';
                const valoresParaEdicao = [{ valor: lancamento.valor || 0, valorExtra: lancamento.valorExtra || 0 }];
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(d => valoresParaEdicao.push({ valor: d.valor || 0, valorExtra: d.valorExtra || 0 }));
                }
                valoresParaEdicao.forEach((v, index) => {
                    const pNum = index + 1;
                    const valorFmt = (v.valor || 0).toFixed(2).replace('.', ',');
                    const valorExtraFmt = (v.valorExtra || 0).toFixed(2).replace('.', ',');
                    const newRow = createEditValorInput(pNum, valorFmt, valorExtraFmt);
                    editValorContainer.appendChild(newRow);
                });
                updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');

                document.getElementById('edit-re').value = lancamento.re || '';
                document.getElementById('edit-transportado').value = lancamento.transportado || '';
                const extrasContainer = document.getElementById('edit-passageiros-extras-container');
                extrasContainer.innerHTML = '';
                if (lancamento.passageiros_extras && lancamento.passageiros_extras.length > 0) {
                    lancamento.passageiros_extras.forEach((p) => {
                        addEditPassageiroRow(p.re, p.nome);
                    });
                }
                updateEditPassageiroLabels();
                document.getElementById('edit-lancamento-modal').classList.remove('hidden');
            }
            function setupEditModalAutofill() {
                const modal = document.getElementById('edit-lancamento-modal');
                modal.addEventListener('blur', (event) => {
                    const input = event.target;

                    const isPassengerField = input.id === 'edit-re' || input.id === 'edit-transportado' ||
                        input.matches('input[name="edit-res[]"]') || input.matches('input[name="edit-transportados[]"]');

                    if (isPassengerField) {
                        let reInput, nomeInput;

                        if (input.id === 'edit-re' || input.id === 'edit-transportado') {
                            reInput = document.getElementById('edit-re');
                            nomeInput = document.getElementById('edit-transportado');
                        } else {
                            const row = input.closest('.edit-passageiro-row');
                            reInput = row.querySelector('input[name="edit-res[]"]');
                            nomeInput = row.querySelector('input[name="edit-transportados[]"]');
                        }

                        if (reInput && nomeInput) {
                            if (input === reInput) {
                                handleAutofillDynamic(reInput, nomeInput, 're');
                            } else if (input === nomeInput) {
                                handleAutofillDynamic(nomeInput, reInput, 'nome');
                            }
                        }

                        setTimeout(() => checkEditPassageiroDuplicidade(), 50);
                    }
                }, true);
            }
            setupEditModalAutofill();

            document.getElementById('close-edit-lancamento-modal').addEventListener('click', () => {
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
            });
            document.getElementById('edit-lancamento-form').addEventListener('submit', async function (event) {
                event.preventDefault();

                if (checkEditPassageiroDuplicidade()) {
                    showWarning('Corrija os passageiros duplicados antes de salvar.');
                    return;
                }
                const solicitantesEdit = Array.from(document.querySelectorAll('#edit-solicitante-campos-container input[name="edit-solicitantes[]"]'))
                    .map(input => input.value.trim()).filter(value => value !== '');

                const p1RE = document.getElementById('edit-re').value.trim();
                const p1Nome = document.getElementById('edit-transportado').value.trim();
                if (!p1RE || !p1Nome) {
                    showWarning('O passageiro principal (P1) deve ter RE e nome preenchidos.');
                    return;
                }
                const resExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-res[]"]')).map(input => input.value.trim());
                const nomesExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-transportados[]"]')).map(input => input.value.trim());
                const passageirosExtras = resExtras.map((re, i) => ({ re: re, nome: nomesExtras[i] })).filter(p => p.re && p.nome);
                const destinosInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-destinos[]"]');
                const chegadasInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-chegadas_destino[]"]');
                const valoresInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores[]"]');
                const valoresExtraInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores_extra[]"]');
                const destinosArray = [];
                destinosInputs.forEach((destinoInput, i) => {
                    const destino = destinoInput.value.trim();
                    const chegada = chegadasInputs[i] ? chegadasInputs[i].value.trim() : '';
                    if (destino || chegada) {
                        destinosArray.push({ destino, chegada });
                    }
                });

                const valoresArray = [];
                valoresInputs.forEach((valorInput, i) => {
                    const valor = parseCurrencyValue(valorInput.value);
                    const valorExtra = valoresExtraInputs[i] ? parseCurrencyValue(valoresExtraInputs[i].value) : 0;
                    valoresArray.push({ valor, valorExtra });
                });

                // ...
                const id = document.getElementById('edit-lancamento-id').value;
                // ... (código para coletar solicitantes, passageiros, etc.)

                // 1. PRIMEIRO, COLETAMOS OS DADOS DA ORIGEM (MOVIDO PARA CÁ)
                const origensEditInputs = document.querySelectorAll('#edit-origem-campos-container input[name="edit-origens[]"]');
                const partidasEditInputs = document.querySelectorAll('#edit-origem-campos-container input[name="edit-partidas[]"]');
                const origensEdit = [];
                origensEditInputs.forEach((input, i) => {
                    const origem = input.value.trim();
                    const partida = partidasEditInputs[i] ? partidasEditInputs[i].value.trim() : '';
                    if (origem || partida) {
                        origensEdit.push({ origem, partida });
                    }
                });

                // 2. DEPOIS, CRIAMOS O OBJETO USANDO OS DADOS COLETADOS
                const updatedData = {
                    motorista: document.getElementById('edit-motorista').value,
                    data: document.getElementById('edit-data').value,
                    bordero: document.getElementById('edit-bordero').value.trim(),
                    observacao: document.getElementById('edit-observacao').value,
                    editedBy: currentUser.username,
                    editedAt: serverTimestamp(),
                    solicitante: solicitantesEdit[0] || '',
                    solicitantes_extras: solicitantesEdit.slice(1),
                    re: p1RE,
                    transportado: p1Nome,
                    passageiros_extras: passageirosExtras,

                    // Campos de Origem Corrigidos
                    origem: origensEdit.length > 0 ? origensEdit[0].origem : '',
                    partida: origensEdit.length > 0 ? origensEdit[0].partida : '',
                    origens_extras: origensEdit.slice(1),

                    // Campos de Destino
                    destino: destinosArray.length > 0 ? destinosArray[0].destino : '',
                    chegada_destino: destinosArray.length > 0 ? destinosArray[0].chegada : '',

                    // Campos de Valor
                    valor: valoresArray.length > 0 ? valoresArray[0].valor : 0,
                    valorExtra: valoresArray.length > 0 ? valoresArray[0].valorExtra : 0,
                    destinos_extras: [], // Será preenchido abaixo
                };

                const totalExtras = Math.max(destinosArray.length, valoresArray.length) - 1;
                if (totalExtras > 0) {
                    for (let i = 1; i <= totalExtras; i++) {
                        const destinoInfo = destinosArray[i] || { destino: '', chegada: '' };
                        const valorInfo = valoresArray[i] || { valor: 0, valorExtra: 0 };
                        if (destinoInfo.destino || valorInfo.valor > 0 || valorInfo.valorExtra > 0) {
                            updatedData.destinos_extras.push({
                                destino: destinoInfo.destino,
                                chegada: destinoInfo.chegada,
                                valor: valorInfo.valor,
                                valorExtra: valorInfo.valorExtra
                            });
                        }
                    }
                }

                const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', id);
                await updateDoc(docRef, updatedData);
                showWarning('Lançamento atualizado com sucesso!');
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
                fetchAndRenderLancamentos();
            });

// SUBSTITUA A FUNÇÃO 'renderTransportadosList' INTEIRA
            function renderTransportadosList() {
                const tableBody = document.querySelector('#transportados-table tbody');
                tableBody.innerHTML = '';
                transportadosData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';
                    // Armazena o ID e os dados originais na própria linha
                    row.dataset.id = item.id;
                    row.dataset.re = item.re;
                    row.dataset.nome = item.nome;

                    row.innerHTML = `
                        <td class="px-6 py-4">${item.re}</td>
                        <td class="px-6 py-4">${item.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center flex justify-center gap-4">
                            <button class="edit-transportado-btn text-blue-600 hover:text-blue-900" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="delete-transportado-btn text-red-600 hover:text-red-900" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                            
                            <button class="save-transportado-btn text-green-600 hover:text-green-900 hidden" title="Salvar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="cancel-transportado-btn text-gray-600 hover:text-gray-900 hidden" title="Cancelar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                populateTransportadosDatalist();
            }

            // ATUALIZADO para usar 'usersData'
            // ATUALIZADO para usar 'usersData' e adicionar botão de redefinir senha
            function renderMotoristasList() {
                const tableBody = document.querySelector('#motoristas-table tbody');
                const tableHead = document.querySelector('#motoristas-table thead tr');

                // Adiciona o cabeçalho "Ações" se ainda não existir
                if (!tableHead.querySelector('.th-actions')) {
                    tableHead.innerHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider th-actions">Ações</th>`;
                }

                tableBody.innerHTML = '';
                usersData.forEach(item => {
                    // Não mostra o botão para o próprio admin logado
                    const disableButton = item.username === currentUser.username;
                    const buttonHtml = disableButton ?
                        `<span class="text-gray-400 text-sm">Próprio Usuário</span>` :
                        `<button data-id="${item.id}" data-username="${item.username}" class="reset-password-btn text-yellow-600 hover:text-yellow-900 font-semibold">Redefinir Senha</button>`;

                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';
                    row.innerHTML = `
                    <td class="p-4"><input type="checkbox" data-id="${item.id}" class="motorista-checkbox rounded-sm"></td>
                    <td class="px-6 py-4">${item.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${buttonHtml}</td>
                `;
                    tableBody.appendChild(row);
                });
            }

            function populateTransportadosDatalist() {
                const reDatalist = document.querySelector('#transportados-re-list') || document.createElement('datalist');
                reDatalist.id = 'transportados-re-list';
                const nomeDatalist = document.querySelector('#transportados-nome-list') || document.createElement('datalist');
                nomeDatalist.id = 'transportados-nome-list';
                if (!document.body.contains(reDatalist)) document.body.appendChild(reDatalist);
                if (!document.body.contains(nomeDatalist)) document.body.appendChild(nomeDatalist);
                reDatalist.innerHTML = '';
                nomeDatalist.innerHTML = '';
                transportadosData.forEach(item => {
                    reDatalist.innerHTML += `<option value="${item.re}">`;
                    nomeDatalist.innerHTML += `<option value="${item.nome}">`;
                });
            }

            // ATUALIZADO para usar 'usersData'
            function populateMotoristasDatalist() {
                const datalist = document.getElementById('motoristas-list');
                datalist.innerHTML = '';
                usersData.forEach(item => datalist.innerHTML += `<option value="${item.nome}">`);
            }

// SUBSTITUA A FUNÇÃO 'add-transportado' INTEIRA POR ISTO:
            document.getElementById('add-transportado').addEventListener('click', async () => {
                const newRE = document.getElementById('new-re').value.trim();
                const newNome = document.getElementById('new-nome').value.trim();

                if (!newRE || !newNome) {
                    showWarning('Preencha o RE e nome.');
                    return;
                }

                const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');

                try {
                    // 1. Gasta 1 leitura para verificar NO BANCO se o RE já existe
                    const q = query(transportadosRef, where("re", "==", newRE));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        // Se a consulta NÃO voltou vazia, o RE já existe
                        showWarning(`Erro: A Matrícula (RE) "${newRE}" já está cadastrada. Atualize a página para recarregar a lista.`);
                        return;
                    }

                    // 2. Se voltou vazia, o RE é novo. Podemos adicionar.
                    const newDoc = await addDoc(transportadosRef, { re: newRE, nome: newNome });
                    
                    // 3. Adiciona na lista local (transportadosData) para o autocomplete funcionar
                    transportadosData.push({ re: newRE, nome: newNome, id: newDoc.id });
                    rebuildTransportadosLookups(); // Rebói a lista e o autocomplete

                    document.getElementById('new-re').value = '';
                    document.getElementById('new-nome').value = '';
                    showWarning('Transportado adicionado com sucesso. Atualize a página para recarregar a lista.');

                } catch (error) {
                    console.error("Erro ao adicionar transportado:", error);
                    showWarning('Erro ao conectar com o banco de dados.');
                }
            });

// --- COLE ESTA NOVA FUNÇÃO ABAIXO DE 'populateMotoristasDatalist' ---
            function populateMotoristasFilterDropdown() {
                const select = document.getElementById('filter-motorista');
                if (!select) return; // Se o elemento não existir, para aqui
                
                // Guarda a opção "Todos" e limpa o resto
                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);

                // Adiciona cada motorista da lista global
                usersData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.nome;
                    option.textContent = item.nome;
                    select.appendChild(option);
                });
            }


            // LÓGICA DE ADICIONAR MOTORISTA ATUALIZADA
            document.getElementById('add-motorista').addEventListener('click', async () => {
                const nome = document.getElementById('new-motorista-nome').value.trim();
                const username = document.getElementById('new-motorista-username').value.trim().toLowerCase();
                const password = document.getElementById('new-motorista-password').value.trim();
                const isAdmin = document.getElementById('new-motorista-is-admin').checked;

                if (nome && username && password) {
                    const existingUser = usersData.find(user => user.username === username);
                    if (existingUser) {
                        showWarning('Este nome de usuário já existe.');
                        return;
                    }

                    const newUser = {
                        nome: nome,
                        username: username,
                        password: password, // Lembre-se do aviso de segurança!
                        is_admin: isAdmin,
                        is_motorista_fixo: true
                    };

                    await addDoc(collection(db, 'users'), newUser);

                    document.getElementById('new-motorista-nome').value = '';
                    document.getElementById('new-motorista-username').value = '';
                    document.getElementById('new-motorista-password').value = '';
                    document.getElementById('new-motorista-is-admin').checked = false;

                    showWarning('Novo usuário/motorista adicionado com sucesso!');
                } else {
                    showWarning('Preencha todos os campos: Nome, Usuário e Senha.');
                }
            });

            // LÓGICA DE EXCLUIR MOTORISTA ATUALIZADA
            document.getElementById('delete-selected-motoristas').addEventListener('click', async () => {
                const checkboxes = document.querySelectorAll('#motoristas-table .motorista-checkbox:checked');
                if (checkboxes.length === 0) {
                    showWarning('Selecione ao menos um motorista.');
                    return;
                }
                // Usa a coleção 'users'
                const promises = Array.from(checkboxes).map(cb => deleteDoc(doc(db, 'users', cb.dataset.id)));
                await Promise.all(promises);
                showWarning(`${checkboxes.length} usuários/motoristas excluídos.`);
            });

            // --- Eventos de UI restantes ---
            document.getElementById('close-modal').addEventListener('click', hideWarning);

// NOVO LISTENER PARA A TABELA DE TRANSPORTADOS (EDITAR/SALVAR/CANCELAR/DELETAR)
            document.getElementById('transportados-table').addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const row = button.closest('tr');
                const id = row.dataset.id;

                // --- AÇÃO: CLICOU EM EDITAR (LÁPIS) ---
                if (button.classList.contains('edit-transportado-btn')) {
                    const reCell = row.cells[0];
                    const nomeCell = row.cells[1];
                    const currentRE = row.dataset.re;
                    const currentNome = row.dataset.nome;

                    // Transforma em inputs
                    reCell.innerHTML = `<input type="text" value="${currentRE}" class="w-full border border-blue-500 rounded px-1 py-0.5">`;
                    nomeCell.innerHTML = `<input type="text" value="${currentNome}" class="w-full border border-blue-500 rounded px-1 py-0.5">`;

                    // Alterna os botões
                    row.querySelector('.edit-transportado-btn').classList.add('hidden');
                    row.querySelector('.delete-transportado-btn').classList.add('hidden');
                    row.querySelector('.save-transportado-btn').classList.remove('hidden');
                    row.querySelector('.cancel-transportado-btn').classList.remove('hidden');
                }

                // --- AÇÃO: CLICOU EM CANCELAR (X) ---
                if (button.classList.contains('cancel-transportado-btn')) {
                    // Reverte para o texto original
                    row.cells[0].innerHTML = row.dataset.re;
                    row.cells[1].innerHTML = row.dataset.nome;

                    // Alterna os botões
                    row.querySelector('.edit-transportado-btn').classList.remove('hidden');
                    row.querySelector('.delete-transportado-btn').classList.remove('hidden');
                    row.querySelector('.save-transportado-btn').classList.add('hidden');
                    row.querySelector('.cancel-transportado-btn').classList.add('hidden');
                }

                // --- AÇÃO: CLICOU EM EXCLUIR (LIXEIRA) ---
                if (button.classList.contains('delete-transportado-btn')) {
                    if (confirm(`Tem certeza que deseja excluir "${row.dataset.nome}"?`)) {
                        try {
                            await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'transportados', id));
                            
                            // Remove da lista local e reconstrói
                            const index = transportadosData.findIndex(item => item.id === id);
                            if (index > -1) transportadosData.splice(index, 1);
                            rebuildTransportadosLookups();
                            
                            showWarning('Transportado excluído com sucesso.');
                            // Não precisa de onSnapshot, apenas remove a linha da tela
                            row.remove(); 
                        } catch (error) {
                            showWarning('Erro ao excluir transportado.');
                        }
                    }
                }

                // --- AÇÃO: CLICOU EM SALVAR (CHECK) ---
                if (button.classList.contains('save-transportado-btn')) {
                    const reInput = row.cells[0].querySelector('input');
                    const nomeInput = row.cells[1].querySelector('input');
                    const newRE = reInput.value.trim();
                    const newNome = nomeInput.value.trim();

                    if (!newRE || !newNome) {
                        showWarning("RE e Nome não podem estar vazios.");
                        return;
                    }

                    // Verifica se o RE mudou
                    if (newRE !== row.dataset.re) {
                        // Se mudou, precisamos verificar se o NOVO RE já existe
                        const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                        const q = query(transportadosRef, where("re", "==", newRE));
                        const querySnapshot = await getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            showWarning(`Erro: A Matrícula (RE) "${newRE}" já pertence a outro transportado.`);
                            return;
                        }
                    }

                    // Se a validação passou, salva no banco
                    try {
                        const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'transportados', id);
                        await updateDoc(docRef, {
                            re: newRE,
                            nome: newNome
                        });

                        // Atualiza a lista local e reconstrói o autocomplete
                        const index = transportadosData.findIndex(item => item.id === id);
                        if (index > -1) {
                            transportadosData[index].re = newRE;
                            transportadosData[index].nome = newNome;
                        }
                        rebuildTransportadosLookups();

                        // Atualiza os dados da linha e reverte para o modo de visualização
                        row.dataset.re = newRE;
                        row.dataset.nome = newNome;
                        row.cells[0].innerHTML = newRE;
                        row.cells[1].innerHTML = newNome;

                        row.querySelector('.edit-transportado-btn').classList.remove('hidden');
                        row.querySelector('.delete-transportado-btn').classList.remove('hidden');
                        row.querySelector('.save-transportado-btn').classList.add('hidden');
                        row.querySelector('.cancel-transportado-btn').classList.add('hidden');
                        
                        showWarning('Transportado atualizado com sucesso.');

                    } catch (error) {
                        showWarning('Erro ao salvar as alterações.');
                    }
                }
            });
            
            document.getElementById('open-transportados-modal').addEventListener('click', () => {
                // Reconstrói a lista com a ordenação atual toda vez que abre
                rebuildTransportadosLookups(
                    document.getElementById('sort-transportados-key').value, 
                    document.getElementById('sort-transportados-order').value
                );
                // Mostra o modal
                document.getElementById('transportados-modal').classList.remove('hidden');
            });

            document.getElementById('close-transportados-modal').addEventListener('click', () => document.getElementById('transportados-modal').classList.add('hidden'));
            document.getElementById('open-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.remove('hidden'));
            document.getElementById('close-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.add('hidden'));
            
            // A linha abaixo estava faltando a "função" ao redor dela
            document.getElementById('sort-transportados-key').addEventListener('change', function () {
                rebuildTransportadosLookups(this.value, document.getElementById('sort-transportados-order').value);
            });
            
            // Esta função também estava faltando no seu print
            document.getElementById('sort-transportados-order').addEventListener('change', function () {
                rebuildTransportadosLookups(document.getElementById('sort-transportados-key').value, this.value);
            });
            document.getElementById('sort-motoristas-order').addEventListener('change', function () {
                rebuildMotoristasLookups(this.value);
            });
            // --- LÓGICA DOS BOTÕES DE PREENCHIMENTO AUTOMÁTICO ---
            document.getElementById('fill-partidas-btn').addEventListener('click', () => {
                const partidaInputs = document.querySelectorAll('input[name="partidas[]"]');
                if (partidaInputs.length < 2) return; // Só faz sentido se houver mais de um campo

                const firstPartidaValue = partidaInputs[0].value;
                if (!firstPartidaValue) {
                    showWarning('Preencha o primeiro horário de partida para usar esta função.');
                    return;
                }

                for (let i = 1; i < partidaInputs.length; i++) {
                    partidaInputs[i].value = firstPartidaValue;
                }
            });

            document.getElementById('fill-chegadas-btn').addEventListener('click', () => {
                const chegadaInputs = document.querySelectorAll('input[name="chegadas_destino[]"]');
                if (chegadaInputs.length < 2) return; // Só faz sentido se houver mais de um campo

                const firstChegadaValue = chegadaInputs[0].value;
                if (!firstChegadaValue) {
                    showWarning('Preencha o primeiro horário de chegada para usar esta função.');
                    return;
                }

                for (let i = 1; i < chegadaInputs.length; i++) {
                    chegadaInputs[i].value = firstChegadaValue;
                }
            });

            // --- NOVA SUGESTÃO: RELATÓRIO EM LOTES (100% NO NAVEGADOR) ---

            // Função auxiliar para escapar valores para o formato CSV
            function escapeCsvValue(value) {
                if (value === null || value === undefined) return '';
                const stringValue = String(value);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                    return `"${stringValue.replace(/"/g, '""')}"`;
                }
                return stringValue;
            }

            // Função auxiliar para iniciar o download do arquivo
            function triggerCsvDownload(csvContent, filename) {
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); // Para garantir a codificação UTF-8 correta no Excel
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // --- LÓGICA DE RELATÓRIO ATUALIZADA PARA P4 ---
            async function handleDownloadCsvInBatches() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) {
                    showWarning('Por favor, selecione a data de início e a data de fim.');
                    return;
                }

                const button = document.getElementById('download-csv-detailed');
                const progressElement = document.getElementById('csv-progress');
                const originalText = button.textContent;

                button.disabled = true;
                progressElement.classList.remove('hidden');
                progressElement.textContent = 'Iniciando a busca...';
                let batchCounter = 1;

                try {
                    const BATCH_SIZE = 200;
                    let allCsvRows = [];
                    let lastVisibleDoc = null;
                    let totalProcessed = 0;

                    while (true) {
                        const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');

                        let q = query(
                            lancamentosRef,
                            where("data", ">=", startDate),
                            where("data", "<=", endDate),
                            orderBy("data"),
                            limit(BATCH_SIZE)
                        );

                        if (lastVisibleDoc) {
                            q = query(q, startAfter(lastVisibleDoc));
                        }

                        const querySnapshot = await getDocs(q);
                        const batchDocs = querySnapshot.docs;

                        if (batchDocs.length === 0) break;

                        const batchRows = batchDocs.map(doc => {
                            const item = doc.data();

                            // Mapeia todos os dados extras de P2, P3 e P4
                            const s2 = item.solicitantes_extras?.[0] || '';
                            const s3 = item.solicitantes_extras?.[1] || '';
                            const s4 = item.solicitantes_extras?.[2] || '';

                            const p2 = item.passageiros_extras?.[0]?.nome || '';
                            const p3 = item.passageiros_extras?.[1]?.nome || '';
                            const p4 = item.passageiros_extras?.[2]?.nome || '';

                            const o2 = item.origens_extras?.[0]?.origem || '';
                            const o3 = item.origens_extras?.[1]?.origem || '';
                            const o4 = item.origens_extras?.[2]?.origem || '';

                            const pa2 = item.origens_extras?.[0]?.partida || '';
                            const pa3 = item.origens_extras?.[1]?.partida || '';
                            const pa4 = item.origens_extras?.[2]?.partida || '';

                            const dest2 = item.destinos_extras?.[0]?.destino || '';
                            const ch2 = item.destinos_extras?.[0]?.chegada || '';
                            const val2 = item.destinos_extras?.[0]?.valor?.toFixed(2).replace('.', ',') || '0,00';
                            const valEx2 = item.destinos_extras?.[0]?.valorExtra?.toFixed(2).replace('.', ',') || '0,00';

                            const dest3 = item.destinos_extras?.[1]?.destino || '';
                            const ch3 = item.destinos_extras?.[1]?.chegada || '';
                            const val3 = item.destinos_extras?.[1]?.valor?.toFixed(2).replace('.', ',') || '0,00';
                            const valEx3 = item.destinos_extras?.[1]?.valorExtra?.toFixed(2).replace('.', ',') || '0,00';

                            const dest4 = item.destinos_extras?.[2]?.destino || '';
                            const ch4 = item.destinos_extras?.[2]?.chegada || '';
                            const val4 = item.destinos_extras?.[2]?.valor?.toFixed(2).replace('.', ',') || '0,00';
                            const valEx4 = item.destinos_extras?.[2]?.valorExtra?.toFixed(2).replace('.', ',') || '0,00';

                            // Constrói a linha na ordem exata até P4
                            const rowData = [
                                item.data, item.motorista, item.bordero, item.solicitante, item.transportado,
                                item.origem, item.partida, item.destino, item.chegada_destino,
                                item.valor?.toFixed(2).replace('.', ',') || '0,00',
                                item.valorExtra?.toFixed(2).replace('.', ',') || '0,00',
                                s2, p2, o2, pa2, dest2, ch2, val2, valEx2, // Dados P2
                                s3, p3, o3, pa3, dest3, ch3, val3, valEx3, // Dados P3
                                s4, p4, o4, pa4, dest4, ch4, val4, valEx4  // Dados P4
                            ];
                            return rowData.map(escapeCsvValue).join(';');
                        });

                        allCsvRows.push(...batchRows);

                        totalProcessed += batchDocs.length;
                        progressElement.textContent = `Processando lote ${batchCounter}... ${totalProcessed} registros encontrados.`;
                        batchCounter++;

                        lastVisibleDoc = batchDocs[batchDocs.length - 1];
                        if (batchDocs.length < BATCH_SIZE) break;
                    }

                    if (allCsvRows.length === 0) {
                        showWarning('Nenhum lançamento encontrado para o período selecionado.');
                        return;
                    }

                    // Define os cabeçalhos na ordem exata até P4
                    const headers = [
                        'data', 'motorista', 'bordero', 'solicitante', 'passageiros', 'origem', 'partida',
                        'destino', 'chegada', 'valor', 'valor extra',
                        'solicitante (P2)', 'passageiro (P2)', 'origem (P2)', 'partida (P2)', 'destino (P2)', 'chegada (P2)', 'valor (P2)', 'valor extra (P2)',
                        'solicitante (P3)', 'passageiro (P3)', 'origem (P3)', 'partida (P3)', 'destino (P3)', 'chegada (P3)', 'valor (P3)', 'valor extra (P3)',
                        'solicitante (P4)', 'passageiro (P4)', 'origem (P4)', 'partida (P4)', 'destino (P4)', 'chegada (P4)', 'valor (P4)', 'valor extra (P4)'
                    ].join(';');

                    const csvContent = [headers, ...allCsvRows].join('\n');
                    const filename = `relatorio_completo_${startDate}_a_${endDate}.csv`;

                    progressElement.textContent = 'Gerando arquivo para download...';
                    triggerCsvDownload(csvContent, filename);

                } catch (error) {
                    console.error("Erro ao gerar relatório CSV:", error);
                    showWarning("Ocorreu um erro ao gerar o relatório.");
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                    progressElement.classList.add('hidden');
                }
            }

            // Associa a nova função ao botão de relatório completo
            document.getElementById('download-csv-detailed').addEventListener('click', handleDownloadCsvInBatches);

// --- NOVA FUNÇÃO: FECHAR MODAIS COM "ESC" ---
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    // Lista de todos os seus modais
                    const modalIds = [
                        'transportados-modal',
                        'motoristas-modal',
                        'lancamentos-modal',
                        'edit-lancamento-modal',
                        'message-modal', // O modal de aviso
                        'change-password-modal',
                        'reset-password-modal'
                    ];

                    modalIds.forEach(id => {
                        const modal = document.getElementById(id);
                        if (modal && !modal.classList.contains('hidden')) {
                            modal.classList.add('hidden');
                        }
                    });

                    // Também fecha a caixa de autocomplete
                    closeAllAutocompleteLists();
                }
            });


        </script>
    </body>

    </html>

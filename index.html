<index.html>
    <html lang="pt-BR">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Lançamento de Corridas</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');    
                    

            body {
                font-family: 'Inter', sans-serif;
                background-color: #f3f4f6;
            }

            .error-border {
                border-color: #ef4444 !important;
            }

            /* Style for table rows to show pointer */
            tr {
                cursor: pointer;
            }

            /* Make sure modals fit on smaller screens */
            .modal-content {
                width: 95%;
                max-width: 48rem;
                /* Equivalent to max-w-2xl */
            }

            @media (min-width: 640px) {
                .modal-content {
                    width: 100%;
                }
            }

            /* Custom style for larger modal */
            .modal-lg {
                max-width: 80rem;
                /* max-w-6xl */
            }

            /* Custom style to align form elements */
            .form-row-align {
                display: flex;
                align-items: flex-end;
                gap: 0.5rem;
            }

            .form-row-align .flex-grow {
                min-width: 0;
                /* Allow flex item to shrink */
            }

            /* ESTILOS PARA A CAIXA DE AUTOCOMPLETAR */
            .autocomplete-items {
                position: absolute;
                border: 1px solid #d1d5db;
                border-bottom: none;
                border-top: none;
                z-index: 99;
                top: 100%;
                left: 0;
                right: 0;
                background-color: #ffffff;
                border-radius: 0 0 0.5rem 0.5rem;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
                max-height: 200px;
                overflow-y: auto;
            }

            .autocomplete-items div {
                padding: 0.75rem;
                cursor: pointer;
                border-bottom: 1px solid #e5e7eb;
            }

            .autocomplete-items div:hover {
                background-color: #e5e7eb;
            }

            .autocomplete-active {
                background-color: #3b82f6 !important;
                color: #ffffff;
            }
        </style>
    </head>

    <body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">
        <div id="login-page"
            class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200 hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6 md:mb-8">Login</h1>
            <form id="login-form" class="space-y-4">

                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuário:</label>
                    <input type="text" id="username" name="username"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">

                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha:</label>
                    <input type="password" id="password" name="password"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <button type="submit"
                    class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Entrar
                </button>
                <p id="login-message" class="text-red-500 text-sm text-center mt-2 hidden">Usuário ou senha inválidos.
                </p>

            </form>
        </div>

        <div id="app-page"
            class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-full md:max-w-5xl border border-gray-200 hidden">
            <div class="flex justify-between items-center mb-6 relative">
                <div class="flex-grow flex justify-center">

                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Lançamento de Corridas</h1>
                </div>
                <button id="logout-btn"
                    class="absolute top-0 right-0 px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400">Sair</button>
                <button id="open-change-password-btn"
                    class="absolute top-12 right-1 text-sm text-blue-600 hover:text-blue-800 hover:underline font-medium">
                    Alterar Senha
                </button>
            </div>

            <p id="user-id-display" class="text-sm text-transparent text-center mb-4"></p>

            <form id="form-corrida" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="motorista" class="block text-sm font-medium text-gray-700">Motorista:</label>
                        <input type="text" id="motorista" name="motorista" list="motoristas-list"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                        <datalist id="motoristas-list">
                        </datalist>
                    </div>
                </div>

                <div id="solicitante-campos-container" class="space-y-4">

                </div>

                <div class="md:col-span-2 flex justify-center md:justify-start">
                    <button type="button" id="add-solicitante-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Solicitante
                    </button>
                </div>


                <div id="passageiros-campos-container" class="md:col-span-2 grid grid-cols-1 gap-4 md:gap-6">
                    <input type="hidden" id="re" name="re">
                    <input type="hidden" id="transportado" name="transportado">
                </div>


                <div class="md:col-span-2 flex justify-center">
                    <button type="button" id="add-passageiro-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Passageiro
                    </button>

                </div>

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="data" class="block text-sm font-medium text-gray-700">Data:</label>
                        <input type="date" id="data" name="data" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>

                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="bordero" class="block text-sm font-medium text-gray-700">Nº Borderô:</label>
                        <input type="text" id="bordero" name="bordero"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
                <div id="origem-campos-container-wrapper" class="md:col-span-1 space-y-4">
                    <div id="origem-campos-container">
                    </div>
                    <div class="flex justify-center md:justify-start gap-2">
                        <button type="button" id="add-origem-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">
                            + Adicionar Outra Origem
                        </button>
                        <button type="button" id="fill-partidas-btn"
                            class="w-full md:w-auto px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg hover:bg-blue-200">
                            Preencher Partidas
                        </button>
                    </div>
                </div>

                <div id="destino-campos-container-wrapper" class="md:col-span-1 space-y-4">
                    <div id="destino-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                    </div>
                    <div class="flex justify-center md:justify-start gap-2">
                        <button type="button" id="add-destino-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300">
                            + Adicionar Outro Destino
                        </button>
                        <button type="button" id="fill-chegadas-btn"
                            class="w-full md:w-auto px-4 py-2 bg-blue-100 text-blue-800 font-medium rounded-lg hover:bg-blue-200">
                            Preencher Chegadas
                        </button>
                    </div>
                </div>

                <div id="valor-campos-container-wrapper" class="md:col-span-2 space-y-4">
                    <div id="valor-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                    </div>
                    <div class="flex justify-center md:justify-start">
                        <button type="button" id="add-valor-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Valor
                        </button>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label for="observacao" class="block text-sm font-medium text-gray-700">Observação:</label>
                    <textarea id="observacao" name="observacao" rows="4"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
                </div>

                <div class="md:col-span-2 flex justify-center mt-4">
                    <button type="submit"
                        class="w-full md:w-1/2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Salvar Lançamento
                    </button>
                </div>
            </form>


            <hr class="my-6 md:my-8 border-gray-300">

            <div id="csv-report-section" class="flex flex-col gap-4 mb-6 hidden">
                <h2 class="text-xl font-bold text-gray-800">Gerar Relatório CSV</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início:</label>
                        <input type="date" id="start-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim:</label>
                        <input type="date" id="end-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <button type="button" id="download-csv-detailed"
                        class="flex-1 px-6 py-3 bg-cyan-500 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-600 focus:outline-none focus:ring-4 focus:ring-cyan-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Gerar Relatório Completo
                    </button>
                   <button type="button" id="download-csv-drivers"
                        class="flex-1 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Gerar Relatório Total Motoristas
                    </button> 
                </div>
                <p id="csv-progress" class="text-center text-sm text-gray-600 mt-4 hidden"></p>
            </div>

            <hr class="my-6 md:my-8 border-gray-300">

            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button type="button" id="open-lancamentos-modal"
                    class="px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Gerenciar Lançamentos
                </button>

                <button type="button" id="open-transportados-modal"
                    class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Gerenciar Transportados
                </button>
                <button type="button" id="open-motoristas-modal"
                    class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out hidden">
                    Gerenciar Motoristas
                </button>
            </div>
        </div>

        <div id="transportados-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">

            <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Transportados</h2>
                    
                <div class="flex items-center gap-4">
                        
                        <button id="refresh-transportados-btn" title="Atualizar Lista" 
                            class="text-sm font-medium text-blue-600 hover:text-blue-800 hover:underline">
                            Atualizar
                        </button>
                        
                        <button id="close-transportados-modal"
                            class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                    <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                    <select id="sort-transportados-key"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="nome">Nome</option>
                        <option value="re">RE</option>
                    </select>
                    <select id="sort-transportados-order"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="asc">A-Z</option>
                        <option value="desc">Z-A</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                    <div>
                        <label for="new-re" class="block text-sm font-medium text-gray-700">Novo RE:</label>
                        <input type="text" id="new-re"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="new-nome" class="block text-sm font-medium text-gray-700">Novo Transportado:</label>
                        <input type="text" id="new-nome"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="button" id="add-transportado"
                        class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Adicionar
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full table-auto" id="transportados-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    RE</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/4">
                                    Nome</th>
                                <th scope="col"
                                    class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                </div>
        </div>

        <div id="motoristas-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Motoristas</h2>
                    <button id="close-motoristas-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                    <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                    <select id="sort-motoristas-order"
                        class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="asc">A-Z</option>
                        <option value="desc">Z-A</option>
                    </select>
                </div>

                <div class="border-t border-b border-gray-200 py-6 my-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Adicionar Novo Motorista/Usuário</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="new-motorista-nome" class="block text-sm font-medium text-gray-700">Nome do
                                Motorista:</label>
                            <input type="text" id="new-motorista-nome"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-motorista-username" class="block text-sm font-medium text-gray-700">Usuário
                                (login):</label>
                            <input type="text" id="new-motorista-username"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="new-motorista-password"
                                class="block text-sm font-medium text-gray-700">Senha:</label>
                            <input type="password" id="new-motorista-password"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-end">
                            <div class="flex items-center h-full">
                                <input type="checkbox" id="new-motorista-is-admin"
                                    class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                                <label for="new-motorista-is-admin" class="ml-2 block text-sm text-gray-900">É
                                    Administrador?</label>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="button" id="add-motorista"
                            class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700">
                            Adicionar Motorista
                        </button>
                    </div>
                </div>


                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full table-auto" id="motoristas-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col"
                                    class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllMotoristas" class="rounded-sm">
                                </th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-full">
                                    Nome</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-4">
                    <button type="button" id="delete-selected-motoristas"
                        class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700">
                        Excluir Selecionados
                    </button>
                </div>
            </div>
        </div>

        <div id="lancamentos-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content modal-lg max-h-[90vh] flex flex-col">
                <div class="flex justify-between items-center mb-4 relative">
                    <div class="flex-grow flex justify-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Lançamentos</h2>
                    </div>
                    <button id="close-lancamentos-modal"
                        class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="filter-date" class="block text-sm font-medium text-gray-700">Filtrar por
                            Data:</label>
                        <input type="date" id="filter-date"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>

                        <div id="motorista-filter-wrapper" class="hidden"> <label for="filter-motorista" class="block text-sm font-medium text-gray-700">Filtrar por
                            Motorista:</label>
                        <select id="filter-motorista"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                            <option value="">Todos os Motoristas</option>
                            </select>
                    </div>
                    <div class="flex items-end">
                        <button id="filter-lancamentos-btn"
                            class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Buscar
                            Lançamentos</button>
                    </div>
                </div>

                <div class="overflow-y-auto flex-grow">
                    <table class="min-w-full table-auto" id="lancamentos-table">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">
                                    ID</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Data</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Motorista</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nº Borderô</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Solicitante(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Transportado(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Origem</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Destino(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                     Bairro(s)</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Horário da Solicitação</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Valor Extra Total</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Observação</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="edit-lancamento-modal"
            class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4 relative">
                    <div class="flex-grow flex justify-center">
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Editar Lançamento</h2>
                    </div>
                    <button id="close-edit-lancamento-modal"
                        class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>

                <form id="edit-lancamento-form" class="space-y-4">
                    <input type="hidden" id="edit-lancamento-id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-motorista"
                                class="block text-sm font-medium text-gray-700">Motorista:</label>
                            <input type="text" id="edit-motorista" list="motoristas-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="edit-data" class="block text-sm font-medium text-gray-700">Data:</label>
                            <input type="date" id="edit-data"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-bordero" class="block text-sm font-medium text-gray-700">Nº
                                Borderô:</label>
                            <input type="text" id="edit-bordero"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div></div>
                        <div id="edit-solicitante-campos-container" class="space-y-4">
                        </div>
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-solicitante-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Solicitante
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="edit-re" class="block text-sm font-medium text-gray-700">RE
                                (P1):</label>
                            <input type="text" id="edit-re" name="edit-res[]" list="transportados-re-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label for="edit-transportado" class="block text-sm font-medium text-gray-700">Transportado
                                (P1):</label>
                            <input type="text" id="edit-transportado" name="edit-transportados[]"
                                list="transportados-nome-list"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div id="edit-passageiros-extras-container" class="space-y-4 grid grid-cols-1 gap-4">
                    </div>

                    <div>
                        <button type="button" id="add-edit-passageiro-btn"
                            class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Passageiro
                        </button>
                    </div>

                    <div id="edit-origem-campos-container" class="space-y-4">
                    </div>
                    <div class="flex justify-center md:justify-start">
                        <button type="button" id="add-edit-origem-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outra Origem
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="edit-destino-campos-container" class="md:col-span-2 space-y-4">
                        </div>
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-destino-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Outro Destino
                        </button>
                    </div>

                    <div id="edit-valor-campos-container" class="md:col-span-2 space-y-4">
                    </div>

                    <div class="md:col-span-2 flex justify-center md:justify-start">
                        <button type="button" id="add-edit-valor-btn"
                            class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                            + Adicionar Valor
                        </button>
                    </div>

                    <div>
                        <label for="edit-observacao" class="block text-sm font-medium text-gray-700">Observação:</label>
                        <textarea id="edit-observacao" rows="3"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                    </div>

                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-edit-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar
                            Alterações</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center"
            style="z-index: 60;">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Aviso</h2>
                <p id="message-content" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end">
                    <button id="close-modal"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
                </div>
            </div>
        </div>

        <div id="change-password-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Alterar Minha Senha</h2>
                    <button id="close-change-password-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <form id="change-password-form" class="space-y-4">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-700">Senha
                            Atual:</label>
                        <input type="password" id="current-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha:</label>
                        <input type="password" id="new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirmar Nova
                            Senha:</label>
                        <input type="password" id="confirm-new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="change-password-message" class="text-red-500 text-sm text-center hidden"></p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-change-password-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova
                            Senha</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="reset-password-modal"
            class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Redefinir Senha</h2>
                    <button id="close-reset-password-modal"
                        class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
                </div>
                <p class="mb-4">Redefinindo senha para o usuário: <strong id="reset-username-display"></strong></p>
                <form id="reset-password-form" class="space-y-4">
                    <input type="hidden" id="reset-user-id">
                    <div>
                        <label for="admin-new-password" class="block text-sm font-medium text-gray-700">Digite a Nova
                            Senha:</label>
                        <input type="password" id="admin-new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <p id="reset-password-message" class="text-red-500 text-sm text-center hidden"></p>
                    <div class="flex justify-end gap-4 pt-4">
                        <button type="button" id="cancel-reset-password-btn"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova
                            Senha</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="autocomplete-suggestions-container"></div>

        <datalist id="locais-list">
            <option value="Aldeias da Serra"></option>
            <option value="Altos da Borda"></option>
            <option value="Bairro Grama"></option>
            <option value="Boa Vista"></option>
            <option value="Borda da Mata"></option>
            <option value="Borda do Campo"></option>
            <option value="Caçapava"></option>
            <option value="Caçapava Velha"></option>
            <option value="Centro - Caçapava"></option>
            <option value="Centro - SJC"></option>
            <option value="Centro - Taubaté"></option>
            <option value="Chacara Bela Vista"></option>
            <option value="Chacara Ipes"></option>
            <option value="Chacara Santo Antonio"></option>
            <option value="Eldorado"></option>
            <option value="Germana"></option>
            <option value="Guaramirim"></option>
            <option value="Jardim Amalia"></option>
            <option value="Jardim Antonio Augusto"></option>
            <option value="Jardim Caçapava"></option>
            <option value="Jardim Campo Grande"></option>
            <option value="Jardim Maria Cândida"></option>
            <option value="Jardim Panorama"></option>
            <option value="Jardim Primavera"></option>
            <option value="Jardim Rafael"></option>
            <option value="Jardim São Jose"></option>
            <option value="Jardim São João"></option>
            <option value="Lot. Pedro Rizzo 1"></option>
            <option value="Maria Elmira"></option>
            <option value="Nova Caçapava"></option>
            <option value="NSG Group/KM 131"></option>
            <option value="NSG Group/KM 133"></option>
            <option value="Padre Marcelo"></option>
            <option value="Paiol"></option>
            <option value="Parque do Museu"></option>
            <option value="Perinho"></option>
            <option value="Pinus"></option>
            <option value="Pinus 2"></option>
            <option value="Portal Vila Rica"></option>
            <option value="Real Park"></option>
            <option value="Recreio Mantiqueira"></option>
            <option value="Residencial Esperança"></option>
            <option value="Residencial Jequitiba"></option>
            <option value="Rodovia de Caçapava"></option>
            <option value="Samambaia"></option>
            <option value="Sapé 1"></option>
            <option value="Sapé 2"></option>
            <option value="São José dos Campos"></option>
            <option value="Santa Monica"></option>
            <option value="Tatauba"></option>
            <option value="Taubaté"></option>
            <option value="Terras do Vale"></option>
            <option value="Tijuco Preto"></option>
            <option value="Vera Cruz"></option>
            <option value="Vila Andre Martins"></option>
            <option value="Vila Antonio Augusto"></option>
            <option value="Vila Bandeirantes"></option>
            <option value="Vila Favorino"></option>
            <option value="Vila Galvão"></option>
            <option value="Vila Menino Jesus"></option>
            <option value="Vila Paraiso"></option>
            <option value="Vila Quirino"></option>
            <option value="Vila Resende"></option>
            <option value="Vila Santa Isabel"></option>
            <option value="Vila São João"></option>
            <option value="Vila Velha"></option>
            <option value="Vila Velha 1"></option>
            <option value="Vila Velha 2 - Taubaté"></option>
            <option value="Village das Flores"></option>
            <option value="Vitoria Vale"></option>
        </datalist>

        <datalist id="solicitantes-list">
            <option value="Adriano da Silva Lopes"></option>
            <option value="Alex Augusto de Camargo"></option>
            <option value="Alex Sandro Ramos da Cruz"></option>
            <option value="Anderson de Oliveira Ferreira"></option>
            <option value="Augusto Gabriel Galhote Silva"></option>
            <option value="Cícero Vilaça de Sousa"></option>
            <option value="Clodoaldo Martins do Nascimento Junior"></option>
            <option value="Danilo Pavret Ramos"></option>
            <option value="Diomedes Guimarães Correa Jr."></option>
            <option value="Edmilson do Patrocínio"></option>
            <option value="Edson Luiz Galioti Vitorino"></option>
            <option value="Erick C. S. Toledo"></option>
            <option value="Evaldo Lucio de Alvarenga"></option>
            <option value="Fabio Rodrigues De Lima"></option>
            <option value="Felipe Egídio de Miranda"></option>
            <option value="Felipe Leite Pestana"></option>
            <option value="Glaucia Maria de Souza Farias"></option>
            <option value="Hudson Dias Gomes"></option>
            <option value="João Valdeci da Silva"></option>
            <option value="Kleber Batista dos Santos"></option>
            <option value="Luis Claudio Ramos"></option>
            <option value="Marcelo do Amaral"></option>
            <option value="Marcos Antonio Moreira"></option>
            <option value="Marcos Cid Pereta"></option>
            <option value="Marina Evangelista de Paula"></option>
            <option value="Mauricio Paulo da Silva"></option>
            <option value="Mauro Rocha dos Santos"></option>
            <option value="Moisés Vitorino dos Santos"></option>
            <option value="Natan Batista dos Santos Jr."></option>
            <option value="Rafael Camargo"></option>
            <option value="Rafael Florentino"></option>
            <option value="Raniere Da Silva Almeida"></option>
            <option value="Ricardo Beltrame Rocha"></option>
            <option value="Rodrigo Américo Araújo"></option>
            <option value="Rodrigo Peretta Carneiro"></option>
            <option value="Rudge Nunes de Assis"></option>
            <option value="Titilo Prado"></option>
            <option value="Wagner Bonelli"></option>
            <option value="William Rodrigues Watanabe"></option>
        </datalist>        

        <script type="module">

            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, addDoc, deleteDoc, onSnapshot, collection, doc, query, where, getDocs, getDoc, updateDoc, serverTimestamp, orderBy, limit, startAfter, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDmqvcKtIsga4ZQWNDg4_2k493dqMQCDVg",
                authDomain: "teste-ebf38.firebaseapp.com",
                projectId: "teste-ebf38",
                storageBucket: "teste-ebf38.firebasestorage.app",
                messagingSenderId: "741884776297",
                appId: "1:741884776297:web:a23450b4909581a1b237f8",
                measurementId: "G-2MD5CFD51E"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);

            try {
                await enableIndexedDbPersistence(db);
                console.log("Persistência offline habilitada!");
            } catch (err) {
                if (err.code == 'failed-precondition') {
                    console.warn("Persistência offline falhou: múltiplas abas abertas.");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistência offline não suportada neste navegador.");
                }
            }

            const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let currentUser = {
                username: null,
                isAdmin: false,
            };




            const precoLookup = {

                "NOVA CAÇAPAVA": { base: 32.00, plus4: 38.00 },
                "VITORIA VALE": { base: 32.00, plus4: 38.00 },
                "BORDA DA MATA": { base: 32.00, plus4: 38.00 },
                "ALTOS DA BORDA": { base: 32.00, plus4: 38.00 },
                "BORDA DO CAMPO": { base: 32.00, plus4: 38.00 },
                "SAPÉ 2": { base: 32.00, plus4: 38.00 },
                "JARDIM MARIA CÂNDIDA": { base: 32.00, plus4: 38.00 },
                "MARIA ELMIRA": { base: 32.00, plus4: 38.00 },
                "VILA SANTA ISABEL": { base: 32.00, plus4: 38.00 },
                "BAIRRO GRAMA": { base: 32.00, plus4: 38.00 },
                "RESIDENCIAL ESPERANÇA": { base: 32.00, plus4: 38.00 },
                "TERRAS DO VALE": { base: 32.00, plus4: 38.00 },
                "VILLAGE DAS FLORES": { base: 32.00, plus4: 38.00 },
                "JARDIM PRIMAVERA": { base: 32.00, plus4: 38.00 },
                "JARDIM AMALIA": { base: 32.00, plus4: 38.00 },
                "JARDIM CAMPO GRANDE": { base: 32.00, plus4: 38.00 },
                "VILA SÃO JOÃO": { base: 32.00, plus4: 38.00 },
                "VILA RESENDE": { base: 32.00, plus4: 38.00 },
                "CENTRO": { base: 32.00, plus4: 38.00 },
                "RODOVIA DE CAÇAPAVA": { base: 32.00, plus4: 38.00 },
                "VERA CRUZ": { base: 32.00, plus4: 38.00 },
                "VILA GALVÃO": { base: 32.00, plus4: 38.00 },
                "JARDIM CAÇAPAVA": { base: 32.00, plus4: 38.00 },
                "VILA ANTONIO AUGUSTO": { base: 32.00, plus4: 38.00 },
                "VILA PARAISO": { base: 32.00, plus4: 38.00 },
                "PARQUE DO MUSEU": { base: 32.00, plus4: 38.00 },
                "JARDIM RAFAEL": { base: 32.00, plus4: 38.00 },
                "JARDIM SÃO JOSE": { base: 32.00, plus4: 38.00 },
                "VILA PANTALEÃO": { base: 32.00, plus4: 38.00 },

                "ALDEIAS DA SERRA": { base: 35.00, plus4: 40.00 },
                "CHACARA IPES": { base: 35.00, plus4: 40.00 },
                "JARDIM PANORAMA": { base: 35.00, plus4: 40.00 },
                "ELDORADO": { base: 35.00, plus4: 40.00 },
                "REAL PARK": { base: 35.00, plus4: 40.00 },
                "RESIDENCIAL JEQUITIBA": { base: 35.00, plus4: 40.00 },
                "VILA QUIRINO": { base: 35.00, plus4: 40.00 },
                "VILA ANDRE MARTINS": { base: 35.00, plus4: 40.00 },
                "CHACARA SANTO ANTONIO": { base: 35.00, plus4: 40.00 },
                "VILA MENINO JESUS": { base: 35.00, plus4: 40.00 },

                "CAÇAPAVA VELHA": { base: 41.00, plus4: 45.00 },
                "GERMANA": { base: 41.00, plus4: 45.00 },
                "VILA VELHA": { base: 41.00, plus4: 45.00 },
                "VILA VELHA 2 - TAUBATE": { base: 41.00, plus4: 45.00 },
                "TIJUCO PRETO": { base: 41.00, plus4: 45.00 },
                "PORTAL VILA RICA": { base: 41.00, plus4: 45.00 },
                "SAPÉ 1": { base: 41.00, plus4: 45.00 },
                "CHACARA BELA VISTA": { base: 41.00, plus4: 45.00 },
                "GUARAMIRIM": { base: 41.00, plus4: 45.00 },
                "LOT. PEDRO RIZZO 1": { base: 41.00, plus4: 45.00 },
                "PADRE MARCELO": { base: 41.00, plus4: 45.00 },
                "PAIOL": { base: 41.00, plus4: 45.00 },
                "VILA FAVORINO": { base: 41.00, plus4: 45.00 },
                "PERINHO": { base: 41.00, plus4: 45.00 },
                "TATAUBA": { base: 41.00, plus4: 45.00 },
                "PINUS": { base: 41.00, plus4: 45.00 },
                "PINUS 2": { base: 41.00, plus4: 45.00 },
                "BOA VISTA": { base: 41.00, plus4: 45.00 },
                "RECREIO MANTIQUEIRA": { base: 41.00, plus4: 45.00 },
                "SANTA MONICA": { base: 41.00, plus4: 45.00 },
                "PIEDADE": { base: 41.00, plus4: 45.00 },

                "CIDADE TAUBATÉ": { base: 53.00, plus4: 53.00 },
                "CIDADE JACAREI": { base: 71.00, plus4: 71.00 },
                "CIDADE TREMEMBÉ": { base: 73.00, plus4: 73.00 },
                "CIDADE SJC - (EUG.MELO)": { base: 32.00, plus4: 32.00 },
                "CIDADE SJC - (GB)": { base: 32.00, plus4: 32.00 },               
                "CIDADE SJC - CENTRAL": { base: 45.00, plus4: 45.00 },
                "CIDADE SJC - EXTREMOS (LONGES)": { base: 60.00, plus4: 60.00 },
                "CIDADE DE PINDAMONHAGABA": { base: 75.00, plus4: 75.00 }
            };

            let masterLocaisList = [];

            function normalizeString(str) {
                if (!str) return '';
                return str.trim().toUpperCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Remove acentos
                    .replace(/Ç/g, "C"); // Converte Ç para C
            }




function updateValoresAutomaticamente(formId) {
                const formElement = document.getElementById(formId);
                if (!formElement) return;


                let totalPassageiros = 0;
                if (formId === 'edit-lancamento-form') {

                    const p1Input = formElement.querySelector('#edit-re');
                    const extraRows = formElement.querySelectorAll('.edit-passageiro-row');
                    

                    const p1TemRE = p1Input && p1Input.value.trim() !== '';
                    totalPassageiros = (p1TemRE ? 1 : 0) + extraRows.length;

                } else {

                    const passageiroRows = formElement.querySelectorAll('.passageiro-row');
                    totalPassageiros = 0;

                    passageiroRows.forEach(row => {
                        const reInput = row.querySelector('input[name="res[]"]');
                        if (reInput && reInput.value.trim() !== '') {
                            totalPassageiros++;
                        }
                    });
                }
                
                const usePlus4Price = totalPassageiros >= 4;

                // REVERTIDO: Container do Bairro está no 'destino'
                const destinoContainerId = formId === 'edit-lancamento-form' ? 'edit-destino-campos-container' : 'destino-campos-container';
                const valorContainerId = formId === 'edit-lancamento-form' ? 'edit-valor-campos-container' : 'valor-campos-container';
                
                // REVERTIDO: O 'bairroRow' não existe mais, pegamos tudo do 'destinoRows'
                const destinoRows = formElement.querySelectorAll(`#${destinoContainerId} .dynamic-row, #${destinoContainerId} .edit-dynamic-row`);
                const valorRows = formElement.querySelectorAll(`#${valorContainerId} .valor-row, #${valorContainerId} .edit-dynamic-row`);




                const precosJaPreenchidos = new Set();
                

                const normalizedPrecoLookup = new Map();
                Object.keys(precoLookup).forEach(key => {
                    normalizedPrecoLookup.set(normalizeString(key), precoLookup[key]);
                });


                destinoRows.forEach((destinoRow, index) => {
                    // REVERTIDO: Bairro é pego da linha de Destino
                    const destinoInput = destinoRow.querySelector('input[name*="destinos"]');
                    const bairroInput = destinoRow.querySelector('input[name*="bairros"]');
                    
                    const valorRow = valorRows[index];
                    if (!valorRow) return; 
                    
                    const valorInput = valorRow.querySelector('input[name*="valores[]"]');
                    if (!valorInput) return;


                    const destinoValNorm = normalizeString(destinoInput ? destinoInput.value : '');
                    const bairroValNorm = normalizeString(bairroInput ? bairroInput.value : '');

                    let precoInfo = null;
                    

                    if (bairroValNorm && normalizedPrecoLookup.has(bairroValNorm)) {
                        precoInfo = normalizedPrecoLookup.get(bairroValNorm);
                    } else if (!precoInfo && destinoValNorm && normalizedPrecoLookup.has(destinoValNorm)) {

                        precoInfo = normalizedPrecoLookup.get(destinoValNorm);
                    }

                    // ▼▼▼ LÓGICA ATUALIZADA AQUI ▼▼▼
                    if (precoInfo) {
                        const precoFinal = usePlus4Price ? precoInfo.plus4 : precoInfo.base;
                        
                        if (!precosJaPreenchidos.has(precoFinal)) {
                            valorInput.value = precoFinal.toFixed(2).replace('.', ',');
                            valorInput.classList.remove('error-border');
                            precosJaPreenchidos.add(precoFinal);
                        }
                    } else {
                        // NOVO: Se não achou preço (campo vazio ou não existe), limpa o valor
                        valorInput.value = '0,00';
                        valorInput.classList.remove('error-border');
                    }
                    // ▲▲▲ FIM DA LÓGICA ▲▲▲
                    
                    valorInput.readOnly = false;
                    valorInput.classList.remove('bg-gray-200');
                });

            }


            const loginForm = document.getElementById('login-form');
            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');
            const loginMessage = document.getElementById('login-message');
            const userIdDisplay = document.getElementById('user-id-display');
            const logoutButton = document.getElementById('logout-btn');
            const motoristaInput = document.getElementById('motorista');
            const openMotoristasBtn = document.getElementById('open-motoristas-modal');
            const passageirosContainer = document.getElementById('passageiros-campos-container');
            const addPassageiroBtn = document.getElementById('add-passageiro-btn');
            const downloadCsvDetailedBtn = document.getElementById('download-csv-detailed');
            const csvReportDiv = document.getElementById('csv-report-section');
            const solicitanteContainer = document.getElementById('solicitante-campos-container');
            const addSolicitanteBtn = document.getElementById('add-solicitante-btn');
            const destinoContainer = document.getElementById('destino-campos-container');
            const addDestinoBtn = document.getElementById('add-destino-btn');
            const valorContainer = document.getElementById('valor-campos-container');
            const addValorBtn = document.getElementById('add-valor-btn');
            const editValorBtn = document.getElementById('add-edit-valor-btn');
            const openChangePasswordBtn = document.getElementById('open-change-password-btn');
            const changePasswordModal = document.getElementById('change-password-modal');
            const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal');
            const cancelChangePasswordBtn = document.getElementById('cancel-change-password-btn');
            const changePasswordForm = document.getElementById('change-password-form');
            const changePasswordMessage = document.getElementById('change-password-message');
            const resetPasswordModal = document.getElementById('reset-password-modal');
            const closeResetPasswordModalBtn = document.getElementById('close-reset-password-modal');
            const cancelResetPasswordBtn = document.getElementById('cancel-reset-password-btn');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const resetPasswordMessage = document.getElementById('reset-password-message');
            const motoristasTable = document.getElementById('motoristas-table');



            openChangePasswordBtn.addEventListener('click', () => {
                changePasswordForm.reset();
                changePasswordMessage.classList.add('hidden');
                changePasswordModal.classList.remove('hidden');
            });

            const closeChangePasswordModal = () => {
                changePasswordModal.classList.add('hidden');
            };

            closeChangePasswordModalBtn.addEventListener('click', closeChangePasswordModal);
            cancelChangePasswordBtn.addEventListener('click', closeChangePasswordModal);

            changePasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                changePasswordMessage.classList.add('hidden');

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;


                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    changePasswordMessage.innerText = 'Todos os campos são obrigatórios.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    changePasswordMessage.innerText = 'A nova senha e a confirmação não correspondem.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }


                const storedUserData = JSON.parse(localStorage.getItem('loggedInUserData'));
                if (storedUserData.password !== currentPassword) {
                    changePasswordMessage.innerText = 'A senha atual está incorreta.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }

                if (newPassword === currentPassword) {
                    changePasswordMessage.innerText = 'A nova senha deve ser diferente da atual.';
                    changePasswordMessage.classList.remove('hidden');
                    return;
                }


                try {
                    const userDocRef = doc(db, 'users', storedUserData.id);
                    await updateDoc(userDocRef, {
                        password: newPassword
                    });


                    const updatedUserData = { ...storedUserData, password: newPassword };
                    localStorage.setItem('loggedInUserData', JSON.stringify(updatedUserData));

                    showWarning('Senha alterada com sucesso!');
                    closeChangePasswordModal();

                } catch (error) {
                    console.error("Erro ao atualizar senha:", error);
                    changePasswordMessage.innerText = 'Erro ao conectar com o servidor.';
                    changePasswordMessage.classList.remove('hidden');
                }
            });




            motoristasTable.addEventListener('click', (event) => {
                const resetButton = event.target.closest('.reset-password-btn');
                if (resetButton) {
                    const userId = resetButton.dataset.id;
                    const username = resetButton.dataset.username;

                    resetPasswordForm.reset();
                    resetPasswordMessage.classList.add('hidden');
                    document.getElementById('reset-user-id').value = userId;
                    document.getElementById('reset-username-display').innerText = username;
                    resetPasswordModal.classList.remove('hidden');
                }
            });

            const closeResetPasswordModal = () => {
                resetPasswordModal.classList.add('hidden');
            };

            closeResetPasswordModalBtn.addEventListener('click', closeResetPasswordModal);
            cancelResetPasswordBtn.addEventListener('click', closeResetPasswordModal);

            resetPasswordForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                resetPasswordMessage.classList.add('hidden');

                const userId = document.getElementById('reset-user-id').value;
                const newPassword = document.getElementById('admin-new-password').value;

                if (!newPassword) {
                    resetPasswordMessage.innerText = 'O campo de nova senha é obrigatório.';
                    resetPasswordMessage.classList.remove('hidden');
                    return;
                }

                try {
                    const userDocRef = doc(db, 'users', userId);
                    await updateDoc(userDocRef, {
                        password: newPassword
                    });
                    showWarning(`Senha do usuário foi redefinida com sucesso!`);
                    closeResetPasswordModal();
                } catch (error) {
                    console.error("Erro ao redefinir a senha:", error);
                    resetPasswordMessage.innerText = 'Erro ao conectar com o servidor.';
                    resetPasswordMessage.classList.remove('hidden');
                }
            });


            let transportadosData = [];
            let usersData = []; // Substituído motoristasData por usersData
            let lancamentosData = [];
            let reToNome = {};
            let nomeToRE = {};

            function rebuildTransportadosLookups(sortKey = 'nome', sortOrder = 'asc') {
                transportadosData.sort((a, b) => {
                    let valA = a[sortKey] || '';
                    let valB = b[sortKey] || '';
                    return sortOrder === 'asc' ? valA.localeCompare(valB, undefined, { numeric: true }) : valB.localeCompare(valA, undefined, { numeric: true });
                });
                reToNome = {};
                nomeToRE = {};
                transportadosData.forEach(item => {
                    reToNome[item.re] = item.nome;
                    nomeToRE[item.nome.toLowerCase()] = item.re;
                });
                renderTransportadosList();
            }

            function rebuildMotoristasLookups(sortOrder = 'asc') {
                usersData.sort((a, b) => sortOrder === 'asc' ? a.nome.localeCompare(b.nome) : b.nome.localeCompare(a.nome));
                renderMotoristasList();
                populateMotoristasDatalist();
                populateMotoristasFilterDropdown();
            }


            function showWarning(message) {
                document.getElementById('message-content').innerText = message;
                document.getElementById('message-modal').classList.remove('hidden');
            }

            function hideWarning() {
                document.getElementById('message-modal').classList.add('hidden');
            }


            function setMotoristaFromData(userData) {
                currentUser.username = userData.username;
                currentUser.isAdmin = userData.is_admin || false;
                currentUser.nome = userData.nome;
                userIdDisplay.classList.add('hidden'); // Oculta o ID antigo
                if (currentUser.isAdmin) {
                    openMotoristasBtn.classList.remove('hidden');
                    csvReportDiv.classList.remove('hidden'); // Mostra o botão de relatório para admins
                } else {
                    openMotoristasBtn.classList.add('hidden');
                    csvReportDiv.classList.add('hidden'); // Esconde o botão de relatório para não admins
                }

                if (userData.is_motorista_fixo) {
                    motoristaInput.value = userData.nome;
                    motoristaInput.setAttribute('readonly', 'readonly');
                    motoristaInput.classList.add('bg-gray-200');
                } else {
                    motoristaInput.removeAttribute('readonly');
                    motoristaInput.classList.remove('bg-gray-200');
                    motoristaInput.value = userData.nome || '';
                }
            }

            function checkPassageiroDuplicidade(sourceInput) {
                const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
                const row = sourceInput.closest('.passageiro-row');
                const currentREInput = row.querySelector('input[name="res[]"]');
                const currentNomeInput = row.querySelector('input[name="transportados[]"]');
                const currentRE = currentREInput.value.trim();
                const currentNome = currentNomeInput.value.trim();
                if (currentRE === '' || currentNome === '') {
                    currentREInput.classList.remove('error-border');
                    currentNomeInput.classList.remove('error-border');
                    return false;
                }

                const currentKey = `${currentRE}_${currentNome.toLowerCase()}`;
                let isDuplicated = false;

                rows.forEach(r => {
                    r.querySelector('input[name="res[]"]').classList.remove('error-border');
                    r.querySelector('input[name="transportados[]"]').classList.remove('error-border');
                });
                rows.forEach(rowToCheck => {
                    const rowRE = rowToCheck.querySelector('input[name="res[]"]').value.trim();
                    const rowNome = rowToCheck.querySelector('input[name="transportados[]"]').value.trim();
                    const rowKey = `${rowRE}_${rowNome.toLowerCase()}`;
                    const isSameRow = (rowToCheck === row);

                    if (rowKey === currentKey && !isSameRow) {
                        isDuplicated = true;
                        rowToCheck.querySelector('input[name="res[]"]').classList.add('error-border');
                        rowToCheck.querySelector('input[name="transportados[]"]').classList.add('error-border');
                    }
                });
                if (isDuplicated) {
                    currentREInput.classList.add('error-border');
                    currentNomeInput.classList.add('error-border');
                    showWarning(`Passageiro duplicado encontrado: RE ${currentRE} e Nome ${currentNome}.`);
                }

                return isDuplicated;
            }






            function closeAllAutocompleteLists() {
                const container = document.getElementById('autocomplete-suggestions-container');
                container.innerHTML = '';
            }

function showAutocompleteSuggestions(inputElement, filterType) {
                const val = inputElement.value;
                closeAllAutocompleteLists();
                if (!val) { // Busca a partir de 1 caractere
                    return false;
                }

                const container = document.getElementById('autocomplete-suggestions-container');
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.setAttribute('class', 'autocomplete-items');
                container.appendChild(suggestionsDiv);

                const rect = inputElement.getBoundingClientRect();
                container.style.position = 'absolute';
                container.style.left = `${rect.left + window.scrollX}px`;
                container.style.top = `${rect.bottom + window.scrollY}px`;
                container.style.width = `${rect.width}px`;

                const normalizedVal = normalizeString(val); // Normaliza a entrada do usuário
                let suggestions = [];

                if (filterType === 're' || filterType === 'nome') {
                    // Lógica original para Passageiros
                    const searchKey = filterType === 're' ? 're' : 'nome';
                    const normalizedInputForPassageiros = val.toLowerCase();
                    
                    suggestions = transportadosData
                        .filter(item => item[searchKey] && item[searchKey].toLowerCase().includes(normalizedInputForPassageiros))
                        .map(item => ({ item, display: `<strong>${item.re}</strong> - ${item.nome}` }));

                } else if (filterType === 'bairro' || filterType === 'origem' || filterType === 'destino') {
                    
                    // ▼▼▼ LÓGICA ATUALIZADA AQUI ▼▼▼
                    let sourceList = [];
                    const precoLocais = Object.keys(precoLookup); // Lista SÓ de locais com preço

                    if (filterType === 'bairro') {
                        // O campo "Bairro" SÓ vai sugerir locais da lista de preços
                        sourceList = precoLocais;
                        
                    } else {
                        // "Origem" e "Destino" vão sugerir a lista completa
                        const datalistLocais = Array.from(document.querySelectorAll('#locais-list option')).map(opt => opt.value);
                        const combinedSet = new Set([...precoLocais, ...datalistLocais].filter(Boolean)); 
                        sourceList = Array.from(combinedSet); // A lista mestra completa
                    }
                    // ▲▲▲ FIM DA LÓGICA ATUALIZADA ▲▲▲

                    suggestions = sourceList
                        .filter(local => normalizeString(local).includes(normalizedVal))
                        .map(local => ({ item: { localName: local }, display: local }));
                }

                if (suggestions.length === 0) {
                    suggestionsDiv.innerHTML = '<div>Nenhum resultado.</div>';
                    return;
                }

                // Limita o número de sugestões
                suggestions.slice(0, 7).forEach(sug => {
                    const { item, display } = sug;
                    const suggestionItem = document.createElement('div');
                    suggestionItem.innerHTML = display;
                    
                    suggestionItem.addEventListener('click', function () {
                        if (filterType === 're' || filterType === 'nome') {
                            // Preenche RE e Nome para Passageiros
                            const parentRow = inputElement.closest('.passageiro-row, .edit-passageiro-row');
                            if (parentRow) {
                                const reInput = parentRow.querySelector('input[name*="res[]"]');
                                const nomeInput = parentRow.querySelector('input[name*="transportados[]"]');
                                if (reInput) reInput.value = item.re;
                                if (nomeInput) nomeInput.value = item.nome;
                                
                                if (parentRow.classList.contains('passageiro-row')) {
                                    setTimeout(() => checkPassageiroDuplicidade(inputElement), 50);
                                } else {
                                    setTimeout(() => checkEditPassageiroDuplicidade(), 50);
                                }
                            } else {
                                const p1RE = document.getElementById('edit-re');
                                const p1Nome = document.getElementById('edit-transportado');
                                if (p1RE && p1Nome) {
                                    p1RE.value = item.re;
                                    p1Nome.value = item.nome;
                                    setTimeout(() => checkEditPassageiroDuplicidade(), 50);
                                }
                            }
                            
                        } else if (filterType === 'bairro' || filterType === 'origem' || filterType === 'destino') {
                            // Preenche o campo de Bairro, Origem ou Destino
                            inputElement.value = item.localName;
                            
                            if (filterType === 'bairro' || filterType === 'destino') {
                                const formId = inputElement.closest('form').id;
                                updateValoresAutomaticamente(formId); 
                            }
                        }
                        
                        closeAllAutocompleteLists();
                    });
                    suggestionsDiv.appendChild(suggestionItem);
                });
            }

            function handleAutofillDynamic(sourceInput, targetInput, sourceType) {
                const value = sourceInput.value.trim();
                if (value !== '') {
                    let targetValue = '';
                    if (sourceType === 're') {
                        targetValue = reToNome[value];
                    } else if (sourceType === 'nome') {
                        targetValue = nomeToRE[value.toLowerCase()];
                    }

                    if (targetValue) {
                        targetInput.value = targetValue;
                        targetInput.classList.remove('error-border');
                    } else {
                        targetInput.value = '';
                    }
                } else {
                    targetInput.value = '';
                }

            }

/**
             * Verifica uma lista de passageiros e salva aqueles que não existem
             * na coleção principal 'transportados'.
             */
/**
             * Verifica uma lista de passageiros e salva aqueles que não existem
             * na coleção principal 'transportados', com verificação no servidor.
             */
            async function salvarNovosTransportados(passageiros) {
                if (!passageiros || passageiros.length === 0) return;

                const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                let novosAdicionados = 0;

                for (const p of passageiros) {
                    if (!p.re || !p.nome) continue; // Pula se dados incompletos


                    const reExistsLocal = transportadosData.some(item => item.re === p.re);
                    
                    if (!reExistsLocal) {
                        try {


                            const q = query(transportadosRef, where("re", "==", p.re));
                            const querySnapshot = await getDocs(q);


                            if (querySnapshot.empty) {
                                console.log(`Adicionando novo transportado: RE ${p.re}, Nome ${p.nome}`);
                                

                                const newDoc = await addDoc(transportadosRef, { re: p.re, nome: p.nome });
                                

                                transportadosData.push({ re: p.re, nome: p.nome, id: newDoc.id });
                                novosAdicionados++;
                            } else {


                                const docData = querySnapshot.docs[0].data();
                                transportadosData.push({ id: querySnapshot.docs[0].id, ...docData });
                                console.warn(`Conflito evitado: RE ${p.re} já existe no banco.`);
                            }

                        } catch (e) {
                            console.warn("Transportado já cadastado - Atualize a página para verificar novo transportado:", e);
                        }
                    }
                }

                if (novosAdicionados > 0) {

                    rebuildTransportadosLookups();
                    console.log(`${novosAdicionados} novo(s) transportado(s) salvo(s).`);
                }
            }



            function checkEditPassageiroDuplicidade() {
                const reSeen = new Map();
                let isDuplicated = false;


                const p1REInput = document.getElementById('edit-re');
                const p1NomeInput = document.getElementById('edit-transportado');
                const extraREInputs = document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-res[]"]');
                const extraNomeInputs = document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-transportados[]"]');


                const allPassengerInputs = [
                    { reInput: p1REInput, nomeInput: p1NomeInput }
                ];
                extraREInputs.forEach((reInput, i) => {
                    allPassengerInputs.push({ reInput: reInput, nomeInput: extraNomeInputs[i] });
                });
                

                allPassengerInputs.forEach(pair => {
                    pair.reInput.classList.remove('error-border');
                    pair.nomeInput.classList.remove('error-border');
                });


                allPassengerInputs.forEach(pair => {
                    const re = pair.reInput.value.trim();
                    const nome = pair.nomeInput.value.trim();

                    if (re === '') {

                        if (nome !== '') pair.reInput.classList.add('error-border');
                        return; 
                    }
                    
                    const key = re; // A chave agora é SÓ o RE

                    if (reSeen.has(key)) {
                        isDuplicated = true;

                        pair.reInput.classList.add('error-border');
                        pair.nomeInput.classList.add('error-border');


                        const firstSeenPair = reSeen.get(key);
                        firstSeenPair.reInput.classList.add('error-border');
                        firstSeenPair.nomeInput.classList.add('error-border');
                    } else {
                        reSeen.set(key, pair); // Armazena o par de inputs para marcar depois
                    }
                });

                if (isDuplicated) {
                    showWarning('Matrícula (RE) duplicada encontrada no formulário de edição.');
                }
                return isDuplicated;
            }

            function formatCurrencyInput(input) {
                if (!input) return;
                let value = input.value.replace(/\D/g, '');
                if (value === '') {
                    input.value = '0,00';
                    return;
                }
                value = value.padStart(3, '0');
                const integerPart = value.slice(0, -2);
                const decimalPart = value.slice(-2);
                const formattedInteger = parseInt(integerPart, 10).toLocaleString('pt-BR');
                input.value = `${formattedInteger},${decimalPart}`;
            }

            function parseCurrencyValue(value) {
                if (typeof value !== 'string' || value.trim() === '') return 0;
                return parseFloat(value.replace(/\./g, '').replace(',', '.'));
            }



            function updateDynamicLabels(containerId, inputName, baseLabel) {
                const rows = document.querySelectorAll(`#${containerId} .dynamic-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const label = row.querySelector('label');
                    const input = row.querySelector('input');

                    if (label) {
                        label.textContent = index === 0 ? baseLabel + ':' : `${baseLabel} (P${pNum}):`;
                    }

                    if (containerId === 'solicitante-campos-container' && index === 0 && input) {
                        input.id = 'solicitante';
                        input.name = 'solicitantes[]';
                    }
                    if (containerId === 'destino-campos-container' && index === 0) {
                        const destinoInput = row.querySelector('input[name="destinos[]"]');
                        if (destinoInput) destinoInput.id = 'destino';
                        const chegadaInput = row.querySelector('input[name="chegadas_destino[]"]');
                        if (chegadaInput) chegadaInput.id = 'chegada_destino_p1';
                    }

                    if (containerId === 'valor-campos-container') {
                        const valorInput = row.querySelector('input[name="valores[]"]');
                        const valorExtraInput = row.querySelector('input[name="valores_extra[]"]');

                        if (valorInput) {
                            valorInput.id = index === 0 ? 'valor' : `valor-${pNum}`;
                            valorInput.name = 'valores[]';
                            valorInput.classList.remove('error-border');
                            valorInput.addEventListener('input', () => formatCurrencyInput(valorInput));
                            valorInput.addEventListener('focus', () => { if (valorInput.value === '0,00') valorInput.value = ''; });
                            valorInput.addEventListener('blur', () => { if (valorInput.value === '') valorInput.value = '0,00'; });
                            if (valorInput.value === '') valorInput.value = '0,00';
                        }

                        if (valorExtraInput) {
                            valorExtraInput.id = index === 0 ? 'valor-extra' : `valor-extra-${pNum}`;
                            valorExtraInput.name = 'valores_extra[]';
                            valorExtraInput.classList.remove('error-border');
                            valorExtraInput.addEventListener('input', () => formatCurrencyInput(valorExtraInput));
                            valorExtraInput.addEventListener('focus', () => { if (valorExtraInput.value === '0,00') valorExtraInput.value = ''; });
                            valorExtraInput.addEventListener('blur', () => { if (valorExtraInput.value === '') valorExtraInput.value = '0,00'; });
                            if (valorExtraInput.value === '') valorExtraInput.value = '0,00';
                        }
                    }

                    const removeBtn = row.querySelector('.remove-dynamic-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updateDynamicLabels(containerId, inputName, baseLabel);
                            };
                        }
                    }
                });
            }

            function createSolicitanteInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row form-row-align';

                const pNum = document.querySelectorAll(`#solicitante-campos-container .dynamic-row`).length + 1;
                const labelText = isRequired ? 'Solicitante:' : `Solicitante (P${pNum}):`;
                fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="solicitante-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <input type="text" id="solicitante-${index}" name="solicitantes[]"
                        list="solicitantes-list"
                        onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                    -
                </button>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('solicitante-campos-container', 'solicitante', 'Solicitante');
                    };
                }
                return fieldset;
            }

function createDestinoInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                // Alterado de volta para 3 colunas
                fieldset.className = 'dynamic-row grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6';
                fieldset.dataset.pNum = (document.querySelectorAll(`#destino-campos-container .dynamic-row`).length + 1);

                const pNum = fieldset.dataset.pNum;
                const labelText = isRequired ? 'Destino:' : `Destino (P${pNum}):`;
                const labelTime = isRequired ? 'Chegada (Horário):' : `Chegada (P${pNum}):`;
                const labelBairro = isRequired ? 'Bairro:' : `Bairro (P${pNum}):`; // <-- BAIRRO VOLTA PARA CÁ

                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="destino-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                        <input type="text" id="destino-${index}" name="destinos[]" autocomplete="off"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="chegada-destino-${index}" class="block text-sm font-medium text-gray-700">${labelTime}</label>
                        <input type="time" id="chegada-destino-${index}" name="chegadas_destino[]"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="bairro-${index}" class="block text-sm font-medium text-gray-700">${labelBairro}</label>
                        <input type="text" id="bairro-${index}" name="bairros[]"
                            autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                        -
                    </button>
                </div>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('destino-campos-container', 'destino', 'Destino');
                        updateValoresAutomaticamente('form-corrida'); // Recalcula
                    };
                }
                return fieldset;
            }

            function createValorInput(pNum, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6 valor-row';
                fieldset.dataset.pNum = pNum;
                const isP1 = pNum === 1;
                const labelValor = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                const labelValorExtra = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                const inputIdValor = pNum === 1 ? 'valor' : `valor-${pNum}`;
                const inputIdValorExtra = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
                fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="valores[]"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out text-right">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                        <div class="relative mt-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                            <input type="text" id="${inputIdValorExtra}" name="valores_extra[]"
                                class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:focus:border-blue-500 transition duration-150 ease-in-out text-right">
                        </div>
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-valor-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
            `;

                const removeBtn = fieldset.querySelector('.remove-valor-btn');
                if (removeBtn && !isP1) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateValueLabels();
                    };
                }
                return fieldset;
            }

function createOrigemInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6';
                const pNum = document.querySelectorAll(`#origem-campos-container .dynamic-row`).length + 1;
                const labelOrigem = isRequired ? 'Origem:' : `Origem (P${pNum}):`;
                const labelPartida = isRequired ? 'Horário da Solicitação:' : `Horário da Solicitação (P${pNum}):`;

                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">${labelOrigem}</label>
                        <input type="text" name="origens[]" autocomplete="off" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">${labelPartida}</label>
                        <input type="time" name="partidas[]" onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
            `;
                const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
                if (removeBtn && !isRequired) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateDynamicLabels('origem-campos-container', 'origem', 'Origem');
                    };
                }
                return fieldset;
            }

            function removeValueRow(pNumToRemove) {
                const rowToRemove = document.querySelector(`#valor-campos-container .valor-row[data-p-num="${pNumToRemove}"]`);
                if (rowToRemove) {
                    rowToRemove.remove();
                    updateValueLabels();
                }
            }

            function updateValueLabels() {
                const rows = document.querySelectorAll(`#valor-campos-container .valor-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    row.dataset.pNum = pNum;

                    const labelValor = row.querySelector(`label[for^="valor"]`);
                    const labelValorExtra = row.querySelector(`label[for^="valor-extra"]`);
                    const inputValor = row.querySelector('input[name="valores[]"]');
                    const inputValorExtra = row.querySelector('input[name="valores_extra[]"]');
                    const removeBtn = row.querySelector('.remove-valor-btn');

                    if (labelValor) labelValor.textContent = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                    if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                    if (inputValor) inputValor.id = pNum === 1 ? 'valor' : `valor-${pNum}`;
                    if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
                    if (removeBtn) {
                        if (pNum === 1) removeBtn.classList.add('hidden');
                        else removeBtn.classList.remove('hidden');
                    }

                    if (inputValor) {
                        inputValor.removeEventListener('input', formatCurrencyInput);
                        inputValor.addEventListener('input', () => formatCurrencyInput(inputValor));
                        inputValor.removeEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                        inputValor.addEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                        inputValor.removeEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                        inputValor.addEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                    }
                    if (inputValorExtra) {
                        inputValorExtra.removeEventListener('input', formatCurrencyInput);
                        inputValorExtra.addEventListener('input', () => formatCurrencyInput(inputValorExtra));
                        inputValorExtra.removeEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                        inputValorExtra.addEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                        inputValorExtra.removeEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                        inputValorExtra.addEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                    }
                });
            }

            function addDynamicRow(containerId, inputName, baseLabel, isRequired = false) {
                const container = document.getElementById(containerId);
                let newRow;

                if (inputName === 'destino') {
                    newRow = createDestinoInput(Date.now(), isRequired);
                } else if (inputName === 'solicitante') {
                    newRow = createSolicitanteInput(Date.now(), isRequired);
                } else if (inputName === 'valor') {
                    newRow = createValorInput(document.querySelectorAll(`#valor-campos-container .valor-row`).length + 1, false);
                } else if (inputName === 'origem') { // <-- NOVO CASO ADICIONADO
                    newRow = createOrigemInput(Date.now(), isRequired);
                }

                if (newRow) {
                    container.appendChild(newRow);
                    updateDynamicLabels(containerId, inputName, baseLabel);
                }
            }
            addValorBtn.addEventListener('click', () => addDynamicRow('valor-campos-container', 'valor', 'Valor', false));


            function updatePassageiroLabels() {
                const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const reLabel = row.querySelector(`label[for^="re-"]`);
                    const transportadoLabel = row.querySelector(`label[for^="transportado-"]`);

                    if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                    if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`;

                    const removeBtn = row.querySelector('.remove-passageiro-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updatePassageiroLabels();
                                updateValoresAutomaticamente('form-corrida');
                            };
                        }
                    }
                });
            }

function createEditOrigemInput(origemValue = '', partidaValue = '') {
                const containerId = 'edit-origem-campos-container';
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4';
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;
                const labelPartida = `Horário da Solicitação (P${pNum}):`;

                fieldset.innerHTML = `
            <div class="form-row-align">
                <div class="flex-grow">
                    <label class="block text-sm font-medium text-gray-700">Origem (P${pNum}):</label>
                    <input type="text" name="edit-origens[]" value="${origemValue}" autocomplete="off"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                    -
                </button>
            </div>
            <div class="form-row-align">
                <div class="flex-grow">
                    
                    <label class="block text-sm font-medium text-gray-700">${labelPartida}</label>
                    <input type="time" name="edit-partidas[]" value="${partidaValue}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
            </div>
        `;
                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => fieldset.remove();
                }
                return fieldset;
            }

            function createPassageiroInput(index, isRequired = true) {
                const fieldset = document.createElement('div');
                fieldset.className = 'passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 relative'; // Adicionamos a classe 'relative'
                fieldset.dataset.index = index;
                fieldset.innerHTML = `
                <div>
                    <label for="re-${index}" class="block text-sm font-medium text-gray-700">RE (P${index + 1}):</label>
                    <input type="text" id="re-${index}" name="res[]"
                        onfocus="this.classList.remove('error-border')"
                        autocomplete="off" 
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label for="transportado-${index}" class="block text-sm font-medium text-gray-700">Transportado (P${index + 1}):</label>
                        <input type="text" id="transportado-${index}" name="transportados[]"
                            onfocus="this.classList.remove('error-border')"
                            autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-passageiro-btn ${isRequired ? 'hidden' : ''}">
                    -
                    </button>
                </div>
            `;

                return fieldset;
            }

            function addPassageiroRow(isRequired = false) {
                const newIndex = Date.now();
                const newRow = createPassageiroInput(newIndex, isRequired);
                passageirosContainer.appendChild(newRow);
                updatePassageiroLabels();
                setTimeout(() => updateValoresAutomaticamente('form-corrida'), 50);
            }



window.onload = () => {
                const loggedInUserData = localStorage.getItem('loggedInUserData');
                if (loggedInUserData) {
                    try {
                        const userData = JSON.parse(loggedInUserData);
                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        setMotoristaFromData(userData); // Usa a nova função
                    } catch (e) {
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('loggedInUserData');
                        loginPage.classList.remove('hidden');
                        appPage.classList.add('hidden');
                    }
                } else {
                    loginPage.classList.remove('hidden');
                    appPage.classList.add('hidden');
                }

                addDynamicRow('origem-campos-container', 'origem', 'Origem', true);
                document.getElementById('add-origem-btn').addEventListener('click', () => addDynamicRow('origem-campos-container', 'origem', 'Origem', false));

function bindPassageiroListeners(passageirosContainer, destinoContainer, origemContainer) {
                passageirosContainer.addEventListener('input', (event) => {
                    const input = event.target;
                    if (input.matches('input[name="res[]"]')) {
                        showAutocompleteSuggestions(input, 're');
                    } else if (input.matches('input[name="transportados[]"]')) {
                        showAutocompleteSuggestions(input, 'nome');
                    }
                });

                // ATUALIZADO: Listener para BAIRROS e DESTINOS
                destinoContainer.addEventListener('input', (event) => {
                    const input = event.target;
                    if (input.matches('input[name="bairros[]"]')) {
                        showAutocompleteSuggestions(input, 'bairro');
                    } else if (input.matches('input[name="destinos[]"]')) { // <-- ADICIONADO
                        showAutocompleteSuggestions(input, 'destino');
                    }
                });
                
                // NOVO LISTENER para ORIGENS no form principal
                origemContainer.addEventListener('input', (event) => {
                    const input = event.target;
                    if (input.matches('input[name="origens[]"]')) { // <-- ADICIONADO
                        showAutocompleteSuggestions(input, 'origem');
                    }
                });

                document.addEventListener('click', function (e) {
                    const container = document.getElementById('autocomplete-suggestions-container');
                    
                    // ATUALIZADO: Condição para não fechar
                    if (e.target !== container && !container.contains(e.target) && 
                        !e.target.matches('input[name="res[]"]') && 
                        !e.target.matches('input[name="transportados[]"]') &&
                        !e.target.matches('input[name="bairros[]"]') &&
                        !e.target.matches('input[name="destinos[]"]') && // <-- ADICIONADO
                        !e.target.matches('input[name="origens[]"]')    // <-- ADICIONADO
                    ) {
                        closeAllAutocompleteLists();
                    }
                });
            }

                addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);
                addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
                addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
                addPassageiroRow(true);

                const precoLocais = Object.keys(precoLookup);
            const datalistLocais = Array.from(document.querySelectorAll('#locais-list option')).map(opt => opt.value);
            // Combina as duas listas, filtra valores vazios e remove duplicatas
            const combinedSet = new Set([...precoLocais, ...datalistLocais].filter(Boolean)); 
            masterLocaisList = Array.from(combinedSet).sort(); // Salva na variável global
            console.log(`Lista mestra de locais criada: ${masterLocaisList.length} locais.`);
            const origemContainer = document.getElementById('origem-campos-container');
                // A linha abaixo já existia no seu arquivo como uma variável global, mas vamos garantir
                const destinoContainer = document.getElementById('destino-campos-container'); 
                bindPassageiroListeners(passageirosContainer, destinoContainer, origemContainer);
                addPassageiroBtn.addEventListener('click', () => addPassageiroRow(false));
                addSolicitanteBtn.addEventListener('click', () => addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', false));
                addDestinoBtn.addEventListener('click', () => {
                    addDynamicRow('destino-campos-container', 'destino', 'Destino', false);
                });



                document.getElementById('app-page').addEventListener('blur', (event) => {

                    if (event.target.matches('input[name="bairros[]"]') || event.target.matches('input[name="destinos[]"]')) {
                        updateValoresAutomaticamente('form-corrida');
                    }
                }, true); // O 'true' ajuda a capturar o evento de forma mais confiável

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        startFirestoreListeners();
                    } else {
                        if (!localStorage.getItem('loggedInUserData')) {
                            loginPage.classList.remove('hidden');
                            appPage.classList.add('hidden');
                        }
                    }
                });
                signInAnonymously(auth).catch((error) => console.error("Erro no login anônimo:", error));
                populateBairrosDatalist();
            };


            loginForm.addEventListener('submit', async function (event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                loginMessage.classList.add('hidden');

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("username", "==", username), where("password", "==", password));

                try {
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = { id: userDoc.id, ...userDoc.data() };

                        localStorage.setItem('loggedInUser', username);
                        localStorage.setItem('loggedInUserData', JSON.stringify(userData));

                        loginPage.classList.add('hidden');
                        appPage.classList.remove('hidden');
                        setMotoristaFromData(userData);
                    } else {
                        loginMessage.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Erro ao fazer login:", error);
                    loginMessage.innerText = 'Erro ao conectar com o servidor.';
                    loginMessage.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('loggedInUserData'); // Limpa os dados do usuário
                signOut(auth).then(() => {
                    window.location.reload();
                });
            });


            function makeTableRowsClickable(tableId) {
                const table = document.getElementById(tableId);
                if (!table) return;

                const tableBody = table.querySelector('tbody');
                if (!tableBody) return;

                tableBody.addEventListener('click', function (event) {
                    if (event.target.type === 'checkbox') {
                        return;
                    }
                    const row = event.target.closest('tr');
                    if (!row) return;
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = !checkbox.checked;
                    }
                });
            }






            async function startFirestoreListeners() {

                try {
                    const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                    const transportadosSnapshot = await getDocs(transportadosRef);
                    transportadosData = transportadosSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rebuildTransportadosLookups();
                    console.log("Transportados carregados.");
                } catch (error) {
                    console.error("Erro ao buscar transportados:", error);
                    showWarning("Não foi possível carregar a lista de transportados.");
                }


                try {
                    const usersRef = collection(db, 'users');
                    const usersSnapshot = await getDocs(usersRef);
                    usersData = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rebuildMotoristasLookups();
                    console.log("Motoristas carregados.");
                } catch (error) {
                    console.error("Erro ao buscar usuários:", error);
                    showWarning("Não foi possível carregar a lista de motoristas.");
                }


                makeTableRowsClickable('motoristas-table');
            }
document.getElementById('form-corrida').addEventListener('submit', async function (event) {

                event.preventDefault();

                const form = event.target;
                const requiredFields = ['motorista', 'data']; // Removido 'valor' temporariamente para validação

                const origensInputs = document.querySelectorAll('#origem-campos-container input[name="origens[]"]');
                const partidasInputs = document.querySelectorAll('#origem-campos-container input[name="partidas[]"]');
                const solicitantesInputs = document.querySelectorAll('#solicitante-campos-container input[name="solicitantes[]"]');
                const destinosInputs = document.querySelectorAll('#destino-campos-container input[name="destinos[]"]');
                const chegadasDestinoInputs = document.querySelectorAll('#destino-campos-container input[name="chegadas_destino[]"]');
                const bairrosInputs = document.querySelectorAll('#destino-campos-container input[name="bairros[]"]'); // <-- NOVO
                const valoresInputs = document.querySelectorAll('#valor-campos-container input[name="valores[]"]');
                const valoresExtraInputs = document.querySelectorAll('#valor-campos-container input[name="valores_extra[]"]');
                const resInputs = document.querySelectorAll('#passageiros-campos-container input[name="res[]"]');
                const transportadosInputs = document.querySelectorAll('#passageiros-campos-container input[name="transportados[]"]');

                let isFormValid = true;

                requiredFields.forEach(field => {
                    const input = form[field];
                    if (input && input.value.trim() === '') {
                        isFormValid = false;
                        input.classList.add('error-border');
                    } else if (input) {
                        input.classList.remove('error-border');
                    }
                });

                const origensData = [];
                const partidasData = [];
                for (let i = 0; i < origensInputs.length; i++) {
                    const origem = origensInputs[i].value.trim();
                    const partida = partidasInputs[i].value.trim();
                    if (origem || partida) {
                        origensData.push(origem);
                        partidasData.push(partida);
                    }
                }

                const solicitantesData = [];
                solicitantesInputs.forEach(input => {
                    const value = input.value.trim();
                    if (value !== '') {
                        solicitantesData.push(value);
                    }
                });

                const destinosData = [];
                const chegadasDestinoData = [];
                const bairrosData = []; // <-- NOVO
                for (let i = 0; i < destinosInputs.length; i++) {
                    const destino = destinosInputs[i].value.trim();
                    const chegada = chegadasDestinoInputs[i].value.trim();
                    const bairro = bairrosInputs[i] ? bairrosInputs[i].value.trim() : ''; // <-- NOVO

                    if (destino || chegada || bairro) { // <-- CONDIÇÃO ATUALIZADA
                        destinosData.push(destino);
                        chegadasDestinoData.push(chegada);
                        bairrosData.push(bairro); // <-- NOVO
                    }
                }

                const valoresData = [];
                const valoresExtraData = [];
                for (let i = 0; i < valoresInputs.length; i++) {
                    const valor = parseCurrencyValue(valoresInputs[i].value);
                    const valorExtra = parseCurrencyValue(valoresExtraInputs[i].value);
                    valoresData.push(valor);
                    valoresExtraData.push(valorExtra);
                }

                const passageirosData = [];
                const reSet = new Set();
                for (let i = 0; i < resInputs.length; i++) {
                    const reInput = resInputs[i];
                    const nomeInput = transportadosInputs[i];
                    const re = reInput.value.trim();
                    const nome = nomeInput.value.trim();

                    reInput.classList.remove('error-border');
                    nomeInput.classList.remove('error-border');

                    if (re !== '' && nome !== '') {
                        
                        if (reSet.has(re)) { 
                            isFormValid = false;
                            reInput.classList.add('error-border');
                            nomeInput.classList.add('error-border');
                            showWarning(`Matrícula (RE) duplicada neste lançamento: ${re}.`);
                            return;
                        }
                        reSet.add(re);
                        
                        passageirosData.push({ re: re, nome: nome });
                    } else if (re !== '' || nome !== '') {
                        isFormValid = false;
                        if (re === '') reInput.classList.add('error-border');
                        if (nome === '') nomeInput.classList.add('error-border');
                    }
                }

                if (passageirosData.length === 0) {
                    isFormValid = false;
                    if (resInputs[0]) resInputs[0].classList.add('error-border');
                    if (transportadosInputs[0]) transportadosInputs[0].classList.add('error-border');
                }

                if (!isFormValid) {
                    showWarning('Preencha todos os campos obrigatórios e verifique os dados.');
                    return;
                }

                const destinosExtras = [];
                for (let i = 1; i < destinosData.length; i++) {
                    destinosExtras.push({
                        destino: destinosData[i],
                        chegada: chegadasDestinoData[i],
                        bairro: bairrosData[i] || '', // <-- NOVO
                        valor: valoresData[i] || 0,
                        valorExtra: valoresExtraData[i] || 0
                    });
                }

                const newEntry = {
                    createdBy: currentUser.username,
                    motorista: form['motorista'].value,
                    bordero: form['bordero'].value.trim(),
                    re: passageirosData[0].re,
                    transportado: passageirosData[0].nome,
                    passageiros_extras: passageirosData.slice(1),
                    solicitante: solicitantesData[0] || '',
                    solicitantes_extras: solicitantesData.slice(1),
                    data: form['data'].value,
                    origem: origensData.length > 0 ? origensData[0] : '',
                    partida: partidasData.length > 0 ? partidasData[0] : '',
                    origens_extras: origensData.slice(1).map((origem, i) => ({ origem: origem, partida: partidasData[i + 1] || '' })),
                    destino: destinosData[0] || '',
                    chegada_destino: chegadasDestinoData[0] || '',
                    bairro: bairrosData[0] || '', // <-- NOVO
                    valor: valoresData[0] || 0,
                    valorExtra: valoresExtraData[0] || 0,
                    destinos_extras: destinosExtras,
                    observacao: form['observacao'].value,
                    createdAt: serverTimestamp()
                };

                const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
                await addDoc(lancamentosRef, newEntry);

                showWarning('Lançamento salvo com sucesso!');
                const dataValue = form['data'].value;
                const motoristaValue = form['motorista'].value;

                form.reset();

                form['data'].value = dataValue;
                form['motorista'].value = motoristaValue;

                solicitanteContainer.innerHTML = '';
                addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);

                document.getElementById('origem-campos-container').innerHTML = '';
                addDynamicRow('origem-campos-container', 'origem', 'Origem', true);

                destinoContainer.innerHTML = '';
                addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
                valorContainer.innerHTML = '';
                addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
                passageirosContainer.innerHTML = '';
                addPassageiroRow(true);
            });

            function formatMultipleValues(principal, extras, isPassageiro = false) {
                let result = principal || '';
                if (extras && extras.length > 0) {
                    const extraList = extras.map(e => isPassageiro ? e.nome : e);
                    result += ' (' + extraList.join(', ') + ')';
                }
                return result;
            }

            function formatExtrasByKey(principal, extras, key) {
                let result = principal || '';
                if (extras && extras.length > 0) {
                    const extraList = extras.map(e => e[key]).filter(val => val);
                    if (extraList.length > 0) {
                        result += ' (' + extraList.join(', ') + ')';
                    }
                }
                return result;
            }

            function formatDestinosChegadas(principalDestino, principalChegada, extras) {
                let result = principalDestino || '';
                if (principalChegada) {
                    result += ` (${principalChegada})`;
                }

                if (extras && extras.length > 0) {
                    const extraList = extras.map(e => `${e.destino || ''}${e.chegada ? ` (${e.chegada})` : ''}`).filter(s => s !== '');
                    if (extraList.length > 0) {
                        result += ' (' + extraList.join(', ') + ')';
                    }
                }
                return result;
            }

            function calculateTotalValue(lancamento) {
                let total = lancamento.valor || 0;
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(dest => {
                        total += dest.valor || 0;
                    });
                }
                return total;
            }

            function calculateTotalExtraValue(lancamento) {
                let total = lancamento.valorExtra || 0;
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(dest => {
                        total += dest.valorExtra || 0;
                    });
                }
                return total;
            }


            async function fetchAndRenderLancamentos() {
                const tableBody = document.querySelector('#lancamentos-table tbody');
                tableBody.innerHTML = '<tr><td colspan="16" class="text-center p-4">Carregando...</td></tr>';

                const selectedDate = document.getElementById('filter-date').value;
                const selectedMotorista = document.getElementById('filter-motorista').value;

                if (!selectedDate) {
                    tableBody.innerHTML = '<tr><td colspan="16" class="text-center p-4">Selecione uma data para ver os lançamentos.</td></tr>';
                    return;
                }

                try {
                    const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');


                    const q = query(
                        lancamentosRef,
                        where("data", "==", selectedDate), // Filtra pela data selecionada
                        orderBy("createdAt", "desc")       // Ordena pelos mais recentes
                    );

                    const snapshot = await getDocs(q);
                    let dataToShow = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));


                    if (!currentUser.isAdmin) {
                        dataToShow = dataToShow.filter(lanc => lanc.createdBy === currentUser.username);
                    }

                    if (selectedMotorista) { // Se um motorista foi selecionado (não é "Todos")
                        dataToShow = dataToShow.filter(lanc => lanc.motorista === selectedMotorista);
                    }

                    renderLancamentosTable(dataToShow); // Chama a função para popular a tabela

                } catch (error) {
                    console.error("Erro ao buscar lançamentos:", error);
                    tableBody.innerHTML = '<tr><td colspan="16" class="text-center p-4 text-red-500">Ocorreu um erro ao carregar os dados.</td></tr>';
                }
            }

            function renderLancamentosTable(dataToShow) {
                const tableBody = document.querySelector('#lancamentos-table tbody');
                tableBody.innerHTML = '';

                if (dataToShow.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="16" class="text-center p-4">Nenhum lançamento encontrado para esta data.</td></tr>';
                    return;
                }

                dataToShow.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';

                    const totalValue = calculateTotalValue(item);
                    const totalExtraValue = calculateTotalExtraValue(item);
                    const transportadoFull = formatMultipleValues(item.transportado, item.passageiros_extras, true);
                    const solicitanteFull = formatMultipleValues(item.solicitante, item.solicitantes_extras, false);
                    const destinoFull = formatDestinosChegadas(item.destino, item.chegada_destino, item.destinos_extras);
                    const bairroFull = formatExtrasByKey(item.bairro, item.destinos_extras, 'bairro');
                    const statusText = item.editedBy ? `<span class="text-xs text-gray-500">Editado por ${item.editedBy}</span>` : '';


                    row.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden">${item.id || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.data || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.motorista || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.bordero || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${solicitanteFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transportadoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.origem || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${destinoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bairroFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.partida || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalExtraValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.observacao || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${statusText}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 flex gap-2">
                        <button data-id="${item.id}" class="edit-lancamento-btn text-blue-600 hover:text-blue-900" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-id="${item.id}" class="delete-lancamento-btn text-red-600 hover:text-red-900" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                    tableBody.appendChild(row);
                });
            }

document.getElementById('open-lancamentos-modal').addEventListener('click', () => {

                const today = new Date().toISOString().split('T')[0];
                document.getElementById('filter-date').value = today;



                const motoristaFilter = document.getElementById('motorista-filter-wrapper');
                if (currentUser.isAdmin) {
                    motoristaFilter.classList.remove('hidden');
                } else {
                    motoristaFilter.classList.add('hidden');
                    document.getElementById('filter-motorista').value = ''; // Garante que o filtro seja limpo
                }



                fetchAndRenderLancamentos();

                document.getElementById('lancamentos-modal').classList.remove('hidden');
            });

            document.getElementById('close-lancamentos-modal').addEventListener('click', () => {
                document.getElementById('lancamentos-modal').classList.add('hidden');
            });


            document.getElementById('filter-lancamentos-btn').addEventListener('click', fetchAndRenderLancamentos);



            document.getElementById('lancamentos-table').addEventListener('click', async function (event) {
                const editButton = event.target.closest('.edit-lancamento-btn');
                const deleteButton = event.target.closest('.delete-lancamento-btn');


                if (editButton) {
                    const lancamentoId = editButton.dataset.id;
                    openEditLancamentoModal(lancamentoId);
                    return; // Para a execução
                }


                if (deleteButton) {
                    const lancamentoId = deleteButton.dataset.id;
                    if (confirm('Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.')) {
                        try {
                            const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', lancamentoId);
                            await deleteDoc(docRef);
                            showWarning('Lançamento excluído com sucesso!');
                            fetchAndRenderLancamentos(); 
                        } catch (error) {
                            console.error("Erro ao excluir lançamento:", error);
                            showWarning('Ocorreu um erro ao excluir o lançamento.');
                        }
                    }
                    return; // Para a execução
                }


                const row = event.target.closest('tr');
                if (row) {

                    const rowEditButton = row.querySelector('.edit-lancamento-btn');
                    if (rowEditButton) {
                        const lancamentoId = rowEditButton.dataset.id;
                        openEditLancamentoModal(lancamentoId);
                    }
                }
            });



            function updateEditDynamicLabels(containerId, inputName, baseLabel) {
                const rows = document.querySelectorAll(`#${containerId} .edit-dynamic-row`);
                rows.forEach((row, index) => {
                    const pNum = index + 1;
                    const label = row.querySelector('label');
                    const input = row.querySelector('input');

                    if (label) {
                        label.textContent = `${baseLabel} (P${pNum}):`;
                    }

                    if (containerId === 'edit-solicitante-campos-container' && index === 0 && input) {
                        input.id = 'edit-solicitante-p1';
                    }

                    if (containerId === 'edit-destino-campos-container') {
                        const destinoLabel = row.querySelector('label[for^="edit-destino-"]');
                        const chegadaLabel = row.querySelector('label[for^="edit-chegada-destino-"]');
                        const destinoInput = row.querySelector('input[name="edit-destinos[]"]');
                        if (destinoLabel) destinoLabel.textContent = `Destino (P${pNum}):`;
                        if (chegadaLabel) chegadaLabel.textContent = `Chegada (P${pNum}):`;
                        if (index === 0) {
                            if (destinoInput) destinoInput.id = 'edit-destino-p1';
                        }
                    }

                    if (containerId === 'edit-valor-campos-container') {

                        const labelValor = row.querySelector('label[for^="edit-valor"]:not([for*="extra"])');
                        const labelValorExtra = row.querySelector('label[for*="extra"]');
                        const inputValor = row.querySelector('input[name="edit-valores[]"]');
                        const inputValorExtra = row.querySelector('input[name="edit-valores_extra[]"]');
                        if (labelValor) labelValor.textContent = pNum === 1 ?
                            'Valor P1:' : `Valor P${pNum}:`;
                        if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                        if (inputValor) inputValor.id = pNum === 1 ?
                            'edit-valor' : `edit-valor-${pNum}`;
                        if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'edit-valor-extra' : `edit-valor-extra-${pNum}`;
                        if (inputValor) formatCurrencyInput(inputValor);
                        if (inputValorExtra) formatCurrencyInput(inputValorExtra);
                    }

                    const removeBtn = row.querySelector('.remove-edit-dynamic-btn');
                    if (removeBtn) {
                        if (index === 0) {
                            removeBtn.classList.add('hidden');
                        } else {
                            removeBtn.classList.remove('hidden');
                            removeBtn.onclick = () => {
                                row.remove();
                                updateEditDynamicLabels(containerId, inputName, baseLabel);
                                if (containerId === 'edit-destino-campos-container') {
                                    removeEditValueRow(pNum);
                                }
                            };
                        }
                    }
                });
            }

            function createEditDynamicInput(containerId, inputName, baseLabel, value = '') {
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-dynamic-row form-row-align';

                const index = Date.now();
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;

                fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="edit-${inputName}-${index}" class="block text-sm font-medium text-gray-700">${baseLabel} (P${pNum}):</label>
                    <input type="text" id="edit-${inputName}-${index}" name="edit-${inputName}s[]" value="${value}"
                        ${inputName === 'solicitante' ? 'list="solicitantes-list"' : ''}
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                    -
                </button>
            `;

                if (inputName === 'solicitante') {
                const input = fieldset.querySelector('input[type="text"]');
                input.setAttribute('list', 'solicitantes-list');
            }

                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateEditDynamicLabels(containerId, inputName, baseLabel);
                    };
                }
                return fieldset;
            }

            

            function createEditPassageiroInput(pNum, re = '', nome = '') {
                const fieldset = document.createElement('div');
                fieldset.className = 'edit-passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 relative';
                fieldset.dataset.pNum = pNum;
                const index = Date.now(); // Para IDs únicos

                fieldset.innerHTML = `
                <div>
                    <label for="edit-re-${index}" class="block text-sm font-medium text-gray-700">RE (P${pNum}):</label>
                    <input type="text" id="edit-re-${index}" name="edit-res[]" value="${re}"
                        autocomplete="off" 
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label for="edit-transportado-${index}" class="block text-sm font-medium text-gray-700">Transportado (P${pNum}):</label>
                        <input type="text" id="edit-transportado-${index}" name="edit-transportados[]" value="${nome}"
                            autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-passageiro-btn">
                    -
                    </button>
                </div>
                `;

                // Adiciona a lógica ao botão de remover
                const removeBtn = fieldset.querySelector('.remove-edit-passageiro-btn');
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateEditPassageiroLabels(); // Chama a função que estamos prestes a criar
                    updateValoresAutomaticamente('edit-lancamento-form'); // Recalcula preços
                };
                
                return fieldset;
            }

            
            // ▼▼▼ ADICIONE ESTA FUNÇÃO QUE ESTÁ FALTANDO ▼▼▼
            // (Cole por volta da linha 1968, após o fim da 'createEditPassageiroInput')

            function updateEditPassageiroLabels() {
                const extrasContainer = document.getElementById('edit-passageiros-extras-container');
                const rows = extrasContainer.querySelectorAll('.edit-passageiro-row');
                
                rows.forEach((row, index) => {
                    const pNum = index + 2; // Começa do P2
                    row.dataset.pNum = pNum;

                    const reLabel = row.querySelector('label[for^="edit-re-"]');
                    const transportadoLabel = row.querySelector('label[for^="edit-transportado-"]');

                    if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                    // CORREÇÃO: Adicionadas as crases (`) que faltavam na minha sugestão anterior
                    if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`; 
                });
            }


            function createEditValorInput(pNum, valorValue = '0,00', valorExtraValue = '0,00') {
                const fieldset = document.createElement('div');
                // Usamos 'edit-dynamic-row' para consistência
                fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4 md:gap-6'; 
                fieldset.dataset.pNum = pNum;
                const isP1 = pNum === 1;
                const labelValor = `Valor P${pNum}:`;
                const labelValorExtra = `Valor Extra P${pNum}:`;
                const inputIdValor = `edit-valor-${pNum}`;
                const inputIdValorExtra = `edit-valor-extra-${pNum}`;

                fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="edit-valores[]" value="${valorValue}"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-right">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                        <div class="relative mt-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                            <input type="text" id="${inputIdValorExtra}" name="edit-valores_extra[]" value="${valorExtraValue}"
                                class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm text-right">
                        </div>
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                `;

                // Adiciona os listeners de formatação de moeda
                const valorInput = fieldset.querySelector(`input[name="edit-valores[]"]`);
                const valorExtraInput = fieldset.querySelector(`input[name="edit-valores_extra[]"]`);
                
                [valorInput, valorExtraInput].forEach(input => {
                    input.addEventListener('input', () => formatCurrencyInput(input));
                    input.addEventListener('focus', () => { if (input.value === '0,00') input.value = ''; });
                    input.addEventListener('blur', () => { if (input.value === '') input.value = '0,00'; });
                });

                // Adiciona a lógica ao botão de remover
                const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                if (removeBtn && !isP1) {
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        // Precisamos remover também o destino/chegada/bairro
                        const destinoRow = document.querySelector(`#edit-destino-campos-container .edit-dynamic-row[data-p-num="${pNum}"]`);
                        if (destinoRow) destinoRow.remove();
                        
                        updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');
                        updateEditDynamicLabels('edit-destino-campos-container', 'destino', 'Destino');
                    };
                }
                return fieldset;
            }

            // ▼▼▼ ADICIONE ESTA SEGUNDA NOVA FUNÇÃO ▼▼▼

            function removeEditValueRow(pNumToRemove) {
                // Encontra a linha de VALOR com o mesmo 'data-p-num'
                const rowToRemove = document.querySelector(`#edit-valor-campos-container .edit-dynamic-row[data-p-num="${pNumToRemove}"]`);
                if (rowToRemove) {
                    rowToRemove.remove();
                    // Reorganiza os labels (P2, P3, P4...)
                    updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');
                }
            }

function createEditDestinoChegadaInput(destinoValue = '', chegadaValue = '', bairroValue = '') {
                const containerId = 'edit-destino-campos-container';
                const fieldset = document.createElement('div');
                // Alterado de volta para 3 colunas
                fieldset.className = 'edit-dynamic-row grid grid-cols-1 md:grid-cols-3 gap-4';
                const index = Date.now();
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const isP1 = pNum === 1;

                fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-destino-${index}" class="block text-sm font-medium text-gray-700">Destino (P${pNum}):</label>
                        <input type="text" id="edit-destino-${index}" name="edit-destinos[]" value="${destinoValue}" autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-chegada-destino-${index}" class="block text-sm font-medium text-gray-700">Chegada (P${pNum}):</label>
                        <input type="time" id="edit-chegada-destino-${index}" name="edit-chegadas_destino[]" value="${chegadaValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-bairro-${index}" class="block text-sm font-medium text-gray-700">Bairro (P${pNum}):</label>
                        <input type="text" id="edit-bairro-${index}" name="edit-bairros[]" value="${bairroValue}"
                            autocomplete="off"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
            `;
                if (!isP1) {
                    const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                    removeBtn.onclick = () => {
                        fieldset.remove();
                        updateEditDynamicLabels(containerId, 'destino', 'Destino');
                        removeEditValueRow(pNum);
                        updateValoresAutomaticamente('edit-lancamento-form');
                    };
                }
                return fieldset;
            }


            function addEditPassageiroRow(re = '', nome = '') {
                const extrasContainer = document.getElementById('edit-passageiros-extras-container');
                const currentRows = extrasContainer.querySelectorAll('.edit-passageiro-row').length;
                const pNum = currentRows + 2;
                const newRow = createEditPassageiroInput(pNum, re, nome);
                extrasContainer.appendChild(newRow);
                updateEditPassageiroLabels();
                setTimeout(() => updateValoresAutomaticamente('edit-lancamento-form'), 50);
            }

            document.getElementById('add-edit-passageiro-btn').addEventListener('click', () => addEditPassageiroRow());

async function openEditLancamentoModal(id) {
                let lancamento;
                try {
                    const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', id);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        lancamento = { id: docSnap.id, ...docSnap.data() };
                    } else {
                        showWarning("Lançamento não encontrado. A lista pode estar desatualizada.");
                        return;
                    }
                } catch (error) {
                    console.error("Erro ao buscar lançamento para edição:", error);
                    showWarning("Erro ao carregar os dados do lançamento.");
                    return;
                }

                if (!lancamento) return;

                document.getElementById('edit-lancamento-id').value = id;
                document.getElementById('edit-data').value = lancamento.data;
                document.getElementById('edit-bordero').value = lancamento.bordero || '';
                document.getElementById('edit-observacao').value = lancamento.observacao || '';
                
                // === LÓGICA DE ORIGEM REVERTIDA ===
                const editOrigemContainer = document.getElementById('edit-origem-campos-container');
                editOrigemContainer.innerHTML = ''; 
                // Agora passa 2 valores: origem, partida
                editOrigemContainer.appendChild(
                    createEditOrigemInput(lancamento.origem || '', lancamento.partida || '')
                );
                
                if (lancamento.origens_extras && lancamento.origens_extras.length > 0) {
                    lancamento.origens_extras.forEach(o => {
                        editOrigemContainer.appendChild(
                            createEditOrigemInput(o.origem || '', o.partida || '')
                        );
                    });
                }
                // === FIM DA LÓGICA DE ORIGEM ===

                const motoristaInput = document.getElementById('edit-motorista');
                motoristaInput.value = lancamento.motorista;
                if (!currentUser.isAdmin) {
                    motoristaInput.setAttribute('readonly', 'readonly');
                    motoristaInput.classList.add('bg-gray-200');
                } else {
                    motoristaInput.removeAttribute('readonly');
                    motoristaInput.classList.remove('bg-gray-200');
                }

                const editSolicitanteContainer = document.getElementById('edit-solicitante-campos-container');
                editSolicitanteContainer.innerHTML = '';
                
                editSolicitanteContainer.appendChild(
                    createEditDynamicInput('edit-solicitante-campos-container', 'solicitante', 'Solicitante', lancamento.solicitante || '')
                );
                
                if (lancamento.solicitantes_extras && lancamento.solicitantes_extras.length > 0) {
                    lancamento.solicitantes_extras.forEach((s) => {
                        editSolicitanteContainer.appendChild(
                            createEditDynamicInput('edit-solicitante-campos-container', 'solicitante', 'Solicitante', s)
                        );
                    });
                }
                updateEditDynamicLabels('edit-solicitante-campos-container', 'solicitante', 'Solicitante');

                // === LÓGICA DE DESTINO REVERTIDA ===
                const editDestinoContainer = document.getElementById('edit-destino-campos-container');
                editDestinoContainer.innerHTML = '';
                
                // Array para carregar destinos (agora com bairro)
                const destinosParaEdicao = [{ 
                    destino: lancamento.destino || '', 
                    chegada: lancamento.chegada_destino || '', 
                    bairro: lancamento.bairro || '' 
                }];

                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(d => destinosParaEdicao.push({ 
                        destino: d.destino || '', 
                        chegada: d.chegada || '',
                        bairro: d.bairro || ''
                    }));
                }
                
                // Carrega todos os destinos (P1, P2...) com 3 valores
                destinosParaEdicao.forEach(d => {
                    editDestinoContainer.appendChild(
                        createEditDestinoChegadaInput(d.destino, d.chegada, d.bairro || '')
                    );
                });
                // === FIM DA LÓGICA DE DESTINO ===

                const editValorContainer = document.getElementById('edit-valor-campos-container');
                editValorContainer.innerHTML = '';
                const valoresParaEdicao = [{ valor: lancamento.valor || 0, valorExtra: lancamento.valorExtra || 0 }];
                if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                    lancamento.destinos_extras.forEach(d => valoresParaEdicao.push({ valor: d.valor || 0, valorExtra: d.valorExtra || 0 }));
                }
                valoresParaEdicao.forEach((v, index) => {
                    const pNum = index + 1;
                    const valorFmt = (v.valor || 0).toFixed(2).replace('.', ',');
                    const valorExtraFmt = (v.valorExtra || 0).toFixed(2).replace('.', ',');
                    const newRow = createEditValorInput(pNum, valorFmt, valorExtraFmt);
                    editValorContainer.appendChild(newRow);
                });
                updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');

                document.getElementById('edit-re').value = lancamento.re || '';
                document.getElementById('edit-transportado').value = lancamento.transportado || '';
                const extrasContainer = document.getElementById('edit-passageiros-extras-container');
                extrasContainer.innerHTML = '';
                if (lancamento.passageiros_extras && lancamento.passageiros_extras.length > 0) {
                    lancamento.passageiros_extras.forEach((p) => {
                        addEditPassageiroRow(p.re, p.nome);
                    });
                }
                updateEditPassageiroLabels();
                document.getElementById('edit-lancamento-modal').classList.remove('hidden');
                setTimeout(() => updateValoresAutomaticamente('edit-lancamento-form'), 100);
            }


    function setupEditModalAutofill() {
                const modal = document.getElementById('edit-lancamento-modal');

                document.getElementById('add-edit-solicitante-btn').addEventListener('click', () => {
                const container = document.getElementById('edit-solicitante-campos-container');
                const newRow = createEditDynamicInput('edit-solicitante-campos-container', 'solicitante', 'Solicitante', '');
                container.appendChild(newRow);
                updateEditDynamicLabels('edit-solicitante-campos-container', 'solicitante', 'Solicitante');
            });

            document.getElementById('add-edit-origem-btn').addEventListener('click', () => {
                const container = document.getElementById('edit-origem-campos-container');
                // Passa 3 valores vazios para (origem, partida, bairro_origem)
                const newRow = createEditOrigemInput('', '', ''); 
                container.appendChild(newRow);
            });

            document.getElementById('add-edit-destino-btn').addEventListener('click', () => {
                const container = document.getElementById('edit-destino-campos-container');
                const newRow = createEditDestinoChegadaInput('', '', '');
                container.appendChild(newRow);
                updateEditDynamicLabels('edit-destino-campos-container', 'destino', 'Destino');
            });

            document.getElementById('add-edit-valor-btn').addEventListener('click', () => {
                const container = document.getElementById('edit-valor-campos-container');
                const pNum = container.querySelectorAll('.edit-dynamic-row').length + 1;
                const newRow = createEditValorInput(pNum, '0,00', '0,00');
                container.appendChild(newRow);
                // Não precisa de updateEditDynamicLabels aqui, pois createEditValorInput já define o P-num
            });

                // Listener para o CÁLCULO DE PREÇO (quando sai do campo)
                modal.addEventListener('blur', (event) => {
                    const input = event.target;
                    if (input.matches('input[name="edit-bairros[]"]') || input.matches('input[name="edit-destinos[]"]')) {
                        updateValoresAutomaticamente('edit-lancamento-form');
                    }
                }, true);
                
                // Listener para as SUGESTÕES DE AUTOCOMPLETE (enquanto digita)
                modal.addEventListener('input', (event) => {
                    const input = event.target;
                    
                    // Lógica para Bairros
                    if (input.matches('input[name="edit-bairros[]"]')) {
                        showAutocompleteSuggestions(input, 'bairro');
                    }
                    
                    // ▼▼▼ ADICIONADO ▼▼▼
                    // Lógica para Origens
                    if (input.matches('input[name="edit-origens[]"]')) {
                        showAutocompleteSuggestions(input, 'origem');
                    }
                    
                    // Lógica para Destinos
                    if (input.matches('input[name="edit-destinos[]"]')) {
                        showAutocompleteSuggestions(input, 'destino');
                    }
                    // ▲▲▲ FIM DA ADIÇÃO ▲▲▲

                    // Lógica para Passageiros (RE)
                    if (input.matches('input[name="edit-res[]"]') || input.id === 'edit-re') {
                        showAutocompleteSuggestions(input, 're');
                    }
                    
                    // Lógica para Passageiros (Nome)
                    if (input.matches('input[name="edit-transportados[]"]') || input.id === 'edit-transportado') {
                        showAutocompleteSuggestions(input, 'nome');
                    }
                });

                // Listener para o PREENCHIMENTO AUTOMÁTICO (quando sai do campo)
                modal.addEventListener('blur', (event) => {
                    const input = event.target;

                    const isPassengerField = input.id === 'edit-re' || input.id === 'edit-transportado' ||
                        input.matches('input[name="edit-res[]"]') || input.matches('input[name="edit-transportados[]"]');

                    if (isPassengerField) {
                        let reInput, nomeInput;

                        if (input.id === 'edit-re' || input.id === 'edit-transportado') {
                            reInput = document.getElementById('edit-re');
                            nomeInput = document.getElementById('edit-transportado');
                        } else {
                            const row = input.closest('.edit-passageiro-row');
                            reInput = row.querySelector('input[name="edit-res[]"]');
                            nomeInput = row.querySelector('input[name="edit-transportados[]"]');
                        }

                        if (reInput && nomeInput) {
                            if (input === reInput) {
                                handleAutofillDynamic(reInput, nomeInput, 're');
                            } else if (input === nomeInput) {
                                handleAutofillDynamic(nomeInput, reInput, 'nome');
                            }
                        }

                        setTimeout(() => checkEditPassageiroDuplicidade(), 50);
                    }
                }, true);
            }

            setupEditModalAutofill();

            document.getElementById('close-edit-lancamento-modal').addEventListener('click', () => {
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
            });

            document.getElementById('edit-lancamento-form').addEventListener('submit', async function (event) {
                event.preventDefault();

                if (checkEditPassageiroDuplicidade()) {
                    showWarning('Corrija os passageiros duplicados antes de salvar.');
                    return;
                }
                const solicitantesEdit = Array.from(document.querySelectorAll('#edit-solicitante-campos-container input[name="edit-solicitantes[]"]'))
                    .map(input => input.value.trim()).filter(value => value !== '');

                const p1RE = document.getElementById('edit-re').value.trim();
                const p1Nome = document.getElementById('edit-transportado').value.trim();
                if (!p1RE || !p1Nome) {
                    showWarning('O passageiro principal (P1) deve ter RE e nome preenchidos.');
                    return;
                }
                const resExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-res[]"]')).map(input => input.value.trim());
                const nomesExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-transportados[]"]')).map(input => input.value.trim());
                const passageirosExtras = resExtras.map((re, i) => ({ re: re, nome: nomesExtras[i] })).filter(p => p.re && p.nome);
                
                const destinosInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-destinos[]"]');
                const chegadasInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-chegadas_destino[]"]');
                const bairrosInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-bairros[]"]'); // <-- NOVO
                
                const valoresInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores[]"]');
                const valoresExtraInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores_extra[]"]');
                
                const destinosArray = [];
                destinosInputs.forEach((destinoInput, i) => {
                    const destino = destinoInput.value.trim();
                    const chegada = chegadasInputs[i] ? chegadasInputs[i].value.trim() : '';
                    const bairro = bairrosInputs[i] ? bairrosInputs[i].value.trim() : ''; // <-- NOVO
                    
                    if (destino || chegada || bairro) { // <-- CONDIÇÃO ATUALIZADA
                        destinosArray.push({ destino, chegada, bairro }); // <-- ATUALIZADO
                    }
                });

                const valoresArray = [];
                valoresInputs.forEach((valorInput, i) => {
                    const valor = parseCurrencyValue(valorInput.value);
                    const valorExtra = valoresExtraInputs[i] ? parseCurrencyValue(valoresExtraInputs[i].value) : 0;
                    valoresArray.push({ valor, valorExtra });
                });

                const id = document.getElementById('edit-lancamento-id').value;
                const origensEditInputs = document.querySelectorAll('#edit-origem-campos-container input[name="edit-origens[]"]');
                const partidasEditInputs = document.querySelectorAll('#edit-origem-campos-container input[name="edit-partidas[]"]');
                const origensEdit = [];
                origensEditInputs.forEach((input, i) => {
                    const origem = input.value.trim();
                    const partida = partidasEditInputs[i] ? partidasEditInputs[i].value.trim() : '';
                    if (origem || partida) {
                        origensEdit.push({ origem, partida });
                    }
                });

                const updatedData = {
                    motorista: document.getElementById('edit-motorista').value,
                    data: document.getElementById('edit-data').value,
                    bordero: document.getElementById('edit-bordero').value.trim(),
                    observacao: document.getElementById('edit-observacao').value,
                    editedBy: currentUser.username,
                    editedAt: serverTimestamp(),
                    solicitante: solicitantesEdit[0] || '',
                    solicitantes_extras: solicitantesEdit.slice(1),
                    re: p1RE,
                    transportado: p1Nome,
                    passageiros_extras: passageirosExtras,
                    origem: origensEdit.length > 0 ? origensEdit[0].origem : '',
                    partida: origensEdit.length > 0 ? origensEdit[0].partida : '',
                    origens_extras: origensEdit.slice(1),
                    destino: destinosArray.length > 0 ? destinosArray[0].destino : '',
                    chegada_destino: destinosArray.length > 0 ? destinosArray[0].chegada : '',
                    bairro: destinosArray.length > 0 ? destinosArray[0].bairro : '', // <-- NOVO
                    valor: valoresArray.length > 0 ? valoresArray[0].valor : 0,
                    valorExtra: valoresArray.length > 0 ? valoresArray[0].valorExtra : 0,
                    destinos_extras: [], 
                };

                const totalExtras = Math.max(destinosArray.length, valoresArray.length) - 1;
                if (totalExtras > 0) {
                    for (let i = 1; i <= totalExtras; i++) {
                        const destinoInfo = destinosArray[i] || { destino: '', chegada: '', bairro: '' }; // <-- ATUALIZADO
                        const valorInfo = valoresArray[i] || { valor: 0, valorExtra: 0 };
                        
                        if (destinoInfo.destino || destinoInfo.chegada || destinoInfo.bairro || valorInfo.valor > 0 || valorInfo.valorExtra > 0) { // <-- CONDIÇÃO ATUALIZADA
                            updatedData.destinos_extras.push({
                                destino: destinoInfo.destino,
                                chegada: destinoInfo.chegada,
                                bairro: destinoInfo.bairro, // <-- NOVO
                                valor: valorInfo.valor,
                                valorExtra: valorInfo.valorExtra
                            });
                        }
                    }
                }

                const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', id);
                await updateDoc(docRef, updatedData);
                showWarning('Lançamento atualizado com sucesso!');
                document.getElementById('edit-lancamento-modal').classList.add('hidden');
                fetchAndRenderLancamentos();
            });


            function renderTransportadosList() {
                const tableBody = document.querySelector('#transportados-table tbody');
                tableBody.innerHTML = '';
                transportadosData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';

                    row.dataset.id = item.id;
                    row.dataset.re = item.re;
                    row.dataset.nome = item.nome;

                    row.innerHTML = `
                        <td class="px-6 py-4">${item.re}</td>
                        <td class="px-6 py-4">${item.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center flex justify-center gap-4">
                            <button class="edit-transportado-btn text-blue-600 hover:text-blue-900" title="Editar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="delete-transportado-btn text-red-600 hover:text-red-900" title="Excluir">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                            
                            <button class="save-transportado-btn text-green-600 hover:text-green-900 hidden" title="Salvar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="cancel-transportado-btn text-gray-600 hover:text-gray-900 hidden" title="Cancelar">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                populateTransportadosDatalist();
            }



            function renderMotoristasList() {
                const tableBody = document.querySelector('#motoristas-table tbody');
                const tableHead = document.querySelector('#motoristas-table thead tr');


                if (!tableHead.querySelector('.th-actions')) {
                    tableHead.innerHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider th-actions">Ações</th>`;
                }

                tableBody.innerHTML = '';
                usersData.forEach(item => {

                    const disableButton = item.username === currentUser.username;
                    const buttonHtml = disableButton ?
                        `<span class="text-gray-400 text-sm">Próprio Usuário</span>` :
                        `<button data-id="${item.id}" data-username="${item.username}" class="reset-password-btn text-yellow-600 hover:text-yellow-900 font-semibold">Redefinir Senha</button>`;

                    const row = document.createElement('tr');
                    row.className = 'bg-white hover:bg-gray-50';
                    row.innerHTML = `
                    <td class="p-4"><input type="checkbox" data-id="${item.id}" class="motorista-checkbox rounded-sm"></td>
                    <td class="px-6 py-4">${item.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${buttonHtml}</td>
                `;
                    tableBody.appendChild(row);
                });
            }

            function populateTransportadosDatalist() {
                const reDatalist = document.querySelector('#transportados-re-list') || document.createElement('datalist');
                reDatalist.id = 'transportados-re-list';
                const nomeDatalist = document.querySelector('#transportados-nome-list') || document.createElement('datalist');
                nomeDatalist.id = 'transportados-nome-list';
                if (!document.body.contains(reDatalist)) document.body.appendChild(reDatalist);
                if (!document.body.contains(nomeDatalist)) document.body.appendChild(nomeDatalist);
                reDatalist.innerHTML = '';
                nomeDatalist.innerHTML = '';
                transportadosData.forEach(item => {
                    reDatalist.innerHTML += `<option value="${item.re}">`;
                    nomeDatalist.innerHTML += `<option value="${item.nome}">`;
                });
            }

            function populateMotoristasDatalist() {
                const datalist = document.getElementById('motoristas-list');
                datalist.innerHTML = '';
                usersData.forEach(item => datalist.innerHTML += `<option value="${item.nome}">`);
            }

            function populateBairrosDatalist() {
                const locais = Object.keys(precoLookup);
                const datalist = document.createElement('datalist');
                datalist.id = 'bairros-e-cidades-list';                
                locais.forEach(local => {
                    datalist.innerHTML += `<option value="${local}"></option>`;
                });
                document.body.appendChild(datalist);
            }

document.getElementById('add-transportado').addEventListener('click', async () => {
                const newRE = document.getElementById('new-re').value.trim();
                const newNome = document.getElementById('new-nome').value.trim();

                if (!newRE || !newNome) {
                    showWarning('Preencha o RE e nome.');
                    return;
                }


                const reExistsLocal = transportadosData.some(item => item.re.toUpperCase() === newRE.toUpperCase());
                if (reExistsLocal) {
                    showWarning(`Erro: A Matrícula (RE) "${newRE}" já está na lista local.`);
                    return;
                }
                

                const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');

                try {
                    const q = query(transportadosRef, where("re", "==", newRE));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {

                        showWarning(`Erro: A Matrícula (RE) "${newRE}" já está cadastrada no banco.`);
                        return;
                    }


                    const newDoc = await addDoc(transportadosRef, { re: newRE, nome: newNome });
                    

                    transportadosData.push({ re: newRE, nome: newNome, id: newDoc.id });
                    rebuildTransportadosLookups(); // Rebói a lista e o autocomplete

                    document.getElementById('new-re').value = '';
                    document.getElementById('new-nome').value = '';
                    


                } catch (error) {
                    console.error("Erro ao adicionar transportado:", error);
                    showWarning('Erro ao conectar com o banco de dados.');
                }
            });

            function populateMotoristasFilterDropdown() {
                const select = document.getElementById('filter-motorista');
                if (!select) return; // Se o elemento não existir, para aqui
                

                const firstOption = select.options[0];
                select.innerHTML = '';
                select.appendChild(firstOption);


                usersData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.nome;
                    option.textContent = item.nome;
                    select.appendChild(option);
                });
            }



            document.getElementById('add-motorista').addEventListener('click', async () => {
                const nome = document.getElementById('new-motorista-nome').value.trim();
                const username = document.getElementById('new-motorista-username').value.trim().toLowerCase();
                const password = document.getElementById('new-motorista-password').value.trim();
                const isAdmin = document.getElementById('new-motorista-is-admin').checked;

                if (nome && username && password) {
                    const existingUser = usersData.find(user => user.username === username);
                    if (existingUser) {
                        showWarning('Este nome de usuário já existe.');
                        return;
                    }

                    const newUser = {
                        nome: nome,
                        username: username,
                        password: password, // Lembre-se do aviso de segurança!
                        is_admin: isAdmin,
                        is_motorista_fixo: true
                    };

                    await addDoc(collection(db, 'users'), newUser);

                    document.getElementById('new-motorista-nome').value = '';
                    document.getElementById('new-motorista-username').value = '';
                    document.getElementById('new-motorista-password').value = '';
                    document.getElementById('new-motorista-is-admin').checked = false;

                    showWarning('Novo usuário/motorista adicionado com sucesso!');
                } else {
                    showWarning('Preencha todos os campos: Nome, Usuário e Senha.');
                }
            });


            document.getElementById('delete-selected-motoristas').addEventListener('click', async () => {
                const checkboxes = document.querySelectorAll('#motoristas-table .motorista-checkbox:checked');
                if (checkboxes.length === 0) {
                    showWarning('Selecione ao menos um motorista.');
                    return;
                }

                const promises = Array.from(checkboxes).map(cb => deleteDoc(doc(db, 'users', cb.dataset.id)));
                await Promise.all(promises);
                showWarning(`${checkboxes.length} usuários/motoristas excluídos.`);
            });


            document.getElementById('close-modal').addEventListener('click', hideWarning);


            document.getElementById('transportados-table').addEventListener('click', async (event) => {
                const button = event.target.closest('button');
                if (!button) return;

                const row = button.closest('tr');
                const id = row.dataset.id;


                if (button.classList.contains('edit-transportado-btn')) {
                    const reCell = row.cells[0];
                    const nomeCell = row.cells[1];
                    const currentRE = row.dataset.re;
                    const currentNome = row.dataset.nome;


                    reCell.innerHTML = `<input type="text" value="${currentRE}" class="w-full border border-blue-500 rounded px-1 py-0.5">`;
                    nomeCell.innerHTML = `<input type="text" value="${currentNome}" class="w-full border border-blue-500 rounded px-1 py-0.5">`;


                    row.querySelector('.edit-transportado-btn').classList.add('hidden');
                    row.querySelector('.delete-transportado-btn').classList.add('hidden');
                    row.querySelector('.save-transportado-btn').classList.remove('hidden');
                    row.querySelector('.cancel-transportado-btn').classList.remove('hidden');
                }


                if (button.classList.contains('cancel-transportado-btn')) {

                    row.cells[0].innerHTML = row.dataset.re;
                    row.cells[1].innerHTML = row.dataset.nome;


                    row.querySelector('.edit-transportado-btn').classList.remove('hidden');
                    row.querySelector('.delete-transportado-btn').classList.remove('hidden');
                    row.querySelector('.save-transportado-btn').classList.add('hidden');
                    row.querySelector('.cancel-transportado-btn').classList.add('hidden');
                }


                if (button.classList.contains('delete-transportado-btn')) {
                    if (confirm(`Tem certeza que deseja excluir "${row.dataset.nome}"?`)) {
                        try {
                            await deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'transportados', id));
                            

                            const index = transportadosData.findIndex(item => item.id === id);
                            if (index > -1) transportadosData.splice(index, 1);
                            rebuildTransportadosLookups();
                            
                            showWarning('Transportado excluído com sucesso.');

                            row.remove(); 
                        } catch (error) {
                            showWarning('Erro ao excluir transportado.');
                        }
                    }
                }


                if (button.classList.contains('save-transportado-btn')) {
                    const reInput = row.cells[0].querySelector('input');
                    const nomeInput = row.cells[1].querySelector('input');
                    const newRE = reInput.value.trim();
                    const newNome = nomeInput.value.trim();

                    if (!newRE || !newNome) {
                        showWarning("RE e Nome não podem estar vazios.");
                        return;
                    }


                    if (newRE !== row.dataset.re) {

                        const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
                        const q = query(transportadosRef, where("re", "==", newRE));
                        const querySnapshot = await getDocs(q);
                        
                        if (!querySnapshot.empty) {
                            showWarning(`Erro: A Matrícula (RE) "${newRE}" já pertence a outro transportado.`);
                            return;
                        }
                    }


                    try {
                        const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'transportados', id);
                        await updateDoc(docRef, {
                            re: newRE,
                            nome: newNome
                        });


                        const index = transportadosData.findIndex(item => item.id === id);
                        if (index > -1) {
                            transportadosData[index].re = newRE;
                            transportadosData[index].nome = newNome;
                        }
                        rebuildTransportadosLookups();


                        row.dataset.re = newRE;
                        row.dataset.nome = newNome;
                        row.cells[0].innerHTML = newRE;
                        row.cells[1].innerHTML = newNome;

                        row.querySelector('.edit-transportado-btn').classList.remove('hidden');
                        row.querySelector('.delete-transportado-btn').classList.remove('hidden');
                        row.querySelector('.save-transportado-btn').classList.add('hidden');
                        row.querySelector('.cancel-transportado-btn').classList.add('hidden');
                        
                        showWarning('Transportado atualizado com sucesso.');

                    } catch (error) {
                        showWarning('Erro ao salvar as alterações.');
                    }
                }
            });
            
            document.getElementById('open-transportados-modal').addEventListener('click', () => {

                rebuildTransportadosLookups(
                    document.getElementById('sort-transportados-key').value, 
                    document.getElementById('sort-transportados-order').value
                );

                document.getElementById('transportados-modal').classList.remove('hidden');
            });

            document.getElementById('close-transportados-modal').addEventListener('click', () => document.getElementById('transportados-modal').classList.add('hidden'));
            document.getElementById('open-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.remove('hidden'));
            document.getElementById('close-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.add('hidden'));
            

            document.getElementById('sort-transportados-key').addEventListener('change', function () {
                rebuildTransportadosLookups(this.value, document.getElementById('sort-transportados-order').value);
            });
            

            document.getElementById('sort-transportados-order').addEventListener('change', function () {
                rebuildTransportadosLookups(document.getElementById('sort-transportados-key').value, this.value);
            });
            document.getElementById('sort-motoristas-order').addEventListener('change', function () {
                rebuildMotoristasLookups(this.value);
            });

            document.getElementById('fill-partidas-btn').addEventListener('click', () => {
                const partidaInputs = document.querySelectorAll('input[name="partidas[]"]');
                if (partidaInputs.length < 2) return; // Só faz sentido se houver mais de um campo

                const firstPartidaValue = partidaInputs[0].value;
                if (!firstPartidaValue) {
                    showWarning('Preencha o primeiro horário de partida para usar esta função.');
                    return;
                }

                for (let i = 1; i < partidaInputs.length; i++) {
                    partidaInputs[i].value = firstPartidaValue;
                }
            });

            document.getElementById('fill-chegadas-btn').addEventListener('click', () => {
                const chegadaInputs = document.querySelectorAll('input[name="chegadas_destino[]"]');
                if (chegadaInputs.length < 2) return; // Só faz sentido se houver mais de um campo

                const firstChegadaValue = chegadaInputs[0].value;
                if (!firstChegadaValue) {
                    showWarning('Preencha o primeiro horário de chegada para usar esta função.');
                    return;
                }

                for (let i = 1; i < chegadaInputs.length; i++) {
                    chegadaInputs[i].value = firstChegadaValue;
                }
            });

            function triggerXlsxDownload(workbook, filename) {
                try {
                    XLSX.writeFile(workbook, filename, { bookType: "xlsx", type: "binary" });
                } catch (error) {
                    console.error("Erro ao gerar arquivo XLSX:", error);
                    showWarning("Erro ao gerar arquivo Excel.");
                }
            }

// ▼▼▼ SUBSTITUA ESTA FUNÇÃO INTEIRA ▼▼▼

            async function handleDownloadDriversCsv() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) {
                    showWarning('Por favor, selecione a data de início e a data de fim.');
                    return;
                }

                const button = document.getElementById('download-csv-drivers');
                const progressElement = document.getElementById('csv-progress');
                const originalText = button.textContent;

                button.disabled = true;
                progressElement.classList.remove('hidden');
                progressElement.textContent = 'Iniciando busca de lançamentos...';

                const driverSummary = new Map();

                try {
                    const BATCH_SIZE = 200;
                    let lastVisibleDoc = null;
                    let totalProcessed = 0;

                    while (true) {
                        const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
                        let q = query(lancamentosRef,
                            where("data", ">=", startDate),
                            where("data", "<=", endDate),
                            orderBy("data"),
                            limit(BATCH_SIZE)
                        );
                        if (lastVisibleDoc) {
                            q = query(q, startAfter(lastVisibleDoc));
                        }

                        const querySnapshot = await getDocs(q);
                        const batchDocs = querySnapshot.docs;
                        if (batchDocs.length === 0) break;

                        batchDocs.forEach(doc => {
                            const item = doc.data();
                            const motorista = item.motorista;
                            if (!motorista) return;

                            let valorViagem = (item.valor || 0) + (item.valorExtra || 0);
                            if (item.destinos_extras && item.destinos_extras.length > 0) {
                                item.destinos_extras.forEach(extra => {
                                    valorViagem += (extra.valor || 0) + (extra.valorExtra || 0);
                                });
                            }

                            const summary = driverSummary.get(motorista) || { totalValor: 0, totalViagens: 0 };
                            summary.totalValor += valorViagem;
                            summary.totalViagens += 1;
                            driverSummary.set(motorista, summary);
                        });

                        totalProcessed += batchDocs.length;
                        progressElement.textContent = `Processando... ${totalProcessed} lançamentos verificados.`;
                        lastVisibleDoc = batchDocs[batchDocs.length - 1];
                        if (batchDocs.length < BATCH_SIZE) break;
                    }

                    progressElement.textContent = 'Combinando com dados dos motoristas...';

                    const headers = ['NOME', 'VALOR TOTAL', 'TOTAL VIAGENS'];
                    let dataForSheet = [headers];

                    usersData.forEach(user => {
                        const summary = driverSummary.get(user.nome) || { totalValor: 0, totalViagens: 0 };
                        
                        const rowData = [
                            user.nome || '',
                            summary.totalValor,
                            summary.totalViagens
                        ];
                        dataForSheet.push(rowData);
                    });
                    
                    if (dataForSheet.length <= 1) {
                         showWarning('Nenhum dado de motorista encontrado.');
                         return;
                    }
                    
                    progressElement.textContent = 'Formatando o arquivo Excel...';

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(dataForSheet);

                    ws['!cols'] = [
                        { wch: 30 }, // A (Nome)
                        { wch: 20 }, // B (Valor Total)
                        { wch: 15 }  // C (Total Viagens)
                    ];

                    // --- INÍCIO DA CORREÇÃO ---
                    const currencyFormat = 'R$ #,##0.00';
                    const range = XLSX.utils.decode_range(ws['!ref']); // Pega o range (ex: A1:C10)

                    for (let R = range.s.r; R <= range.e.r; ++R) { // Loop de Linha (Row)
                        for (let C = range.s.c; C <= range.e.c; ++C) { // Loop de Coluna (Col)
                            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                            
                            // 1. Se a célula não existir (vazia), cria um objeto 's' (string) vazio para ela
                            if (!ws[cell_address]) ws[cell_address] = { t: 's', v: '' };

                            const cell = ws[cell_address];
                            
                            // 2. Garante que o objeto de estilo (.s) exista
                            if (!cell.s) cell.s = {};
                            
                            // 3. Aplica o alinhamento
                            cell.s.alignment = { horizontal: "center", vertical: "center" };
                            
                            // 4. Formato de moeda (Pula a linha 0, o cabeçalho)
                            if (R > 0) { // R > 0 significa "não na primeira linha"
                                if (C === 1) { // Coluna B (Valor Total)
                                    cell.z = currencyFormat;
                                }
                            }
                        }
                    }
                    // --- FIM DA CORREÇÃO ---

                    XLSX.utils.book_append_sheet(wb, ws, "Relatório Motoristas");

                    const filename = `relatorio_motoristas_${startDate}_a_${endDate}.xlsx`;
                    progressElement.textContent = 'Gerando arquivo para download...';

                    triggerXlsxDownload(wb, filename);

                } catch (error) {
                    console.error("Erro ao gerar relatório de motoristas:", error);
                    showWarning("Ocorreu um erro ao gerar o relatório.");
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                    progressElement.classList.add('hidden');
                }
            }

// ▼▼▼ SUBSTITUA ESTA FUNÇÃO INTEIRA ▼▼▼

            async function handleDownloadCsvInBatches() {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                if (!startDate || !endDate) {
                    showWarning('Por favor, selecione a data de início e a data de fim.');
                    return;
                }

                const button = document.getElementById('download-csv-detailed');
                const progressElement = document.getElementById('csv-progress');
                const originalText = button.textContent;

                button.disabled = true;
                progressElement.classList.remove('hidden');
                progressElement.textContent = 'Iniciando a busca...';
                let batchCounter = 1;

                try {
                    const BATCH_SIZE = 200;
                    let lastVisibleDoc = null;
                    let totalProcessed = 0;
                    
                    const headers = [
                        'RE', 'PASSAGEIRO', 'SOLICITANTE', 'BORDERO', 'MOTORISTA', 'DATA', 
                        'HORÁRIO DA SOLICITAÇÃO', 'DESEMBARQUE', 'ORIGEM', 'DESTINO', 'BAIRRO', 
                        'VALOR', 'VALOR EXTRA', 'OBSERVAÇÕES'
                    ];
                    
                    let dataForSheet = [headers];

                    while (true) {
                        const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
                        let q = query(lancamentosRef,
                            where("data", ">=", startDate),
                            where("data", "<=", endDate),
                            orderBy("data"),
                            limit(BATCH_SIZE)
                        );
                        if (lastVisibleDoc) {
                            q = query(q, startAfter(lastVisibleDoc));
                        }

                        const querySnapshot = await getDocs(q);
                        const batchDocs = querySnapshot.docs;
                        if (batchDocs.length === 0) break;

                        batchDocs.forEach(doc => {
                            const item = doc.data();
                            const passengerBlocks = [
                                {
                                    re: item.re, passageiro: item.transportado, solicitante: item.solicitante,
                                    origem: item.origem, partida: item.partida, destino: item.destino,
                                    chegada: item.chegada_destino, bairro: item.bairro,
                                    valor: item.valor, valorExtra: item.valorExtra
                                },
                                {
                                    re: item.passageiros_extras?.[0]?.re, passageiro: item.passageiros_extras?.[0]?.nome, solicitante: item.solicitantes_extras?.[0],
                                    origem: item.origens_extras?.[0]?.origem, partida: item.origens_extras?.[0]?.partida,
                                    destino: item.destinos_extras?.[0]?.destino, chegada: item.destinos_extras?.[0]?.chegada, bairro: item.destinos_extras?.[0]?.bairro,
                                    valor: item.destinos_extras?.[0]?.valor, valorExtra: item.destinos_extras?.[0]?.valorExtra
                                },
                                {
                                    re: item.passageiros_extras?.[1]?.re, passageiro: item.passageiros_extras?.[1]?.nome, solicitante: item.solicitantes_extras?.[1],
                                    origem: item.origens_extras?.[1]?.origem, partida: item.origens_extras?.[1]?.partida,
                                    destino: item.destinos_extras?.[1]?.destino, chegada: item.destinos_extras?.[1]?.chegada, bairro: item.destinos_extras?.[1]?.bairro,
                                    valor: item.destinos_extras?.[1]?.valor, valorExtra: item.destinos_extras?.[1]?.valorExtra
                                },
                                {
                                    re: item.passageiros_extras?.[2]?.re, passageiro: item.passageiros_extras?.[2]?.nome, solicitante: item.solicitantes_extras?.[2],
                                    origem: item.origens_extras?.[2]?.origem, partida: item.origens_extras?.[2]?.partida,
                                    destino: item.destinos_extras?.[2]?.destino, chegada: item.destinos_extras?.[2]?.chegada, bairro: item.destinos_extras?.[2]?.bairro,
                                    valor: item.destinos_extras?.[2]?.valor, valorExtra: item.destinos_extras?.[2]?.valorExtra
                                }
                            ];

                            for (const block of passengerBlocks) {
                                if (block.re) {
                                    const rowData = [
                                        block.re,
                                        block.passageiro || '',
                                        block.solicitante || '',
                                        item.bordero,
                                        item.motorista,
                                        item.data,
                                        block.partida || '',
                                        block.chegada || '',
                                        block.origem || '',
                                        block.destino || '',
                                        block.bairro || '',
                                        block.valor || 0,
                                        block.valorExtra || 0,
                                        item.observacao || ''
                                    ];
                                    dataForSheet.push(rowData);
                                }
                            }
                        });

                        totalProcessed += batchDocs.length;
                        progressElement.textContent = `Processando lote ${batchCounter}... ${totalProcessed} lançamentos verificados.`;
                        batchCounter++;
                        lastVisibleDoc = batchDocs[batchDocs.length - 1];
                        if (batchDocs.length < BATCH_SIZE) break;
                    }

                    if (dataForSheet.length <= 1) { 
                        showWarning('Nenhum lançamento encontrado para o período selecionado.');
                        return;
                    }

                    progressElement.textContent = 'Formatando o arquivo Excel...';

                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(dataForSheet);

                    ws['!cols'] = [
                        { wch: 10 }, // A (RE)
                        { wch: 30 }, // B (Passageiro)
                        { wch: 20 }, // C (Solicitante)
                        { wch: 10 }, // D (Borderô)
                        { wch: 20 }, // E (Motorista)
                        { wch: 12 }, // F (Data)
                        { wch: 25 }, // G (Solicitação)
                        { wch: 15 }, // H (Desembarque)
                        { wch: 25 }, // I (Origem)
                        { wch: 25 }, // J (Destino)
                        { wch: 20 }, // K (Bairro)
                        { wch: 15 }, // L (Valor)
                        { wch: 15 }, // M (Valor Extra)
                        { wch: 40 }  // N (Observações)
                    ];

                    // --- INÍCIO DA CORREÇÃO ---
                    const currencyFormat = 'R$ #,##0.00';
                    const range = XLSX.utils.decode_range(ws['!ref']); // Pega o range (ex: A1:N50)

                    for (let R = range.s.r; R <= range.e.r; ++R) { // Loop de Linha (Row)
                        for (let C = range.s.c; C <= range.e.c; ++C) { // Loop de Coluna (Col)
                            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                            
                            // 1. Se a célula não existir (vazia), cria um objeto 's' (string) vazio para ela
                            if (!ws[cell_address]) ws[cell_address] = { t: 's', v: '' };

                            const cell = ws[cell_address];
                            
                            // 2. Garante que o objeto de estilo (.s) exista
                            if (!cell.s) cell.s = {};

                            // 3. Aplica o alinhamento centralizado
                            cell.s.alignment = { horizontal: "center", vertical: "center" };
                            
                            // 4. Aplica o formato de moeda (Pula a linha 0, que é o cabeçalho)
                            if (R > 0) { // R > 0 significa "não na primeira linha"
                                if (C === 11) { // Coluna L (Valor)
                                    cell.z = currencyFormat;
                                }
                                if (C === 12) { // Coluna M (Valor Extra)
                                    cell.z = currencyFormat;
                                }
                            }
                        }
                    }
                    // --- FIM DA CORREÇÃO ---

                    XLSX.utils.book_append_sheet(wb, ws, "Relatório Detalhado");

                    const filename = `relatorio_detalhado_${startDate}_a_${endDate}.xlsx`;
                    progressElement.textContent = 'Gerando arquivo para download...';
                    
                    triggerXlsxDownload(wb, filename);

                } catch (error) {
                    console.error("Erro ao gerar relatório XLSX:", error);
                    showWarning("Ocorreu um erro ao gerar o relatório.");
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                    progressElement.classList.add('hidden');
                }
            }


            document.getElementById('download-csv-detailed').addEventListener('click', handleDownloadCsvInBatches);
            document.getElementById('download-csv-drivers').addEventListener('click', handleDownloadDriversCsv);


            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {

                    const modalIds = [
                        'transportados-modal',
                        'motoristas-modal',
                        'lancamentos-modal',
                        'edit-lancamento-modal',
                        'message-modal', // O modal de aviso
                        'change-password-modal',
                        'reset-password-modal'
                    ];

                    modalIds.forEach(id => {
                        const modal = document.getElementById(id);
                        if (modal && !modal.classList.contains('hidden')) {
                            modal.classList.add('hidden');
                        }
                    });


                    closeAllAutocompleteLists();
                }
            });



            
            </script>
    </body>

    </html>

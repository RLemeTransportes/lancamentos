<index.html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lançamento de Corridas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .error-border {
            border-color: #ef4444 !important;
        }

        /* Style for table rows to show pointer */
        tr {
            cursor: pointer;
        }

        /* Make sure modals fit on smaller screens */
        .modal-content {
            width: 95%;
            max-width: 48rem;
            /* Equivalent to max-w-2xl */
        }

        @media (min-width: 640px) {
            .modal-content {
                width: 100%;
            }
        }

        /* Custom style for larger modal */
        .modal-lg {
            max-width: 80rem;
            /* max-w-6xl */
        }

        /* Custom style to align form elements */
        .form-row-align {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .form-row-align .flex-grow {
            min-width: 0;
            /* Allow flex item to shrink */
        }
    </style>
</head>

<body class="bg-gray-100 flex items-start justify-center min-h-screen p-4">
    <div id="login-page" class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200 hidden">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6 md:mb-8">Login</h1>
        <form id="login-form" class="space-y-4">

            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Usuário:</label>
                <input type="text" id="username" name="username"
                    class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">

            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Senha:</label>
                <input type="password" id="password" name="password"
                    class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
            </div>
            <button type="submit"
                class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                Entrar
            </button>
            <p id="login-message" class="text-red-500 text-sm text-center mt-2 hidden">Usuário ou senha inválidos.
            </p>

        </form>
    </div>

    <div id="app-page"
        class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-full md:max-w-5xl border border-gray-200 hidden">
        <div class="flex justify-between items-center mb-6 relative">
            <div class="flex-grow flex justify-center">

                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Lançamento de Corridas</h1>
            </div>
            <button id="logout-btn"
                class="absolute top-0 right-0 px-4 py-2 bg-gray-300 text-gray-800 font-medium rounded-lg hover:bg-gray-400">Sair</button>
	<button id="open-change-password-btn"
    class="absolute top-12 right-0 px-4 py-2 bg-yellow-500 text-white font-medium rounded-lg hover:bg-yellow-600">Alterar Senha</button>
        </div>

        <p id="user-id-display" class="text-sm text-transparent text-center mb-4"></p>

        <form id="form-corrida" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8">

            <div class="form-row-align">
                <div class="flex-grow">
                    <label for="motorista" class="block text-sm font-medium text-gray-700">Motorista:</label>
                    <input type="text" id="motorista" name="motorista" list="motoristas-list"
                        onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    <datalist id="motoristas-list">
                    </datalist>
                </div>
            </div>

            <div id="solicitante-campos-container" class="space-y-4">

            </div>

            <div class="md:col-span-2 flex justify-center md:justify-start">
                <button type="button" id="add-solicitante-btn"
                    class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                    + Adicionar Outro Solicitante
                </button>
            </div>


            <div id="passageiros-campos-container" class="md:col-span-2 grid grid-cols-1 gap-4 md:gap-6">
                <input type="hidden" id="re" name="re">
                <input type="hidden" id="transportado" name="transportado">
            </div>


            <div class="md:col-span-2 flex justify-center">
                <button type="button" id="add-passageiro-btn"
                    class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                    + Adicionar Outro Passageiro
                </button>

            </div>

            <div class="form-row-align">
                <div class="flex-grow">
                    <label for="data" class="block text-sm font-medium text-gray-700">Data:</label>
                    <input type="date" id="data" name="data" onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>

            <div class="form-row-align">
                <div class="flex-grow">
                    <label for="bordero" class="block text-sm font-medium text-gray-700">Nº Borderô:</label>
                    <input type="text" id="bordero" name="bordero"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>
            <div class="form-row-align">
                <div class="flex-grow">

                    <label for="origem" class="block text-sm font-medium text-gray-700">Origem:</label>
                    <input type="text" id="origem" name="origem" onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>

            <div class="form-row-align">

                <div class="flex-grow">
                    <label for="partida" class="block text-sm font-medium text-gray-700">Partida:</label>
                    <input type="time" id="partida" name="partida" onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>

            <div id="destino-campos-container-wrapper" class="md:col-span-2 space-y-4">
                <div id="destino-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                </div>


                <div class="flex justify-center md:justify-start">
                    <button type="button" id="add-destino-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Destino
                    </button>
                </div>
            </div>


            <div id="valor-campos-container-wrapper" class="md:col-span-2 space-y-4">
                <div id="valor-campos-container" class="grid grid-cols-1 gap-4 md:gap-6">
                </div>

                <div class="flex justify-center md:justify-start">
                    <button type="button" id="add-valor-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Valor
                    </button>
                </div>
            </div>


            <div class="md:col-span-2">
                <label for="observacao" class="block text-sm font-medium text-gray-700">Observação:</label>
                <textarea id="observacao" name="observacao" rows="4"
                    class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"></textarea>
            </div>

            <div class="md:col-span-2 flex justify-center mt-4">
                <button type="submit"
                    class="w-full md:w-1/2 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Salvar Lançamento
                </button>
            </div>
        </form>


        <hr class="my-6 md:my-8 border-gray-300">


        <div class="flex flex-col gap-4 mb-6">
            <h2 class="text-xl font-bold text-gray-800">Gerar Relatório CSV</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início:</label>
                    <input type="date" id="start-date"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim:</label>
                    <input type="date" id="end-date"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4">
                <button type="button" id="download-csv"
                    class="flex-1 px-6 py-3 bg-lime-500 text-white font-bold rounded-lg shadow-lg hover:bg-lime-600 focus:outline-none focus:ring-4 focus:ring-lime-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Baixar Relatório CSV (Detalhado)
                </button>
                <button type="button" id="download-csv-custom"
                    class="flex-1 px-6 py-3 bg-cyan-500 text-white font-bold rounded-lg shadow-lg hover:bg-cyan-600 focus:outline-none focus:ring-4 focus:ring-cyan-400 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Baixar Relatório CSV (Simples)
                </button>
            </div>
        </div>

        <hr class="my-6 md:my-8 border-gray-300">

        <div class="flex flex-col md:flex-row justify-center gap-4">
            <button type="button" id="open-lancamentos-modal"
                class="px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-lg hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                Gerenciar Lançamentos
            </button>

            <button type="button" id="open-transportados-modal"
                class="px-6 py-3 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                Gerenciar Transportados
            </button>
            <button type="button" id="open-motoristas-modal"
                class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out hidden">
                Gerenciar Motoristas
            </button>
        </div>
    </div>

    <div id="transportados-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">

            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Transportados</h2>
                <button id="close-transportados-modal"
                    class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                <select id="sort-transportados-key"
                    class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="nome">Nome</option>
                    <option value="re">RE</option>
                </select>
                <select id="sort-transportados-order"
                    class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="asc">A-Z</option>
                    <option value="desc">Z-A</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                <div>
                    <label for="new-re" class="block text-sm font-medium text-gray-700">Novo RE:</label>
                    <input type="text" id="new-re"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="new-nome" class="block text-sm font-medium text-gray-700">Novo Transportado:</label>
                    <input type="text" id="new-nome"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="button" id="add-transportado"
                    class="px-6 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                    Adicionar
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full table-auto" id="transportados-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAllTransportados" class="rounded-sm">
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">
                                RE</th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/4">
                                Nome</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="delete-selected-transportados"
                    class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700">
                    Excluir Selecionados
                </button>
            </div>
        </div>
    </div>

    <div id="motoristas-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Motoristas</h2>
                <button id="close-motoristas-modal"
                    class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 items-start md:items-center mb-4 md:mb-6">
                <span class="text-sm font-medium text-gray-700">Ordenar por:</span>
                <select id="sort-motoristas-order"
                    class="w-full md:w-auto border border-gray-300 rounded-lg py-1 px-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="asc">A-Z</option>
                    <option value="desc">Z-A</option>
                </select>
            </div>
            
            <div class="border-t border-b border-gray-200 py-6 my-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Adicionar Novo Motorista/Usuário</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="new-motorista-nome" class="block text-sm font-medium text-gray-700">Nome do Motorista:</label>
                        <input type="text" id="new-motorista-nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="new-motorista-username" class="block text-sm font-medium text-gray-700">Usuário (login):</label>
                        <input type="text" id="new-motorista-username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="new-motorista-password" class="block text-sm font-medium text-gray-700">Senha:</label>
                        <input type="password" id="new-motorista-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center h-full">
                           <input type="checkbox" id="new-motorista-is-admin" class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                           <label for="new-motorista-is-admin" class="ml-2 block text-sm text-gray-900">É Administrador?</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="add-motorista" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700">
                        Adicionar Motorista
                    </button>
                </div>
            </div>


            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full table-auto" id="motoristas-table">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col"
                                class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAllMotoristas" class="rounded-sm">
                            </th>
                            <th scope="col"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-full">
                                Nome</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" id="delete-selected-motoristas"
                    class="px-4 py-2 bg-red-600 text-white font-bold rounded-lg shadow-lg hover:bg-red-700">
                    Excluir Selecionados
                </button>
            </div>
        </div>
    </div>

    <div id="lancamentos-modal"
        class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div
            class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content modal-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 relative">
                <div class="flex-grow flex justify-center">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Gerenciar Lançamentos</h2>
                </div>
                <button id="close-lancamentos-modal"
                    class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label for="filter-start-date" class="block text-sm font-medium text-gray-700">De:</label>
                    <input type="date" id="filter-start-date"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="filter-end-date" class="block text-sm font-medium text-gray-700">Até:</label>
                    <input type="date" id="filter-end-date"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-end">
                    <button id="filter-lancamentos-btn"
                        class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700">Filtrar</button>
                </div>
            </div>


            <div class="overflow-y-auto flex-grow">
                <table class="min-w-full table-auto" id="lancamentos-table">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden">
                                ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Motorista</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nº Borderô</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Solicitante(s)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Transportado(s)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Origem</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Destino(s)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Partida</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Valor Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Valor Extra Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Observação</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="edit-lancamento-modal"
        class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 relative">
                <div class="flex-grow flex justify-center">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800">Editar Lançamento</h2>
                </div>
                <button id="close-edit-lancamento-modal"
                    class="absolute top-0 right-0 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            </div>

            <form id="edit-lancamento-form" class="space-y-4">
                <input type="hidden" id="edit-lancamento-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-motorista"
                            class="block text-sm font-medium text-gray-700">Motorista:</label>
                        <input type="text" id="edit-motorista" list="motoristas-list"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="edit-data" class="block text-sm font-medium text-gray-700">Data:</label>
                        <input type="date" id="edit-data"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-bordero" class="block text-sm font-medium text-gray-700">Nº
                            Borderô:</label>
                        <input type="text" id="edit-bordero"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div></div>
                    <div id="edit-solicitante-campos-container" class="space-y-4">
                    </div>
                </div>

                <div class="md:col-span-2 flex justify-center md:justify-start">
                    <button type="button" id="add-edit-solicitante-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Solicitante
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-re" class="block text-sm font-medium text-gray-700">RE
                            (P1):</label>
                        <input type="text" id="edit-re" name="edit-res[]" list="transportados-re-list"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="edit-transportado" class="block text-sm font-medium text-gray-700">Transportado
                            (P1):</label>
                        <input type="text" id="edit-transportado" name="edit-transportados[]"
                            list="transportados-nome-list"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>

                <div id="edit-passageiros-extras-container" class="space-y-4 grid grid-cols-1 gap-4">
                </div>

                <div>
                    <button type="button" id="add-edit-passageiro-btn"
                        class="w-full px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Passageiro
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-row-align">
                        <div class="flex-grow">
                            <label for="edit-origem"
                                class="block text-sm font-medium text-gray-700">Origem:</label>
                            <input type="text" id="edit-origem"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>

                    <div class="form-row-align">
                        <div class="flex-grow">
                            <label for="edit-partida"
                                class="block text-sm font-medium text-gray-700">Partida:</label>
                            <input type="time" id="edit-partida" name="edit-partida"
                                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div id="edit-destino-campos-container" class="md:col-span-2 space-y-4">
                    </div>
                </div>

                <div class="md:col-span-2 flex justify-center md:justify-start">
                    <button type="button" id="add-edit-destino-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Outro Destino
                    </button>
                </div>

                <div id="edit-valor-campos-container" class="md:col-span-2 space-y-4">
                </div>

                <div class="md:col-span-2 flex justify-center md:justify-start">
                    <button type="button" id="add-edit-valor-btn"
                        class="w-full md:w-auto px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out">
                        + Adicionar Valor
                    </button>
                </div>

                <div>
                    <label for="edit-observacao"
                        class="block text-sm font-medium text-gray-700">Observação:</label>
                    <textarea id="edit-observacao" rows="3"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg"></textarea>
                </div>

                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-edit-btn"
                        class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar
                        Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center" style="z-index: 60;">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h2 class="text-xl font-bold mb-4">Aviso</h2>
            <p id="message-content" class="text-gray-700 mb-4"></p>
            <div class="flex justify-end">
                <button id="close-modal"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">OK</button>
            </div>
        </div>
    </div>

<div id="change-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800">Alterar Minha Senha</h2>
            <button id="close-change-password-modal" class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
        </div>
        <form id="change-password-form" class="space-y-4">
            <div>
                <label for="current-password" class="block text-sm font-medium text-gray-700">Senha Atual:</label>
                <input type="password" id="current-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="new-password" class="block text-sm font-medium text-gray-700">Nova Senha:</label>
                <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="confirm-new-password" class="block text-sm font-medium text-gray-700">Confirmar Nova Senha:</label>
                <input type="password" id="confirm-new-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <p id="change-password-message" class="text-red-500 text-sm text-center hidden"></p>
            <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="cancel-change-password-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova Senha</button>
            </div>
        </form>
    </div>
</div>

<div id="reset-password-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl modal-content max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl md:text-2xl font-bold text-gray-800">Redefinir Senha</h2>
            <button id="close-reset-password-modal" class="text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
        </div>
        <p class="mb-4">Redefinindo senha para o usuário: <strong id="reset-username-display"></strong></p>
        <form id="reset-password-form" class="space-y-4">
            <input type="hidden" id="reset-user-id">
            <div>
                <label for="admin-new-password" class="block text-sm font-medium text-gray-700">Digite a Nova Senha:</label>
                <input type="password" id="admin-new-password" required class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <p id="reset-password-message" class="text-red-500 text-sm text-center hidden"></p>
            <div class="flex justify-end gap-4 pt-4">
                <button type="button" id="cancel-reset-password-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Salvar Nova Senha</button>
            </div>
        </form>
    </div>
</div>

    <script type="module">
        // IMPORTAÇÕES
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, deleteDoc, onSnapshot, collection, doc, query, where, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDmqvcKtIsga4ZQWNDg4_2k493dqMQCDVg",
            authDomain: "teste-ebf38.firebaseapp.com",
            projectId: "teste-ebf38",
            storageBucket: "teste-ebf38.firebasestorage.app",
            messagingSenderId: "741884776297",
            appId: "1:741884776297:web:a23450b4909581a1b237f8",
            measurementId: "G-2MD5CFD51E"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = {
            username: null,
            isAdmin: false,
        };
        
        // ELEMENTOS DOM
        const loginForm = document.getElementById('login-form');
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const loginMessage = document.getElementById('login-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const logoutButton = document.getElementById('logout-btn');
        const motoristaInput = document.getElementById('motorista');
        const openMotoristasBtn = document.getElementById('open-motoristas-modal');
        const passageirosContainer = document.getElementById('passageiros-campos-container');
        const addPassageiroBtn = document.getElementById('add-passageiro-btn');
        const downloadCsvBtn = document.getElementById('download-csv');
        const downloadCsvCustomBtn = document.getElementById('download-csv-custom');
        const csvReportDiv = downloadCsvBtn.closest('.flex-col');
        const solicitanteContainer = document.getElementById('solicitante-campos-container');
        const addSolicitanteBtn = document.getElementById('add-solicitante-btn');
        const destinoContainer = document.getElementById('destino-campos-container');
        const addDestinoBtn = document.getElementById('add-destino-btn');
        const valorContainer = document.getElementById('valor-campos-container');
        const addValorBtn = document.getElementById('add-valor-btn');
        const editValorBtn = document.getElementById('add-edit-valor-btn');
	const openChangePasswordBtn = document.getElementById('open-change-password-btn');
	const changePasswordModal = document.getElementById('change-password-modal');
	const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal');
	const cancelChangePasswordBtn = document.getElementById('cancel-change-password-btn');
	const changePasswordForm = document.getElementById('change-password-form');
	const changePasswordMessage = document.getElementById('change-password-message');
	const resetPasswordModal = document.getElementById('reset-password-modal');
	const closeResetPasswordModalBtn = document.getElementById('close-reset-password-modal');
	const cancelResetPasswordBtn = document.getElementById('cancel-reset-password-btn');
	const resetPasswordForm = document.getElementById('reset-password-form');
	const resetPasswordMessage = document.getElementById('reset-password-message');
	const motoristasTable = document.getElementById('motoristas-table');

// --- LÓGICA PARA ALTERAR A PRÓPRIA SENHA ---

openChangePasswordBtn.addEventListener('click', () => {
    changePasswordForm.reset();
    changePasswordMessage.classList.add('hidden');
    changePasswordModal.classList.remove('hidden');
});

const closeChangePasswordModal = () => {
    changePasswordModal.classList.add('hidden');
};

closeChangePasswordModalBtn.addEventListener('click', closeChangePasswordModal);
cancelChangePasswordBtn.addEventListener('click', closeChangePasswordModal);

changePasswordForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    changePasswordMessage.classList.add('hidden');

    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmNewPassword = document.getElementById('confirm-new-password').value;

    // Validações
    if (!currentPassword || !newPassword || !confirmNewPassword) {
        changePasswordMessage.innerText = 'Todos os campos são obrigatórios.';
        changePasswordMessage.classList.remove('hidden');
        return;
    }
    if (newPassword !== confirmNewPassword) {
        changePasswordMessage.innerText = 'A nova senha e a confirmação não correspondem.';
        changePasswordMessage.classList.remove('hidden');
        return;
    }

    // Verifica a senha atual
    const storedUserData = JSON.parse(localStorage.getItem('loggedInUserData'));
    if (storedUserData.password !== currentPassword) {
        changePasswordMessage.innerText = 'A senha atual está incorreta.';
        changePasswordMessage.classList.remove('hidden');
        return;
    }

    if (newPassword === currentPassword) {
        changePasswordMessage.innerText = 'A nova senha deve ser diferente da atual.';
        changePasswordMessage.classList.remove('hidden');
        return;
    }


    try {
        const userDocRef = doc(db, 'users', storedUserData.id);
        await updateDoc(userDocRef, {
            password: newPassword
        });

        // ATUALIZA O LOCALSTORAGE TAMBÉM!
        const updatedUserData = { ...storedUserData, password: newPassword };
        localStorage.setItem('loggedInUserData', JSON.stringify(updatedUserData));

        showWarning('Senha alterada com sucesso!');
        closeChangePasswordModal();

    } catch (error) {
        console.error("Erro ao atualizar senha:", error);
        changePasswordMessage.innerText = 'Erro ao conectar com o servidor.';
        changePasswordMessage.classList.remove('hidden');
    }
});


// --- LÓGICA PARA ADMIN REDEFINIR SENHA ---

motoristasTable.addEventListener('click', (event) => {
    const resetButton = event.target.closest('.reset-password-btn');
    if (resetButton) {
        const userId = resetButton.dataset.id;
        const username = resetButton.dataset.username;

        resetPasswordForm.reset();
        resetPasswordMessage.classList.add('hidden');
        document.getElementById('reset-user-id').value = userId;
        document.getElementById('reset-username-display').innerText = username;
        resetPasswordModal.classList.remove('hidden');
    }
});

const closeResetPasswordModal = () => {
    resetPasswordModal.classList.add('hidden');
};

closeResetPasswordModalBtn.addEventListener('click', closeResetPasswordModal);
cancelResetPasswordBtn.addEventListener('click', closeResetPasswordModal);

resetPasswordForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    resetPasswordMessage.classList.add('hidden');

    const userId = document.getElementById('reset-user-id').value;
    const newPassword = document.getElementById('admin-new-password').value;

    if (!newPassword) {
        resetPasswordMessage.innerText = 'O campo de nova senha é obrigatório.';
        resetPasswordMessage.classList.remove('hidden');
        return;
    }

    try {
        const userDocRef = doc(db, 'users', userId);
        await updateDoc(userDocRef, {
            password: newPassword
        });
        showWarning(`Senha do usuário foi redefinida com sucesso!`);
        closeResetPasswordModal();
    } catch (error) {
        console.error("Erro ao redefinir a senha:", error);
        resetPasswordMessage.innerText = 'Erro ao conectar com o servidor.';
        resetPasswordMessage.classList.remove('hidden');
    }
});

        // === DADOS GLOBAIS ===
        let transportadosData = [];
        let usersData = []; // Substituído motoristasData por usersData
        let lancamentosData = [];
        let reToNome = {};
        let nomeToRE = {};

        // === FUNÇÕES DE VALIDAÇÃO E INTERFACE ===

        function showWarning(message) {
            document.getElementById('message-content').innerText = message;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function hideWarning() {
            document.getElementById('message-modal').classList.add('hidden');
        }

        // NOVA FUNÇÃO para configurar a interface com base nos dados do usuário do Firestore
        function setMotoristaFromData(userData) {
            currentUser.username = userData.username;
            currentUser.isAdmin = userData.is_admin || false;

            userIdDisplay.classList.add('hidden'); // Oculta o ID antigo

            csvReportDiv.classList.remove('hidden');

            if (currentUser.isAdmin) {
                openMotoristasBtn.classList.remove('hidden');
            } else {
                openMotoristasBtn.classList.add('hidden');
            }

            if (userData.is_motorista_fixo) {
                motoristaInput.value = userData.nome;
                motoristaInput.setAttribute('readonly', 'readonly');
                motoristaInput.classList.add('bg-gray-200');
            } else {
                motoristaInput.removeAttribute('readonly');
                motoristaInput.classList.remove('bg-gray-200');
                motoristaInput.value = userData.nome || '';
            }
        }

        function checkPassageiroDuplicidade(sourceInput) {
            const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
            const row = sourceInput.closest('.passageiro-row');
            const currentREInput = row.querySelector('input[name="res[]"]');
            const currentNomeInput = row.querySelector('input[name="transportados[]"]');
            const currentRE = currentREInput.value.trim();
            const currentNome = currentNomeInput.value.trim();
            if (currentRE === '' || currentNome === '') {
                currentREInput.classList.remove('error-border');
                currentNomeInput.classList.remove('error-border');
                return false;
            }

            const currentKey = `${currentRE}_${currentNome.toLowerCase()}`;
            let isDuplicated = false;

            rows.forEach(r => {
                r.querySelector('input[name="res[]"]').classList.remove('error-border');
                r.querySelector('input[name="transportados[]"]').classList.remove('error-border');
            });
            rows.forEach(rowToCheck => {
                const rowRE = rowToCheck.querySelector('input[name="res[]"]').value.trim();
                const rowNome = rowToCheck.querySelector('input[name="transportados[]"]').value.trim();
                const rowKey = `${rowRE}_${rowNome.toLowerCase()}`;
                const isSameRow = (rowToCheck === row);

                if (rowKey === currentKey && !isSameRow) {
                    isDuplicated = true;
                    rowToCheck.querySelector('input[name="res[]"]').classList.add('error-border');
                    rowToCheck.querySelector('input[name="transportados[]"]').classList.add('error-border');
                }
            });
            if (isDuplicated) {
                currentREInput.classList.add('error-border');
                currentNomeInput.classList.add('error-border');
                showWarning(`Passageiro duplicado encontrado: RE ${currentRE} e Nome ${currentNome}.`);
            }

            return isDuplicated;
        }

        function handleAutofillDynamic(sourceInput, targetInput, sourceType) {
            const value = sourceInput.value.trim();
            if (value !== '') {
                let targetValue = '';
                if (sourceType === 're') {
                    targetValue = reToNome[value];
                } else if (sourceType === 'nome') {
                    targetValue = nomeToRE[value.toLowerCase()];
                }

                if (targetValue) {
                    targetInput.value = targetValue;
                    targetInput.classList.remove('error-border');
                } else {
                    targetInput.value = '';
                }
            } else {
                targetInput.value = '';
            }

            setTimeout(() => checkPassageiroDuplicidade(sourceInput), 50);
        }

function checkEditPassageiroDuplicidade() {
            const allPassengerInputs = [];
            const p1Row = {
                reInput: document.getElementById('edit-re'),
                nomeInput: document.getElementById('edit-transportado')
            };
            allPassengerInputs.push(p1Row);

            const extraRows = document.querySelectorAll('#edit-passageiros-extras-container .edit-passageiro-row');
            extraRows.forEach(row => {
                allPassengerInputs.push({
                    reInput: row.querySelector('input[name="edit-res[]"]'),
                    nomeInput: row.querySelector('input[name="edit-transportados[]"]')
                });
            });

            // Limpa bordas de erro anteriores
            allPassengerInputs.forEach(pair => {
                if(pair.reInput) pair.reInput.classList.remove('error-border');
                if(pair.nomeInput) pair.nomeInput.classList.remove('error-border');
            });

            const seen = new Map();
            let isDuplicated = false;

            allPassengerInputs.forEach(pair => {
                if (!pair.reInput || !pair.nomeInput) return;
                
                const re = pair.reInput.value.trim();
                const nome = pair.nomeInput.value.trim().toLowerCase();

                if (re === '' || nome === '') return; 

                const key = `${re}_${nome}`;

                if (seen.has(key)) {
                    isDuplicated = true;
                    // Marca a linha atual como duplicada
                    pair.reInput.classList.add('error-border');
                    pair.nomeInput.classList.add('error-border');
                    
                    // Marca a primeira linha encontrada com a mesma combinação
                    const firstSeenPair = seen.get(key);
                    firstSeenPair.reInput.classList.add('error-border');
                    firstSeenPair.nomeInput.classList.add('error-border');
                } else {
                    seen.set(key, pair);
                }
            });
            
            if (isDuplicated) {
                showWarning('Passageiro duplicado encontrado no formulário de edição.');
            }
            return isDuplicated;
        }


        // --- Lógica Solicitante/Destino/Valor Dinâmico (Página Principal) ---

        function updateDynamicLabels(containerId, inputName, baseLabel) {
            const rows = document.querySelectorAll(`#${containerId} .dynamic-row`);
            rows.forEach((row, index) => {
                const pNum = index + 1;
                const label = row.querySelector('label');
                const input = row.querySelector('input');

                if (label) {
                    label.textContent = index === 0 ? baseLabel + ':' : `${baseLabel} (P${pNum}):`;
                }
                
                if (containerId === 'solicitante-campos-container' && index === 0 && input) {
                    input.id = 'solicitante';
                    input.name = 'solicitantes[]';
                }
                if (containerId === 'destino-campos-container' && index === 0) {
                    const destinoInput = row.querySelector('input[name="destinos[]"]');
                    if (destinoInput) destinoInput.id = 'destino';
                    const chegadaInput = row.querySelector('input[name="chegadas_destino[]"]');
                    if (chegadaInput) chegadaInput.id = 'chegada_destino_p1';
                }

                if (containerId === 'valor-campos-container') {
                    const valorInput = row.querySelector('input[name="valores[]"]');
                    const valorExtraInput = row.querySelector('input[name="valores_extra[]"]');

                    if (valorInput) {
                        valorInput.id = index === 0 ? 'valor' : `valor-${pNum}`;
                        valorInput.name = 'valores[]';
                        valorInput.classList.remove('error-border'); 
                        valorInput.addEventListener('input', () => formatCurrencyInput(valorInput));
                        valorInput.addEventListener('focus', () => { if (valorInput.value === '0,00') valorInput.value = ''; });
                        valorInput.addEventListener('blur', () => { if (valorInput.value === '') valorInput.value = '0,00'; });
                        if (valorInput.value === '') valorInput.value = '0,00';
                    }

                    if (valorExtraInput) {
                        valorExtraInput.id = index === 0 ? 'valor-extra' : `valor-extra-${pNum}`;
                        valorExtraInput.name = 'valores_extra[]';
                        valorExtraInput.classList.remove('error-border'); 
                        valorExtraInput.addEventListener('input', () => formatCurrencyInput(valorExtraInput));
                        valorExtraInput.addEventListener('focus', () => { if (valorExtraInput.value === '0,00') valorExtraInput.value = ''; });
                        valorExtraInput.addEventListener('blur', () => { if (valorExtraInput.value === '') valorExtraInput.value = '0,00'; });
                        if (valorExtraInput.value === '') valorExtraInput.value = '0,00';
                    }
                }

                const removeBtn = row.querySelector('.remove-dynamic-btn');
                if (removeBtn) {
                    if (index === 0) {
                        removeBtn.classList.add('hidden');
                    } else {
                        removeBtn.classList.remove('hidden');
                        removeBtn.onclick = () => {
                            row.remove();
                            updateDynamicLabels(containerId, inputName, baseLabel);
                        };
                    }
                }
            });
        }

        function createSolicitanteInput(index, isRequired = true) {
            const fieldset = document.createElement('div');
            fieldset.className = 'dynamic-row form-row-align';

            const pNum = document.querySelectorAll(`#solicitante-campos-container .dynamic-row`).length + 1;
            const labelText = isRequired ? 'Solicitante:' : `Solicitante (P${pNum}):`;
            fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="solicitante-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                    <input type="text" id="solicitante-${index}" name="solicitantes[]"
                        onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                    -
                </button>
            `;
            const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
            if (removeBtn && !isRequired) {
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateDynamicLabels('solicitante-campos-container', 'solicitante', 'Solicitante');
                };
            }
            return fieldset;
        }

        function createDestinoInput(index, isRequired = true) {
            const fieldset = document.createElement('div');
            fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6';
            fieldset.dataset.pNum = (document.querySelectorAll(`#destino-campos-container .dynamic-row`).length + 1);

            const pNum = fieldset.dataset.pNum;
            const labelText = isRequired ? 'Destino:' : `Destino (P${pNum}):`;
            const labelTime = isRequired ? 'Chegada (Horário):' : `Chegada (P${pNum}):`;
            fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="destino-${index}" class="block text-sm font-medium text-gray-700">${labelText}</label>
                        <input type="text" id="destino-${index}" name="destinos[]"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-dynamic-btn ${isRequired ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="chegada-destino-${index}" class="block text-sm font-medium text-gray-700">${labelTime}</label>
                        <input type="time" id="chegada-destino-${index}" name="chegadas_destino[]"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                </div>
            `;
            const removeBtn = fieldset.querySelector('.remove-dynamic-btn');
            if (removeBtn && !isRequired) {
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateDynamicLabels('destino-campos-container', 'destino', 'Destino');
                };
            }
            return fieldset;
        }

        function createValorInput(pNum, isRequired = true) {
            const fieldset = document.createElement('div');
            fieldset.className = 'dynamic-row grid grid-cols-2 gap-4 md:gap-6 valor-row';
            fieldset.dataset.pNum = pNum;
            const isP1 = pNum === 1;
            const labelValor = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
            const labelValorExtra = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
            const inputIdValor = pNum === 1 ? 'valor' : `valor-${pNum}`;
            const inputIdValorExtra = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
            fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="valores[]"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out text-right">
                    </div>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                        <div class="relative mt-1">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                            <input type="text" id="${inputIdValorExtra}" name="valores_extra[]"
                                class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:focus:border-blue-500 transition duration-150 ease-in-out text-right">
                        </div>
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-valor-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
            `;

            const removeBtn = fieldset.querySelector('.remove-valor-btn');
            if (removeBtn && !isP1) {
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateValueLabels();
                };
            }
            return fieldset;
        }

        function removeValueRow(pNumToRemove) {
            const rowToRemove = document.querySelector(`#valor-campos-container .valor-row[data-p-num="${pNumToRemove}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
                updateValueLabels();
            }
        }

        function updateValueLabels() {
            const rows = document.querySelectorAll(`#valor-campos-container .valor-row`);
            rows.forEach((row, index) => {
                const pNum = index + 1;
                row.dataset.pNum = pNum;

                const labelValor = row.querySelector(`label[for^="valor"]`);
                const labelValorExtra = row.querySelector(`label[for^="valor-extra"]`);
                const inputValor = row.querySelector('input[name="valores[]"]');
                const inputValorExtra = row.querySelector('input[name="valores_extra[]"]');
                const removeBtn = row.querySelector('.remove-valor-btn');

                if (labelValor) labelValor.textContent = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
                if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
                if (inputValor) inputValor.id = pNum === 1 ? 'valor' : `valor-${pNum}`;
                if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'valor-extra' : `valor-extra-${pNum}`;
                if (removeBtn) {
                    if (pNum === 1) removeBtn.classList.add('hidden');
                    else removeBtn.classList.remove('hidden');
                }

                if (inputValor) {
                    inputValor.removeEventListener('input', formatCurrencyInput);
                    inputValor.addEventListener('input', () => formatCurrencyInput(inputValor));
                    inputValor.removeEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                    inputValor.addEventListener('focus', () => { if (inputValor.value === '0,00') inputValor.value = ''; });
                    inputValor.removeEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                    inputValor.addEventListener('blur', () => { if (inputValor.value === '') inputValor.value = '0,00'; });
                }
                if (inputValorExtra) {
                    inputValorExtra.removeEventListener('input', formatCurrencyInput);
                    inputValorExtra.addEventListener('input', () => formatCurrencyInput(inputValorExtra));
                    inputValorExtra.removeEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                    inputValorExtra.addEventListener('focus', () => { if (inputValorExtra.value === '0,00') inputValorExtra.value = ''; });
                    inputValorExtra.removeEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                    inputValorExtra.addEventListener('blur', () => { if (inputValorExtra.value === '') inputValorExtra.value = '0,00'; });
                }
            });
        }

        function addDynamicRow(containerId, inputName, baseLabel, isRequired = false) {
            const container = document.getElementById(containerId);
            let newRow;

            if (inputName === 'destino') {
                newRow = createDestinoInput(Date.now(), isRequired);
            } else if (inputName === 'solicitante') {
                newRow = createSolicitanteInput(Date.now(), isRequired);
            } else if (inputName === 'valor') {
                newRow = createValorInput(document.querySelectorAll(`#valor-campos-container .valor-row`).length + 1, false);
            }

            if (newRow) {
                container.appendChild(newRow);
                updateDynamicLabels(containerId, inputName, baseLabel);
            }
        }
        addValorBtn.addEventListener('click', () => addDynamicRow('valor-campos-container', 'valor', 'Valor', false));
        
        // --- Lógica Passageiros (Transportados) ---
        function updatePassageiroLabels() {
            const rows = document.querySelectorAll('#passageiros-campos-container .passageiro-row');
            rows.forEach((row, index) => {
                const pNum = index + 1;
                const reLabel = row.querySelector(`label[for^="re-"]`);
                const transportadoLabel = row.querySelector(`label[for^="transportado-"]`);

                if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`;

                const removeBtn = row.querySelector('.remove-passageiro-btn');
                if (removeBtn) {
                    if (index === 0) {
                        removeBtn.classList.add('hidden');
                    } else {
                        removeBtn.classList.remove('hidden');
                        removeBtn.onclick = () => {
                            row.remove();
                            updatePassageiroLabels();
                        };
                    }
                }
            });
        }

        function createPassageiroInput(index, isRequired = true) {
            const fieldset = document.createElement('div');
            fieldset.className = 'passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6';
            fieldset.dataset.index = index;
            fieldset.innerHTML = `
                <div>
                    <label for="re-${index}" class="block text-sm font-medium text-gray-700">RE (P${index + 1}):</label>
                    <input type="text" id="re-${index}" name="res[]" list="transportados-re-list"
                        onfocus="this.classList.remove('error-border')"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label for="transportado-${index}" class="block text-sm font-medium text-gray-700">Transportado (P${index + 1}):</label>
                        <input type="text" id="transportado-${index}" name="transportados[]" list="transportados-nome-list"
                            onfocus="this.classList.remove('error-border')"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-passageiro-btn ${isRequired ? 'hidden' : ''}">
                    -
                    </button>
                </div>
            `;
            return fieldset;
        }

        function addPassageiroRow(isRequired = false) {
            const newIndex = Date.now();
            const newRow = createPassageiroInput(newIndex, isRequired);
            passageirosContainer.appendChild(newRow);
            updatePassageiroLabels();
        }


        // --- INICIALIZAÇÃO E EVENTOS GLOBAIS ---
        window.onload = () => {
            const loggedInUserData = localStorage.getItem('loggedInUserData');
            if (loggedInUserData) {
                try {
                    const userData = JSON.parse(loggedInUserData);
                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    setMotoristaFromData(userData); // Usa a nova função
                } catch (e) {
                    // Se os dados estiverem corrompidos, limpa e força o login
                    localStorage.removeItem('loggedInUser');
                    localStorage.removeItem('loggedInUserData');
                    loginPage.classList.remove('hidden');
                    appPage.classList.add('hidden');
                }
            } else {
                 loginPage.classList.remove('hidden');
                 appPage.classList.add('hidden');
            }

            function bindPassageiroListeners() {
                passageirosContainer.addEventListener('blur', (event) => {
                    const input = event.target;
                    if (input.matches('input[name="res[]"]') || input.matches('input[name="transportados[]"]')) {
                        const row = input.closest('.passageiro-row');
                        const reInput = row.querySelector('input[name="res[]"]');
                        const nomeInput = row.querySelector('input[name="transportados[]"]');
                        if (input.name === 'res[]') {
                            handleAutofillDynamic(reInput, nomeInput, 're');
                        } else if (input.name === 'transportados[]') {
                            handleAutofillDynamic(nomeInput, reInput, 'nome');
                        }
                    }
                }, true);
            }

            addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);
            addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
            addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
            addPassageiroRow(true);

            bindPassageiroListeners();
            addPassageiroBtn.addEventListener('click', () => addPassageiroRow(false));
            addSolicitanteBtn.addEventListener('click', () => addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', false));
            addDestinoBtn.addEventListener('click', () => {
                addDynamicRow('destino-campos-container', 'destino', 'Destino', false);
            });
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    startFirestoreListeners();
                } else {
                    if (!localStorage.getItem('loggedInUserData')) {
                        loginPage.classList.remove('hidden');
                        appPage.classList.add('hidden');
                    }
                }
            });
            signInAnonymously(auth).catch((error) => console.error("Erro no login anônimo:", error));
        };

        // LÓGICA DE LOGIN ATUALIZADA
        loginForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            loginMessage.classList.add('hidden');

            const usersRef = collection(db, 'users');
            const q = query(usersRef, where("username", "==", username), where("password", "==", password));

            try {
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = { id: userDoc.id, ...userDoc.data() };

                    localStorage.setItem('loggedInUser', username);
                    localStorage.setItem('loggedInUserData', JSON.stringify(userData));

                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    setMotoristaFromData(userData);
                } else {
                    loginMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                loginMessage.innerText = 'Erro ao conectar com o servidor.';
                loginMessage.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('loggedInUserData'); // Limpa os dados do usuário
            signOut(auth).then(() => {
                window.location.reload();
            });
        });

        // NOVA FUNÇÃO para tornar linhas de tabela clicáveis
        function makeTableRowsClickable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const tableBody = table.querySelector('tbody');
            if (!tableBody) return;

            tableBody.addEventListener('click', function(event) {
                if (event.target.type === 'checkbox') {
                    return;
                }
                const row = event.target.closest('tr');
                if (!row) return;
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
            });
        }
        
        // LISTENERS DO FIRESTORE ATUALIZADOS
        function startFirestoreListeners() {
            const transportadosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados');
            onSnapshot(transportadosRef, (snapshot) => {
                transportadosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rebuildTransportadosLookups();
            });

            // Ouve a coleção 'users' em vez de 'motoristas'
            const usersRef = collection(db, 'users');
            onSnapshot(usersRef, (snapshot) => {
                usersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rebuildMotoristasLookups();
            });

            const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
            onSnapshot(lancamentosRef, (snapshot) => {
                lancamentosData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });

            // Ativa a funcionalidade de clique nas tabelas
            makeTableRowsClickable('transportados-table');
            makeTableRowsClickable('motoristas-table');
        }

        function rebuildTransportadosLookups(sortKey = 'nome', sortOrder = 'asc') {
            transportadosData.sort((a, b) => {
                let valA = a[sortKey] || '';
                let valB = b[sortKey] || '';
                return sortOrder === 'asc' ? valA.localeCompare(valB, undefined, { numeric: true }) : valB.localeCompare(valA, undefined, { numeric: true });
            });
            reToNome = {};
            nomeToRE = {};
            transportadosData.forEach(item => {
                reToNome[item.re] = item.nome;
                nomeToRE[item.nome.toLowerCase()] = item.re;
            });
            renderTransportadosList();
        }

        // ATUALIZADO para usar 'usersData'
        function rebuildMotoristasLookups(sortOrder = 'asc') {
            usersData.sort((a, b) => sortOrder === 'asc' ? a.nome.localeCompare(b.nome) : b.nome.localeCompare(a.nome));
            renderMotoristasList();
            populateMotoristasDatalist();
        }

        function formatCurrencyInput(input) {
            if (!input) return;
            let value = input.value.replace(/\D/g, '');
            if (value === '') {
                input.value = '0,00';
                return;
            }
            value = value.padStart(3, '0');
            const integerPart = value.slice(0, -2);
            const decimalPart = value.slice(-2);
            const formattedInteger = parseInt(integerPart, 10).toLocaleString('pt-BR');
            input.value = `${formattedInteger},${decimalPart}`;
        }

        function parseCurrencyValue(value) {
            if (typeof value !== 'string' || value.trim() === '') return 0;
            return parseFloat(value.replace(/\./g, '').replace(',', '.'));
        }

        document.getElementById('form-corrida').addEventListener('submit', async function (event) {
            event.preventDefault();
            const form = event.target;
            const requiredFields = ['motorista', 'data', 'origem', 'partida', 'valor'];

            const solicitantesInputs = document.querySelectorAll('#solicitante-campos-container input[name="solicitantes[]"]');
            const destinosInputs = document.querySelectorAll('#destino-campos-container input[name="destinos[]"]');
            const chegadasDestinoInputs = document.querySelectorAll('#destino-campos-container input[name="chegadas_destino[]"]');
            const valoresInputs = document.querySelectorAll('#valor-campos-container input[name="valores[]"]');
            const valoresExtraInputs = document.querySelectorAll('#valor-campos-container input[name="valores_extra[]"]');
            const resInputs = document.querySelectorAll('#passageiros-campos-container input[name="res[]"]');
            const transportadosInputs = document.querySelectorAll('#passageiros-campos-container input[name="transportados[]"]');

            let isFormValid = true;

            requiredFields.forEach(field => {
                const input = form[field];
                if (input && input.value.trim() === '') {
                    isFormValid = false;
                    input.classList.add('error-border');
                } else if (input) {
                    input.classList.remove('error-border');
                }
            });
            const solicitantesData = [];
            solicitantesInputs.forEach(input => {
                const value = input.value.trim();
                if (value !== '') {
                    solicitantesData.push(value);
                }
            });
            if (solicitantesData.length === 0) {
                isFormValid = false;
                if (solicitantesInputs[0]) solicitantesInputs[0].classList.add('error-border');
            } else {
                if (solicitantesInputs[0]) solicitantesInputs[0].classList.remove('error-border');
            }

            const destinosData = [];
            const chegadasDestinoData = [];
            let destinoChegadaIncompleto = false;

            for (let i = 0; i < destinosInputs.length; i++) {
                const destino = destinosInputs[i].value.trim();
                const chegada = chegadasDestinoInputs[i].value.trim();

                if (destino !== '' && chegada !== '') {
                    destinosData.push(destino);
                    chegadasDestinoData.push(chegada);
                } else if (destino !== '' || chegada !== '') {
                    destinoChegadaIncompleto = true;
                    destinosInputs[i].classList.add('error-border');
                    chegadasDestinoInputs[i].classList.add('error-border');
                }
            }

            if (destinoChegadaIncompleto) {
                isFormValid = false;
            }

            if (destinosData.length === 0) {
                isFormValid = false;
                if (destinosInputs[0]) destinosInputs[0].classList.add('error-border');
                if (chegadasDestinoInputs[0]) chegadasDestinoInputs[0].classList.add('error-border');
            } else {
                if (destinosInputs[0]) destinosInputs[0].classList.remove('error-border');
                if (chegadasDestinoInputs[0]) chegadasDestinoInputs[0].classList.remove('error-border');
            }

            const valoresData = [];
            const valoresExtraData = [];
            for (let i = 0; i < valoresInputs.length; i++) {
                const valor = parseCurrencyValue(valoresInputs[i].value);
                const valorExtra = parseCurrencyValue(valoresExtraInputs[i].value);
                valoresData.push(valor);
                valoresExtraData.push(valorExtra);
            }

            const passageirosData = [];
            const passageirosSet = new Set();
            for (let i = 0; i < resInputs.length; i++) {
                const reInput = resInputs[i];
                const nomeInput = transportadosInputs[i];
                const re = reInput.value.trim();
                const nome = nomeInput.value.trim();

                reInput.classList.remove('error-border');
                nomeInput.classList.remove('error-border');
                if (re !== '' && nome !== '') {
                    const key = `${re}_${nome.toLowerCase()}`;
                    if (passageirosSet.has(key)) {
                        isFormValid = false;
                        reInput.classList.add('error-border');
                        nomeInput.classList.add('error-border');
                        showWarning(`Passageiro duplicado: ${nome}.`);
                        return;
                    }
                    passageirosSet.add(key);
                    passageirosData.push({ re: re, nome: nome });
                } else if (re !== '' || nome !== '') {
                    isFormValid = false;
                    if (re === '') reInput.classList.add('error-border');
                    if (nome === '') nomeInput.classList.add('error-border');
                }
            }

            if (passageirosData.length === 0) {
                isFormValid = false;
                if (resInputs[0]) resInputs[0].classList.add('error-border');
                if (transportadosInputs[0]) transportadosInputs[0].classList.add('error-border');
            }

            if (!isFormValid) {
                showWarning('Preencha todos os campos obrigatórios e verifique por duplicidades.');
                return;
            }

            const destinosExtras = [];
            const numDestinosExtras = destinosData.length - 1;
            const numValoresExtras = valoresData.length - 1;
            const extraCount = Math.min(numDestinosExtras, numValoresExtras);
            for (let i = 1; i <= extraCount; i++) {
                destinosExtras.push({
                    destino: destinosData[i],
                    chegada: chegadasDestinoData[i],
                    valor: valoresData[i],
                    valorExtra: valoresExtraData[i]
                });
            }

            const newEntry = {
                createdBy: currentUser.username,
                motorista: form['motorista'].value,
                bordero: form['bordero'].value.trim(),
                re: passageirosData[0].re,
                transportado: passageirosData[0].nome,
                passageiros_extras: passageirosData.length > 1 ? passageirosData.slice(1) : [],
                solicitante: solicitantesData[0],
                solicitantes_extras: solicitantesData.length > 1 ? solicitantesData.slice(1) : [],
                data: form['data'].value,
                origem: form['origem'].value,
                destino: destinosData[0],
                chegada_destino: chegadasDestinoData[0],
                valor: valoresData[0],
                valorExtra: valoresExtraData[0],
                destinos_extras: destinosExtras,
                partida: form['partida'].value,
                observacao: form['observacao'].value,
                createdAt: serverTimestamp()
            };
            const lancamentosRef = collection(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos');
            await addDoc(lancamentosRef, newEntry);

            showWarning('Lançamento salvo com sucesso!');
            form.reset();
            
            solicitanteContainer.innerHTML = '';
            addDynamicRow('solicitante-campos-container', 'solicitante', 'Solicitante', true);
            destinoContainer.innerHTML = '';
            addDynamicRow('destino-campos-container', 'destino', 'Destino', true);
            valorContainer.innerHTML = '';
            addDynamicRow('valor-campos-container', 'valor', 'Valor', true);
            passageirosContainer.innerHTML = '';
            addPassageiroRow(true);
        });

        // O resto do seu código (download-csv, modais, etc.) permanece o mesmo...
        // ... cole o resto do seu JS a partir daqui, com as seguintes exceções:

        document.getElementById('download-csv').addEventListener('click', async function () {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showWarning('A data de início não pode ser posterior à data de fim.');
                return;
            }

            let dataToDownload = lancamentosData;
            if (startDate || endDate) {
                dataToDownload = dataToDownload.filter(item => {
                    const itemDate = new Date(item.data);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && itemDate < start) return false;
                    if (end && itemDate > end) return false;
                    return true;
                });
            }

            if (!currentUser.isAdmin) {
                dataToDownload = dataToDownload.filter(item => item.createdBy === currentUser.username);
            }

            if (dataToDownload.length === 0) {
                showWarning('Nenhum dado encontrado para este período/permissão.');
                return;
            }

            const bom = '\uFEFF';
            const maxExtras = 3;

            const csvHeaders = [
                'DATA', 'MOTORISTA', 'Nº BORDERÔ', 'SOLICITANTE P1', 'PASSAGEIRO P1',
                'VALOR NORMAL P1', 'VALOR EXTRA P1',
                'ORIGEM', 'PARTIDA', 'DESTINO P1', 'CHEGADA P1',
            ];
            const extraHeaders = [];
            for (let i = 1; i <= maxExtras; i++) {
                const pNum = i + 1;
                extraHeaders.push(
                    `SOLICITANTE EXTRA ${i}`,
                    `PASSAGEIRO EXTRA ${i}`,
                    `VALOR NORMAL P${pNum}`, `VALOR EXTRA P${pNum}`
                );
            }
            extraHeaders.push('OBSERVAÇÃO');
            const finalHeaders = [...csvHeaders, ...extraHeaders];
            const rows = dataToDownload.map(obj => {
                const solicitantes = [obj.solicitante || '', ...(obj.solicitantes_extras || [])];
                const passageiros = [{ nome: obj.transportado || '' }, ...(obj.passageiros_extras || [])];
                const destinosValores = [{
                    destino: obj.destino || '',
                    chegada: obj.chegada_destino || '',
                    valor: obj.valor || 0,
                    valorExtra: obj.valorExtra || 0,
                }, ...(obj.destinos_extras || [])];

                const rowData = [
                    obj.data || '',
                    obj.motorista || '',
                    obj.bordero || '',
                    solicitantes[0] || '',
                    passageiros[0].nome || '',
                    (destinosValores[0].valor || 0).toFixed(2).replace('.', ','),
                    (destinosValores[0].valorExtra || 0).toFixed(2).replace('.', ','),
                    obj.origem || '',
                    obj.partida || '',
                    destinosValores[0].destino || '',
                    destinosValores[0].chegada || '',
                ];
                const extraData = [];

                for (let i = 1; i <= maxExtras; i++) {
                    const solicitanteExtra = solicitantes[i] || '';
                    const passageiroExtraNome = (passageiros[i] && passageiros[i].nome) ? passageiros[i].nome : '';
                    const destinoValorObj = destinosValores[i] || { valor: 0, valorExtra: 0 };
                    const valorNormal_Pn = (destinoValorObj.valor || 0).toFixed(2).replace('.', ',');
                    const valorExtra_Pn = (destinoValorObj.valorExtra || 0).toFixed(2).replace('.', ',');
                    extraData.push(
                        solicitanteExtra,
                        passageiroExtraNome,
                        valorNormal_Pn,
                        valorExtra_Pn
                    );
                }

                extraData.push(obj.observacao || '');
                return [...rowData, ...extraData].map(value => `"${String(value).replace(/"/g, '""')}"`).join(';');
            }).join('\n');


            const csvContent = `${finalHeaders.join(';')}\n${rows}`;
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lancamentos_detalhado_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('download-csv-custom').addEventListener('click', async function () {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
                showWarning('A data de início não pode ser posterior à data de fim.');
                return;
            }

            let dataToDownload = lancamentosData;
            if (startDate || endDate) {
                dataToDownload = dataToDownload.filter(item => {
                    const itemDate = new Date(item.data);
                    const start = startDate ? new Date(startDate) : null;
                    const end = endDate ? new Date(endDate) : null;
                    if (start && itemDate < start) return false;
                    if (end && itemDate > end) return false;
                    return true;
                });
            }

            if (!currentUser.isAdmin) {
                dataToDownload = dataToDownload.filter(item => item.createdBy === currentUser.username);
            }

            if (dataToDownload.length === 0) {
                showWarning('Nenhum dado encontrado para este período/permissão.');
                return;
            }

            const bom = '\uFEFF';
            const maxExtras = 3;

            const csvHeaders = [
                'DATA', 'SOLICITANTE P1', 'PASSAGEIRO P1',
                'VALOR NORMAL P1', 'VALOR EXTRA P1'
            ];
            const extraHeaders = [];
            for (let i = 1; i <= maxExtras; i++) {
                const pNum = i + 1;
                extraHeaders.push(
                    `SOLICITANTE EXTRA ${i}`,
                    `PASSAGEIRO EXTRA ${i}`,
                    `VALOR NORMAL P${pNum}`, `VALOR EXTRA P${pNum}`
                );
            }

            const finalHeaders = [...csvHeaders, ...extraHeaders];
            const rows = dataToDownload.map(obj => {
                const solicitantes = [obj.solicitante || '', ...(obj.solicitantes_extras || [])];
                const passageiros = [{ nome: obj.transportado || '' }, ...(obj.passageiros_extras || [])];
                const destinosValores = [{
                    valor: obj.valor || 0,
                    valorExtra: obj.valorExtra || 0,
                }, ...(obj.destinos_extras || [])];

                const rowData = [
                    obj.data || '',
                    solicitantes[0] || '',
                    passageiros[0].nome || '',
                    (destinosValores[0].valor || 0).toFixed(2).replace('.', ','),
                    (destinosValores[0].valorExtra || 0).toFixed(2).replace('.', ',')
                ];
                const extraData = [];
                for (let i = 1; i <= maxExtras; i++) {
                    const solicitanteExtra = solicitantes[i] || '';
                    const passageiroExtraNome = (passageiros[i] && passageiros[i].nome) ? passageiros[i].nome : '';
                    const destinoValorObj = destinosValores[i] || { valor: 0, valorExtra: 0 };
                    const valorNormal_Pn = (destinoValorObj.valor || 0).toFixed(2).replace('.', ',');
                    const valorExtra_Pn = (destinoValorObj.valorExtra || 0).toFixed(2).replace('.', ',');
                    extraData.push(
                        solicitanteExtra,
                        passageiroExtraNome,
                        valorNormal_Pn,
                        valorExtra_Pn
                    );
                }
                return [...rowData, ...extraData].map(value => `"${String(value).replace(/"/g, '""')}"`).join(';');
            }).join('\n');

            const csvContent = `${finalHeaders.join(';')}\n${rows}`;
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `lancamentos_simples_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- LÓGICA DO MODAL DE LANÇAMENTOS ---
        function formatMultipleValues(principal, extras, isPassageiro = false) {
            let result = principal || '';
            if (extras && extras.length > 0) {
                const extraList = extras.map(e => isPassageiro ? e.nome : e);
                result += ' (' + extraList.join(', ') + ')';
            }
            return result;
        }

        function formatDestinosChegadas(principalDestino, principalChegada, extras) {
            let result = principalDestino || '';
            if (principalChegada) {
                result += ` (${principalChegada})`;
            }

            if (extras && extras.length > 0) {
                const extraList = extras.map(e => `${e.destino || ''}${e.chegada ? ` (${e.chegada})` : ''}`).filter(s => s !== '');
                if (extraList.length > 0) {
                    result += ' (' + extraList.join(', ') + ')';
                }
            }
            return result;
        }

        function calculateTotalValue(lancamento) {
            let total = lancamento.valor || 0;
            if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                lancamento.destinos_extras.forEach(dest => {
                    total += dest.valor || 0;
                });
            }
            return total;
        }

        function calculateTotalExtraValue(lancamento) {
            let total = lancamento.valorExtra || 0;
            if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                lancamento.destinos_extras.forEach(dest => {
                    total += dest.valorExtra || 0;
                });
            }
            return total;
        }

        function renderLancamentosList() {
            const modal = document.getElementById('lancamentos-modal');
            const tableBody = document.querySelector('#lancamentos-table tbody');
            tableBody.innerHTML = '';

            const startDate = modal.querySelector('#filter-start-date').value;
            const endDate = modal.querySelector('#filter-end-date').value;

            let dataToShow = lancamentosData;
            if (!currentUser.isAdmin) {
                dataToShow = lancamentosData.filter(lanc => lanc.createdBy === currentUser.username);
            }

            if (startDate || endDate) {
                dataToShow = dataToShow.filter(item => {
                    if (!item.data) return false;
                    const itemDate = new Date(item.data + "T00:00:00");
                    const start = startDate ? new Date(startDate + "T00:00:00") : null;
                    const end = endDate ? new Date(endDate + "T00:00:00") : null;
                    if (start && itemDate < start) return false;
                    if (end && itemDate > end) return false;
                    return true;
                });
            }

            dataToShow.sort((a, b) => new Date(b.data) - new Date(a.data));
            if (dataToShow.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="14" class="text-center p-4">Nenhum lançamento encontrado.</td></tr>';
                return;
            }

            dataToShow.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';

                const totalValue = calculateTotalValue(item);
                const totalExtraValue = calculateTotalExtraValue(item);

                const transportadoFull = formatMultipleValues(item.transportado, item.passageiros_extras, true);
                const solicitanteFull = formatMultipleValues(item.solicitante, item.solicitantes_extras, false);
                const destinoFull = formatDestinosChegadas(item.destino, item.chegada_destino, item.destinos_extras);
                const statusText = item.editedBy ? `<span class="text-xs text-gray-500">Editado por ${item.editedBy}</span>` : '';

                row.innerHTML = `
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 hidden">${item.id || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.data || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.motorista || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.bordero || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${solicitanteFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transportadoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.origem || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${destinoFull}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.partida || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">R$ ${totalExtraValue.toFixed(2).replace('.', ',')}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.observacao || ''}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${statusText}</td>
                   <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 flex gap-2">
                        <button data-id="${item.id}" class="edit-lancamento-btn text-blue-600 hover:text-blue-900" title="Editar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        </button>
                        <button data-id="${item.id}" class="delete-lancamento-btn text-red-600 hover:text-red-900" title="Excluir">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        document.getElementById('open-lancamentos-modal').addEventListener('click', () => {
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            renderLancamentosList();
            document.getElementById('lancamentos-modal').classList.remove('hidden');
        });
        document.getElementById('close-lancamentos-modal').addEventListener('click', () => {
            document.getElementById('lancamentos-modal').classList.add('hidden');
        });
        document.getElementById('filter-lancamentos-btn').addEventListener('click', renderLancamentosList);


        document.getElementById('lancamentos-table').addEventListener('click', async function (event) {
            const editButton = event.target.closest('.edit-lancamento-btn');
            if (editButton) {
                const lancamentoId = editButton.dataset.id;
                openEditLancamentoModal(lancamentoId);
            }

            const deleteButton = event.target.closest('.delete-lancamento-btn');
            if (deleteButton) {
                const lancamentoId = deleteButton.dataset.id;
                if (confirm('Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.')) {
                    try {
                        const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', lancamentoId);
                        await deleteDoc(docRef);
                        showWarning('Lançamento excluído com sucesso!');
                        renderLancamentosList();
                    } catch (error) {
                        console.error("Erro ao excluir lançamento:", error);
                        showWarning('Ocorreu um erro ao excluir o lançamento.');
                    }
                }
            }
        });
        
        // --- LÓGICA DO MODAL DE EDIÇÃO (a maior parte permanece a mesma) ---
        // Funções: updateEditDynamicLabels, createEditDynamicInput, createEditDestinoChegadaInput, etc...
        // ... (todo o bloco de código do modal de edição pode ser mantido como está)
        // O restante do seu JS, do modal de edição em diante, pode ser colado aqui.
        // As únicas funções que mudam são as que lidam com 'motoristas', agora 'users'.

        // --- Lógica Solicitante/Destino Dinâmico (Modal de Edição) ---

        function updateEditDynamicLabels(containerId, inputName, baseLabel) {
            const rows = document.querySelectorAll(`#${containerId} .edit-dynamic-row`);
            rows.forEach((row, index) => {
                const pNum = index + 1;
                const label = row.querySelector('label');
                const input = row.querySelector('input');

                if (label) {
                    label.textContent = `${baseLabel} (P${pNum}):`;
                }
                
                if (containerId === 'edit-solicitante-campos-container' && index === 0 && input) {
                    input.id = 'edit-solicitante-p1';
                }

                if (containerId === 'edit-destino-campos-container') {
                    const destinoLabel = row.querySelector('label[for^="edit-destino-"]');
                    const chegadaLabel = row.querySelector('label[for^="edit-chegada-destino-"]');
                    const destinoInput = row.querySelector('input[name="edit-destinos[]"]');
                    if (destinoLabel) destinoLabel.textContent = `Destino (P${pNum}):`;
                    if (chegadaLabel) chegadaLabel.textContent = `Chegada (P${pNum}):`;
                    if (index === 0) {
                        if (destinoInput) destinoInput.id = 'edit-destino-p1';
                    }
                }

                if (containerId === 'edit-valor-campos-container') {

                    const labelValor = row.querySelector('label[for^="edit-valor"]:not([for*="extra"])');
                    const labelValorExtra = row.querySelector('label[for*="extra"]');
                    const inputValor = row.querySelector('input[name="edit-valores[]"]');
                    const inputValorExtra = row.querySelector('input[name="edit-valores_extra[]"]');                    
                    if (labelValor) labelValor.textContent = pNum === 1 ?
                        'Valor P1:' : `Valor P${pNum}:`;
                    if (labelValorExtra) labelValorExtra.textContent = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;                   
                    if (inputValor) inputValor.id = pNum === 1 ?
                        'edit-valor' : `edit-valor-${pNum}`;
                    if (inputValorExtra) inputValorExtra.id = pNum === 1 ? 'edit-valor-extra' : `edit-valor-extra-${pNum}`;
                    if (inputValor) formatCurrencyInput(inputValor);
                    if (inputValorExtra) formatCurrencyInput(inputValorExtra);
                }

                const removeBtn = row.querySelector('.remove-edit-dynamic-btn');
                if (removeBtn) {
                    if (index === 0) {
                        removeBtn.classList.add('hidden');
                    } else {
                        removeBtn.classList.remove('hidden');
                        removeBtn.onclick = () => {
                            row.remove();
                            updateEditDynamicLabels(containerId, inputName, baseLabel);
                            if (containerId === 'edit-destino-campos-container') {
                                removeEditValueRow(pNum);
                            }
                        };
                    }
                }
            });
        }

        function createEditDynamicInput(containerId, inputName, baseLabel, value = '') {
            const fieldset = document.createElement('div');
            fieldset.className = 'edit-dynamic-row form-row-align';

            const index = Date.now();
            const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
            const isP1 = pNum === 1;

            fieldset.innerHTML = `
                <div class="flex-grow">
                    <label for="edit-${inputName}-${index}" class="block text-sm font-medium text-gray-700">${baseLabel} (P${pNum}):</label>
                    <input type="text" id="edit-${inputName}-${index}" name="edit-${inputName}s[]" value="${value}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                    -
                </button>
            `;
            if (!isP1) {
                const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateEditDynamicLabels(containerId, inputName, baseLabel);
                };
            }
            return fieldset;
        }

        function createEditDestinoChegadaInput(destinoValue = '', chegadaValue = '') {
            const containerId = 'edit-destino-campos-container';
            const fieldset = document.createElement('div');
            fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4';
            const index = Date.now();
            const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
            const isP1 = pNum === 1;
            fieldset.innerHTML = `
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-destino-${index}" class="block text-sm font-medium text-gray-700">Destino (P${pNum}):</label>
                        <input type="text" id="edit-destino-${index}" name="edit-destinos[]" value="${destinoValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-dynamic-btn ${isP1 ? 'hidden' : ''}">
                        -
                    </button>
                </div>
                <div class="form-row-align">
                    <div class="flex-grow">
                        <label for="edit-chegada-destino-${index}" class="block text-sm font-medium text-gray-700">Chegada (P${pNum}):</label>
                        <input type="time" id="edit-chegada-destino-${index}" name="edit-chegadas_destino[]" value="${chegadaValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                </div>
            `;
            if (!isP1) {
                const removeBtn = fieldset.querySelector('.remove-edit-dynamic-btn');
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateEditDynamicLabels(containerId, 'destino', 'Destino');
                    removeEditValueRow(pNum);
                };
            }
            return fieldset;
        }


        function createEditValorInput(pNum, valorValue = '0,00', valorExtraValue = '0,00') {
            const fieldset = document.createElement('div');
            fieldset.className = 'edit-dynamic-row grid grid-cols-2 gap-4 valor-row';
            fieldset.dataset.pNum = pNum;

            const labelValor = pNum === 1 ? 'Valor P1:' : `Valor P${pNum}:`;
            const labelValorExtra = pNum === 1 ? 'Valor Extra P1:' : `Valor Extra P${pNum}:`;
            const inputIdValor = pNum === 1 ? 'edit-valor' : `edit-valor-${pNum}`;
            const inputIdValorExtra = pNum === 1 ? 'edit-valor-extra' : `edit-valor-extra-${pNum}`;
            fieldset.innerHTML = `
                <div>
                    <label for="${inputIdValor}" class="block text-sm font-medium text-gray-700">${labelValor}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValor}" name="edit-valores[]" value="${valorValue}"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg text-right">
                    </div>
                </div>
                <div>
                    <label for="${inputIdValorExtra}" class="block text-sm font-medium text-gray-700">${labelValorExtra}</label>
                    <div class="relative mt-1">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 pr-2 text-gray-400">R$</span>
                        <input type="text" id="${inputIdValorExtra}" name="edit-valores_extra[]" value="${valorExtraValue}"
                            class="block w-full px-3 py-2 pl-9 bg-gray-50 border border-gray-300 rounded-lg text-right">
                    </div>
                </div>
            `;
            const valorInput = fieldset.querySelector('input[name="edit-valores[]"]');
            const valorExtraInput = fieldset.querySelector('input[name="edit-valores_extra[]"]');
            if (valorInput) {
                valorInput.addEventListener('input', () => formatCurrencyInput(valorInput));
                valorInput.addEventListener('blur', () => { if (valorInput.value === '') valorInput.value = '0,00'; });
            }
            if (valorExtraInput) {
                valorExtraInput.addEventListener('input', () => formatCurrencyInput(valorExtraInput));
                valorExtraInput.addEventListener('blur', () => { if (valorExtraInput.value === '') valorExtraInput.value = '0,00'; });
            }
            return fieldset;
        }

        function removeEditValueRow(pNumToRemove) {
            const rowToRemove = document.querySelector(`#edit-valor-campos-container .valor-row[data-p-num="${pNumToRemove}"]`);
            if (rowToRemove) {
                rowToRemove.remove();
                updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');
            }
        }

        function addEditDynamicRow(containerId, inputName, baseLabel, value = '', value2 = null, value3 = 0, value4 = 0) {
            const container = document.getElementById(containerId);
            let newRow;
            if (inputName === 'destino') {
                newRow = createEditDestinoChegadaInput(value, value2);
            } else if (inputName === 'solicitante') {
                newRow = createEditDynamicInput(containerId, inputName, baseLabel, value);
            } else if (inputName === 'valor') {
                const pNum = document.querySelectorAll(`#${containerId} .edit-dynamic-row`).length + 1;
                const valorFmt = (value || 0).toFixed(2).replace('.', ',');
                const valorExtraFmt = (value2 || 0).toFixed(2).replace('.', ',');
                newRow = createEditValorInput(pNum, valorFmt, valorExtraFmt);
            }

            if (newRow) {
                container.appendChild(newRow);
                updateEditDynamicLabels(containerId, inputName, baseLabel);
            }
        }

        document.getElementById('add-edit-solicitante-btn').addEventListener('click', () => addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante'));
        document.getElementById('add-edit-destino-btn').addEventListener('click', () => addEditDynamicRow('edit-destino-campos-container', 'destino', 'Destino', '', ''));
        document.getElementById('add-edit-valor-btn').addEventListener('click', () => addEditDynamicRow('edit-valor-campos-container', 'valor', 'Valor', 0, 0));
        
        function updateEditPassageiroLabels() {
            const container = document.getElementById('edit-passageiros-extras-container');
            const p1REInput = document.getElementById('edit-re');
            const p1NomeInput = document.getElementById('edit-transportado');
            const p1RELabel = p1REInput.previousElementSibling;
            const p1NomeLabel = p1NomeInput.previousElementSibling;
            if (p1RELabel) p1RELabel.textContent = `RE (P1):`;
            if (p1NomeLabel) p1NomeLabel.textContent = `Transportado (P1):`;

            const extraRows = container.querySelectorAll('.edit-passageiro-row');
            extraRows.forEach((row, index) => {
                const pNum = index + 2;
                const reLabel = row.querySelector('label');
                const transportadoLabel = row.querySelector('.flex-grow label');
                const removeBtn = row.querySelector('.remove-edit-passageiro-btn');
                if (reLabel) reLabel.textContent = `RE (P${pNum}):`;
                if (transportadoLabel) transportadoLabel.textContent = `Transportado (P${pNum}):`;
                if (removeBtn) removeBtn.dataset.pNum = pNum;
            });
        }

        function createEditPassageiroInput(pNum, reValue = '', nomeValue = '') {
            const fieldset = document.createElement('div');
            fieldset.className = 'edit-passageiro-row grid grid-cols-1 md:grid-cols-2 gap-4';
            fieldset.dataset.pNum = pNum;
            const isP1 = pNum === 1;
            fieldset.innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700">RE (P${pNum}):</label>
                    <input type="text" name="edit-res[]" list="transportados-re-list" value="${reValue}"
                        class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-end">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">Transportado (P${pNum}):</label>
                        <input type="text" name="edit-transportados[]" list="transportados-nome-list" value="${nomeValue}"
                            class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg">
                    </div>
                    <button type="button" class="ml-2 px-3 py-2 bg-gray-300 text-gray-800 font-bold rounded-lg shadow-md hover:bg-gray-400 remove-edit-passageiro-btn ${isP1 ? 'hidden' : ''}" data-p-num="${pNum}">-</button>
                </div>
            `;
            const reInput = fieldset.querySelector('input[name="edit-res[]"]');
            const nomeInput = fieldset.querySelector('input[name="edit-transportados[]"]');
            if (reInput && nomeInput) {
                reInput.addEventListener('blur', () => handleAutofillDynamic(reInput, nomeInput, 're'));
                nomeInput.addEventListener('blur', () => handleAutofillDynamic(nomeInput, reInput, 'nome'));
            }
            const removeBtn = fieldset.querySelector('.remove-edit-passageiro-btn');
            if (removeBtn) {
                removeBtn.onclick = () => {
                    fieldset.remove();
                    updateEditPassageiroLabels();
		    checkEditPassageiroDuplicidade();
                };
            }
            return fieldset;
        }


        function addEditPassageiroRow(re = '', nome = '') {
            const extrasContainer = document.getElementById('edit-passageiros-extras-container');
            const currentRows = extrasContainer.querySelectorAll('.edit-passageiro-row').length;
            const pNum = currentRows + 2;
            const newRow = createEditPassageiroInput(pNum, re, nome);
            extrasContainer.appendChild(newRow);
            updateEditPassageiroLabels();
        }

        document.getElementById('add-edit-passageiro-btn').addEventListener('click', () => addEditPassageiroRow());
        
        function openEditLancamentoModal(id) {
            const lancamento = lancamentosData.find(l => l.id === id);
            if (!lancamento) return;

            document.getElementById('edit-lancamento-id').value = id;
            document.getElementById('edit-data').value = lancamento.data;
            document.getElementById('edit-bordero').value = lancamento.bordero || '';
            document.getElementById('edit-origem').value = lancamento.origem;
            document.getElementById('edit-observacao').value = lancamento.observacao || '';
            document.getElementById('edit-partida').value = lancamento.partida || '';

            const motoristaInput = document.getElementById('edit-motorista');
            motoristaInput.value = lancamento.motorista;
            if (!currentUser.isAdmin) {
                motoristaInput.setAttribute('readonly', 'readonly');
                motoristaInput.classList.add('bg-gray-200');
            } else {
                motoristaInput.removeAttribute('readonly');
                motoristaInput.classList.remove('bg-gray-200');
            }

            const editSolicitanteContainer = document.getElementById('edit-solicitante-campos-container');
            editSolicitanteContainer.innerHTML = '';
            addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante', lancamento.solicitante || '');
            if (lancamento.solicitantes_extras && lancamento.solicitantes_extras.length > 0) {
                lancamento.solicitantes_extras.forEach((s) => {
                    addEditDynamicRow('edit-solicitante-campos-container', 'solicitante', 'Solicitante', s);
                });
            }
            updateEditDynamicLabels('edit-solicitante-campos-container', 'solicitante', 'Solicitante');

            const editDestinoContainer = document.getElementById('edit-destino-campos-container');
            editDestinoContainer.innerHTML = '';
            const destinosParaEdicao = [{ destino: lancamento.destino || '', chegada: lancamento.chegada_destino || '' }];
            if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                lancamento.destinos_extras.forEach(d => destinosParaEdicao.push({ destino: d.destino || '', chegada: d.chegada || '' }));
            }
            destinosParaEdicao.forEach(d => {
                addEditDynamicRow('edit-destino-campos-container', 'destino', 'Destino', d.destino, d.chegada);
            });

            const editValorContainer = document.getElementById('edit-valor-campos-container');
            editValorContainer.innerHTML = '';
            const valoresParaEdicao = [{ valor: lancamento.valor || 0, valorExtra: lancamento.valorExtra || 0 }];
            if (lancamento.destinos_extras && lancamento.destinos_extras.length > 0) {
                lancamento.destinos_extras.forEach(d => valoresParaEdicao.push({ valor: d.valor || 0, valorExtra: d.valorExtra || 0 }));
            }
            valoresParaEdicao.forEach((v, index) => {
                const pNum = index + 1;
                const valorFmt = (v.valor || 0).toFixed(2).replace('.', ',');
                const valorExtraFmt = (v.valorExtra || 0).toFixed(2).replace('.', ',');
                const newRow = createEditValorInput(pNum, valorFmt, valorExtraFmt);
                editValorContainer.appendChild(newRow);
            });
            updateEditDynamicLabels('edit-valor-campos-container', 'valor', 'Valor');

            document.getElementById('edit-re').value = lancamento.re || '';
            document.getElementById('edit-transportado').value = lancamento.transportado || '';
            const extrasContainer = document.getElementById('edit-passageiros-extras-container');
            extrasContainer.innerHTML = '';
            if (lancamento.passageiros_extras && lancamento.passageiros_extras.length > 0) {
                lancamento.passageiros_extras.forEach((p) => {
                    addEditPassageiroRow(p.re, p.nome);
                });
            }
            updateEditPassageiroLabels();
            document.getElementById('edit-lancamento-modal').classList.remove('hidden');
        }

        function setupEditModalAutofill() {
            const modal = document.getElementById('edit-lancamento-modal');
            modal.addEventListener('blur', (event) => {
                const input = event.target;
                
                const isPassengerField = input.id === 'edit-re' || input.id === 'edit-transportado' ||
                    input.matches('input[name="edit-res[]"]') || input.matches('input[name="edit-transportados[]"]');

                if (isPassengerField) {
                    let reInput, nomeInput;
                    
                    if (input.id === 'edit-re' || input.id === 'edit-transportado') {
                        reInput = document.getElementById('edit-re');
                        nomeInput = document.getElementById('edit-transportado');
                    } else {
                        const row = input.closest('.edit-passageiro-row');
                        reInput = row.querySelector('input[name="edit-res[]"]');
                        nomeInput = row.querySelector('input[name="edit-transportados[]"]');
                    }
                    
                    if (reInput && nomeInput) {
                         if (input === reInput) {
                            handleAutofillDynamic(reInput, nomeInput, 're');
                        } else if (input === nomeInput) {
                            handleAutofillDynamic(nomeInput, reInput, 'nome');
                        }
                    }

                    setTimeout(() => checkEditPassageiroDuplicidade(), 50);
                }
            }, true);
        }
        setupEditModalAutofill();

        document.getElementById('close-edit-lancamento-modal').addEventListener('click', () => {
            document.getElementById('edit-lancamento-modal').classList.add('hidden');
        });
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            document.getElementById('edit-lancamento-modal').classList.add('hidden');
        });
        document.getElementById('edit-lancamento-form').addEventListener('submit', async function (event) {
            event.preventDefault();

            if (checkEditPassageiroDuplicidade()) {
                showWarning('Corrija os passageiros duplicados antes de salvar.');
                return;
            }
            const id = document.getElementById('edit-lancamento-id').value;
            const solicitantesEdit = Array.from(document.querySelectorAll('#edit-solicitante-campos-container input[name="edit-solicitantes[]"]'))
                .map(input => input.value.trim()).filter(value => value !== '');
            if (solicitantesEdit.length === 0) {
                showWarning('O solicitante principal (P1) deve estar preenchido.');
                return;
            }
            const p1RE = document.getElementById('edit-re').value.trim();
            const p1Nome = document.getElementById('edit-transportado').value.trim();
            if (!p1RE || !p1Nome) {
                showWarning('O passageiro principal (P1) deve ter RE e nome preenchidos.');
                return;
            }
            const resExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-res[]"]')).map(input => input.value.trim());
            const nomesExtras = Array.from(document.querySelectorAll('#edit-passageiros-extras-container input[name="edit-transportados[]"]')).map(input => input.value.trim());
            const passageirosExtras = resExtras.map((re, i) => ({ re: re, nome: nomesExtras[i] })).filter(p => p.re && p.nome);
            const destinosInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-destinos[]"]');
            const chegadasInputs = document.querySelectorAll('#edit-destino-campos-container input[name="edit-chegadas_destino[]"]');
            const valoresInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores[]"]');
            const valoresExtraInputs = document.querySelectorAll('#edit-valor-campos-container input[name="edit-valores_extra[]"]');
            const destinosArray = [];
            let destinoIncompleto = false;
            destinosInputs.forEach((destinoInput, i) => {
                const destino = destinoInput.value.trim();
                const chegada = chegadasInputs[i] ? chegadasInputs[i].value.trim() : '';
                if ((destino && !chegada) || (!destino && chegada)) {
                    destinoIncompleto = true;
                }
                destinosArray.push({ destino, chegada });
            });
            if (destinoIncompleto) {
                showWarning('Preencha os campos de Destino e Chegada (Horário) ou deixe ambos vazios.');
                return;
            }
            if (!destinosArray[0] || !destinosArray[0].destino || !destinosArray[0].chegada) {
                showWarning('O destino principal (P1) e sua chegada devem estar preenchidos.');
                return;
            }
            const valoresArray = [];
            valoresInputs.forEach((valorInput, i) => {
                const valor = parseCurrencyValue(valorInput.value);
                const valorExtra = valoresExtraInputs[i] ? parseCurrencyValue(valoresExtraInputs[i].value) : 0;
                valoresArray.push({ valor, valorExtra });
            });

            const updatedData = {
                motorista: document.getElementById('edit-motorista').value,
                data: document.getElementById('edit-data').value,
                bordero: document.getElementById('edit-bordero').value.trim(),
                partida: document.getElementById('edit-partida').value,
                origem: document.getElementById('edit-origem').value,
                observacao: document.getElementById('edit-observacao').value,
                editedBy: currentUser.username,
                editedAt: serverTimestamp(),
                solicitante: solicitantesEdit[0],
                re: p1RE,
                transportado: p1Nome,
                destino: destinosArray[0].destino,
                chegada_destino: destinosArray[0].chegada,
                valor: valoresArray[0] ? valoresArray[0].valor : 0,
                valorExtra: valoresArray[0] ? valoresArray[0].valorExtra : 0,
                solicitantes_extras: solicitantesEdit.slice(1),
                passageiros_extras: passageirosExtras,
                destinos_extras: [],
            };

            const totalExtras = Math.max(destinosArray.length, valoresArray.length) - 1;
            if (totalExtras > 0) {
                for (let i = 1; i <= totalExtras; i++) {
                    const destinoInfo = destinosArray[i] || { destino: '', chegada: '' };
                    const valorInfo = valoresArray[i] || { valor: 0, valorExtra: 0 };
                    if (destinoInfo.destino || valorInfo.valor > 0 || valorInfo.valorExtra > 0) {
                        updatedData.destinos_extras.push({
                            destino: destinoInfo.destino,
                            chegada: destinoInfo.chegada,
                            valor: valorInfo.valor,
                            valorExtra: valorInfo.valorExtra
                        });
                    }
                }
            }

            const docRef = doc(db, 'artifacts', globalAppId, 'public', 'data', 'lancamentos', id);
            await updateDoc(docRef, updatedData);
            showWarning('Lançamento atualizado com sucesso!');
            document.getElementById('edit-lancamento-modal').classList.add('hidden');
            renderLancamentosList();
        });

        function renderTransportadosList() {
            const tableBody = document.querySelector('#transportados-table tbody');
            tableBody.innerHTML = '';
            transportadosData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" data-id="${item.id}" class="transportado-checkbox rounded-sm"></td>
                    <td class="px-6 py-4">${item.re}</td>
                    <td class="px-6 py-4">${item.nome}</td>
                `;
                tableBody.appendChild(row);
            });
            populateTransportadosDatalist();
        }

        // ATUALIZADO para usar 'usersData'
// ATUALIZADO para usar 'usersData' e adicionar botão de redefinir senha
        function renderMotoristasList() {
            const tableBody = document.querySelector('#motoristas-table tbody');
            const tableHead = document.querySelector('#motoristas-table thead tr');

            // Adiciona o cabeçalho "Ações" se ainda não existir
            if (!tableHead.querySelector('.th-actions')) {
                tableHead.innerHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider th-actions">Ações</th>`;
            }

            tableBody.innerHTML = '';
            usersData.forEach(item => {
                // Não mostra o botão para o próprio admin logado
                const disableButton = item.username === currentUser.username;
                const buttonHtml = disableButton ? 
                    `<span class="text-gray-400 text-sm">Próprio Usuário</span>` : 
                    `<button data-id="${item.id}" data-username="${item.username}" class="reset-password-btn text-yellow-600 hover:text-yellow-900 font-semibold">Redefinir Senha</button>`;

                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" data-id="${item.id}" class="motorista-checkbox rounded-sm"></td>
                    <td class="px-6 py-4">${item.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${buttonHtml}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateTransportadosDatalist() {
            const reDatalist = document.querySelector('#transportados-re-list') || document.createElement('datalist');
            reDatalist.id = 'transportados-re-list';
            const nomeDatalist = document.querySelector('#transportados-nome-list') || document.createElement('datalist');
            nomeDatalist.id = 'transportados-nome-list';
            if (!document.body.contains(reDatalist)) document.body.appendChild(reDatalist);
            if (!document.body.contains(nomeDatalist)) document.body.appendChild(nomeDatalist);
            reDatalist.innerHTML = '';
            nomeDatalist.innerHTML = '';
            transportadosData.forEach(item => {
                reDatalist.innerHTML += `<option value="${item.re}">`;
                nomeDatalist.innerHTML += `<option value="${item.nome}">`;
            });
        }

        // ATUALIZADO para usar 'usersData'
        function populateMotoristasDatalist() {
            const datalist = document.getElementById('motoristas-list');
            datalist.innerHTML = '';
            usersData.forEach(item => datalist.innerHTML += `<option value="${item.nome}">`);
        }

        document.getElementById('add-transportado').addEventListener('click', async () => {
            const newRE = document.getElementById('new-re').value.trim();
            const newNome = document.getElementById('new-nome').value.trim();
            if (newRE && newNome) {
                const existing = transportadosData.find(item => item.re === newRE || item.nome.toLowerCase() === newNome.toLowerCase());
                if (existing) {
                    showWarning('RE ou nome já existe.');
                } else {
                    await addDoc(collection(db, 'artifacts', globalAppId, 'public', 'data', 'transportados'), { re: newRE, nome: newNome });
                    document.getElementById('new-re').value = '';
                    document.getElementById('new-nome').value = '';
                    showWarning('Transportado adicionado.');
                }
            } else {
                showWarning('Preencha RE e nome.');
            }
        });
        document.getElementById('delete-selected-transportados').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#transportados-table .transportado-checkbox:checked');
            if (checkboxes.length === 0) {
                showWarning('Selecione ao menos um transportado.');
                return;
            }
            const promises = Array.from(checkboxes).map(cb =>
                deleteDoc(doc(db, 'artifacts', globalAppId, 'public', 'data', 'transportados', cb.dataset.id)));
            await Promise.all(promises);
            showWarning(`${checkboxes.length} transportados excluídos.`);
        });
        
        // LÓGICA DE ADICIONAR MOTORISTA ATUALIZADA
        document.getElementById('add-motorista').addEventListener('click', async () => {
            const nome = document.getElementById('new-motorista-nome').value.trim();
            const username = document.getElementById('new-motorista-username').value.trim().toLowerCase();
            const password = document.getElementById('new-motorista-password').value.trim();
            const isAdmin = document.getElementById('new-motorista-is-admin').checked;

            if (nome && username && password) {
                 const existingUser = usersData.find(user => user.username === username);
                 if (existingUser) {
                     showWarning('Este nome de usuário já existe.');
                     return;
                 }
                
                const newUser = {
                    nome: nome,
                    username: username,
                    password: password, // Lembre-se do aviso de segurança!
                    is_admin: isAdmin,
                    is_motorista_fixo: true 
                };
                
                await addDoc(collection(db, 'users'), newUser);

                document.getElementById('new-motorista-nome').value = '';
                document.getElementById('new-motorista-username').value = '';
                document.getElementById('new-motorista-password').value = '';
                document.getElementById('new-motorista-is-admin').checked = false;

                showWarning('Novo usuário/motorista adicionado com sucesso!');
            } else {
                showWarning('Preencha todos os campos: Nome, Usuário e Senha.');
            }
        });

        // LÓGICA DE EXCLUIR MOTORISTA ATUALIZADA
        document.getElementById('delete-selected-motoristas').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('#motoristas-table .motorista-checkbox:checked');
            if (checkboxes.length === 0) {
                showWarning('Selecione ao menos um motorista.');
                return;
            }
            // Usa a coleção 'users'
            const promises = Array.from(checkboxes).map(cb => deleteDoc(doc(db, 'users', cb.dataset.id)));
            await Promise.all(promises);
            showWarning(`${checkboxes.length} usuários/motoristas excluídos.`);
        });

        // --- Eventos de UI restantes ---
        document.getElementById('close-modal').addEventListener('click', hideWarning);
        document.getElementById('open-transportados-modal').addEventListener('click', () => document.getElementById('transportados-modal').classList.remove('hidden'));
        document.getElementById('close-transportados-modal').addEventListener('click', () => document.getElementById('transportados-modal').classList.add('hidden'));
        document.getElementById('open-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.remove('hidden'));
        document.getElementById('close-motoristas-modal').addEventListener('click', () => document.getElementById('motoristas-modal').classList.add('hidden'));
        document.getElementById('sort-transportados-key').addEventListener('change', function () {
            rebuildTransportadosLookups(this.value, document.getElementById('sort-transportados-order').value);
        });
        document.getElementById('sort-transportados-order').addEventListener('change', function () {
            rebuildTransportadosLookups(document.getElementById('sort-transportados-key').value, this.value);
        });
        document.getElementById('sort-motoristas-order').addEventListener('change', function () {
            rebuildMotoristasLookups(this.value);
        });
    </script>
</body>

</html>
